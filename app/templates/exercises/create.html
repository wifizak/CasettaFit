{% extends "base.html" %}
{% block title %}{{ 'Edit' if exercise else 'Create' }} Exercise - CasettaFit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('exercises.index') }}">Exercises</a></li>
                <li class="breadcrumb-item active">{{ 'Edit' if exercise else 'Create' }}</li>
            </ol>
        </nav>
        <h2 class="mb-4">{{ 'Edit Exercise' if exercise else 'Create New Exercise' }}</h2>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" id="exerciseForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        {{ form.name.label(class="form-label") }}
                        {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                        {% if form.name.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.name.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <small class="text-body-secondary">Required</small>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", rows=3) }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.video_url.label(class="form-label") }}
                        {{ form.video_url(class="form-control") }}
                        <small class="text-body-secondary">YouTube or instructional video URL</small>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.category.label(class="form-label") }}
                        {{ form.category(class="form-select" + (" is-invalid" if form.category.errors else "")) }}
                        {% if form.category.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.category.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <small class="text-body-secondary">Required</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.primary_muscle.label(class="form-label") }}
                            {{ form.primary_muscle(class="form-select") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.secondary_muscles.label(class="form-label") }}
                            <input type="text" class="form-control" id="secondary_muscles_typing" autocomplete="off" placeholder="e.g., Triceps, Front Delts">
                            {{ form.secondary_muscles(class="form-control d-none", id="secondary_muscles_input") }}
                            <datalist id="musclesSuggestions"></datalist>
                            <div id="muscleTagsContainer" class="mt-2"></div>
                            <small class="text-body-secondary">Type and select from suggestions, press comma or Enter to add</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.difficulty_level.label(class="form-label") }}
                        {{ form.difficulty_level(class="form-select") }}
                    </div>
                    
                    {% if exercise %}
                    <!-- Tier Selection (only on edit) -->
                    <div class="mb-3">
                        <label class="form-label">Your Tier Rating</label>
                        <select class="form-select" id="tierSelect" style="max-width: 200px;">
                            <option value="" {% if not user_tier %}selected{% endif %}>No tier</option>
                            <option value="S" {% if user_tier == 'S' %}selected{% endif %}>S - Exceptional</option>
                            <option value="A" {% if user_tier == 'A' %}selected{% endif %}>A - Excellent</option>
                            <option value="B" {% if user_tier == 'B' %}selected{% endif %}>B - Good</option>
                            <option value="C" {% if user_tier == 'C' %}selected{% endif %}>C - Average</option>
                            <option value="D" {% if user_tier == 'D' %}selected{% endif %}>D - Below Average</option>
                            <option value="F" {% if user_tier == 'F' %}selected{% endif %}>F - Poor</option>
                        </select>
                        <small class="text-body-secondary">Your personal rating for this exercise</small>
                    </div>
                    {% endif %}
                    
                    <!-- Equipment Section -->
                    <div class="mb-3">
                        <label class="form-label">Equipment Required</label>
                        <button type="button" class="btn btn-outline-primary btn-sm d-block" onclick="openEquipmentModal()">
                            <i class="bi bi-plus-circle"></i> Add Equipment
                        </button>
                        <small class="text-body-secondary">Add all equipment options for this exercise. The same exercise can use different equipment from different gyms (e.g., Barbell from multiple locations).</small>
                        <div id="selectedEquipment" class="mt-2"></div>
                        <!-- Hidden inputs will be added here by JavaScript -->
                    </div>
                    
                    <!-- Gym Assignment (optional - overrides auto-assignment) -->
                    <div class="mb-3">
                        <label class="form-label">Available at Gyms</label>
                        {% if gyms %}
                        <div class="form-check">
                            {% for gym in gyms %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="gym_ids[]" value="{{ gym.id }}" id="gym_{{ gym.id }}"
                                    {% if exercise and gym.id in current_gym_ids %}checked{% endif %}>
                                <label class="form-check-label" for="gym_{{ gym.id }}">
                                    {{ gym.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <small class="text-body-secondary">
                            <strong>Optional:</strong> Manually select gyms where this exercise can be performed. 
                            If left blank, the exercise will automatically be available at gyms that have <em>all</em> the required equipment. 
                            Use this to override auto-associations if the exercise can be done at specific gyms even without all equipment, 
                            or to associate with multiple gyms that have different equipment variations.
                        </small>
                        {% else %}
                        <p class="text-muted">No gyms found. <a href="{{ url_for('gym.create') }}">Create a gym first</a>.</p>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex gap-2">
                        {{ form.submit(class="btn btn-primary") }}
                        <a href="{{ url_for('exercises.index') }}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Equipment Modal -->
<div class="modal fade" id="equipmentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Equipment</h5>
                <button type="button" class="btn-close" onclick="closeEquipmentModal()"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" id="equipmentSearch" class="form-control" placeholder="Search equipment...">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Equipment</th>
                                <th>Type</th>
                                <th>Available at Gyms</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="equipmentTableBody">
                            {% for equip in equipment_list %}
                            <tr class="equipment-row" data-id="{{ equip.id }}" data-name="{{ equip.name }}" data-type="{{ equip.equipment_type }}">
                                <td>{{ equip.name }}</td>
                                <td><span class="badge bg-secondary">{{ equip.equipment_type }}</span></td>
                                <td>
                                    {% set gym_list = gym_equipment_map.get(equip.id, []) %}
                                    {% if gym_list %}
                                        {% for gym in gym_list[:2] %}
                                            <span class="badge bg-info">{{ gym.gym_name }}</span>
                                        {% endfor %}
                                        {% if gym_list|length > 2 %}
                                            <span class="badge bg-secondary">+{{ gym_list|length - 2 }} more</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-body-secondary small">Not in any gym</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary add-equipment" 
                                            data-id="{{ equip.id }}" 
                                            data-name="{{ equip.name }}"
                                            data-variations="{{ equip.variations|length }}">
                                        <i class="bi bi-plus"></i> Add
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEquipmentModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Store equipment variations data in a script tag for JavaScript access -->
<script type="application/json" id="equipmentVariationsData">
{
    {% for equip in equipment_list %}
    "{{ equip.id }}": [
        {% for v in equip.variations %}
        {
            "id": {{ v.id }},
            "name": {{ v.name|tojson }},
            "options": {{ v.options|from_json|tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endfor %}
}
</script>

<script>
function openEquipmentModal() {
    const modal = document.getElementById('equipmentModal');
    modal.classList.add('show');
    modal.style.display = 'block';
    document.body.classList.add('modal-open');
    
    // Add backdrop
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.id = 'modalBackdrop';
    document.body.appendChild(backdrop);
}

function closeEquipmentModal() {
    const modal = document.getElementById('equipmentModal');
    modal.classList.remove('show');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    
    // Remove backdrop
    const backdrop = document.getElementById('modalBackdrop');
    if (backdrop) backdrop.remove();
}

// Equipment selection state (global scope for onclick handlers)
let selectedEquipmentIds = new Set();
let selectedEquipmentData = {}; // Store equipment with their variations

// Equipment variation functions (global scope)
function confirmVariations(equipId, equipName) {
    const selector = document.getElementById('variationSelector');
    const selects = selector.querySelectorAll('select');
    const variations = {};
    
    // Collect all variation selections
    selects.forEach(select => {
        if (select.value) {
            variations[select.dataset.variationId] = {
                name: select.dataset.variationName,
                option: select.value
            };
        }
    });
    
    selectedEquipmentIds.add(equipId);
    selectedEquipmentData[equipId] = { name: equipName, variations: variations };
    addEquipmentBadge(equipId, equipName, variations);
    cancelVariations();
}

function cancelVariations() {
    const selector = document.getElementById('variationSelector');
    if (selector) selector.remove();
}

function addEquipmentBadge(equipId, equipName, variations) {
    const container = document.getElementById('selectedEquipment');
    const badge = document.createElement('div');
    badge.className = 'alert alert-info d-flex justify-content-between align-items-start mb-2';
    badge.id = `equip-${equipId}`;
    
    let variationText = '';
    if (Object.keys(variations).length > 0) {
        variationText = '<br><small class="text-muted">' + 
            Object.values(variations).map(v => `${v.name}: ${v.option}`).join(', ') + 
            '</small>';
    }
    
    badge.innerHTML = `
        <div>
            <strong>${equipName}</strong>${variationText}
            <input type="hidden" name="equipment_ids[]" value="${equipId}">
            ${Object.entries(variations).map(([varId, varData]) => 
                `<input type="hidden" name="variations[]" value='${JSON.stringify({
                    equipment_id: equipId,
                    variation_id: parseInt(varId),
                    selected_option: varData.option
                })}'>`
            ).join('')}
        </div>
        <button type="button" class="btn-close" onclick="removeEquipment(${equipId})"></button>
    `;
    
    container.appendChild(badge);
    closeEquipmentModal();
}

function removeEquipment(equipId) {
    selectedEquipmentIds.delete(parseInt(equipId));
    delete selectedEquipmentData[equipId];
    const badge = document.getElementById(`equip-${equipId}`);
    if (badge) badge.remove();
}

// Secondary Muscles - Global variables and functions (for onclick handlers)
let availableMuscles = [];
let selectedMuscles = [];
let isSelectingSuggestion = false;
let musclesInput; // Hidden storage field
let musclesTyping; // Visible typing field

function selectMuscle(muscle) {
    if (!musclesTyping) return; // Guard against early calls
    isSelectingSuggestion = true;
    addMuscle(muscle);
    musclesTyping.value = '';
    musclesTyping.focus();
    hideMuscleSuggestions();
}

function addMuscle(muscle) {
    muscle = muscle.trim();
    if (muscle && !selectedMuscles.includes(muscle)) {
        selectedMuscles.push(muscle);
        updateMuscleDisplay();
        updateHiddenInput();
    }
}

function removeMuscle(muscle) {
    selectedMuscles = selectedMuscles.filter(m => m !== muscle);
    updateMuscleDisplay();
    updateHiddenInput();
}

function updateMuscleDisplay() {
    const container = document.getElementById('muscleTagsContainer');
    if (!container) return; // Guard against early calls
    container.innerHTML = selectedMuscles.map(muscle =>
        `<span class="badge bg-secondary me-1 mb-1">
            ${muscle}
            <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.6rem; padding: 0;" onclick="removeMuscle('${muscle.replace(/'/g, "\\'")}')"></button>
        </span>`
    ).join('');
}

function updateHiddenInput() {
    if (!musclesInput) return; // Guard against early calls
    const newValue = selectedMuscles.join(', ');
    musclesInput.value = newValue;
    console.log('Updated secondary_muscles field:', newValue, 'selectedMuscles:', selectedMuscles);
}

function showMuscleSuggestions(search, prefix) {
    if (!musclesTyping) return; // Guard against early calls
    const suggestions = availableMuscles.filter(m => 
        m.toLowerCase().includes(search.toLowerCase()) && 
        !selectedMuscles.includes(m)
    ).slice(0, 5);
    
    if (suggestions.length === 0) {
        hideMuscleSuggestions();
        return;
    }
    
    let dropdown = document.getElementById('muscleSuggestionsDropdown');
    if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = 'muscleSuggestionsDropdown';
        dropdown.className = 'list-group position-absolute w-100';
        dropdown.style.zIndex = '1000';
        dropdown.style.maxHeight = '200px';
        dropdown.style.overflowY = 'auto';
        musclesTyping.parentElement.style.position = 'relative';
        musclesTyping.parentElement.appendChild(dropdown);
    }
    
    dropdown.innerHTML = suggestions.map(muscle => 
        `<button type="button" class="list-group-item list-group-item-action" onmousedown="event.preventDefault()" onclick="selectMuscle('${muscle.replace(/'/g, "\\'")}')">
            ${muscle}
        </button>`
    ).join('');
}

function hideMuscleSuggestions() {
    const dropdown = document.getElementById('muscleSuggestionsDropdown');
    if (dropdown) dropdown.remove();
}

// Wrap DOM-dependent code in DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize field references
    musclesInput = document.getElementById('secondary_muscles_input');
    musclesTyping = document.getElementById('secondary_muscles_typing');

    // Fetch available muscle suggestions using shared utility
    apiGet('{{ url_for("exercises.get_secondary_muscles") }}', {
        errorMessage: 'Error loading muscle suggestions'
    })
        .then(data => {
            availableMuscles = data;
        })
        .catch(error => {
            console.error('Error loading muscles:', error);
        });

    // Initialize selected muscles from form value on load
    const initialValue = musclesInput.value.trim();
    if (initialValue) {
        selectedMuscles = initialValue.split(',').map(m => m.trim()).filter(m => m);
        updateMuscleDisplay();
    }

// Handle input with autocomplete on the typing field
musclesTyping.addEventListener('input', function(e) {
    const value = this.value;
    const lastComma = value.lastIndexOf(',');
    const currentWord = lastComma >= 0 ? value.substring(lastComma + 1).trim() : value.trim();
    
    if (currentWord.length > 0) {
        showMuscleSuggestions(currentWord, lastComma >= 0 ? value.substring(0, lastComma + 1) : '');
    } else {
        hideMuscleSuggestions();
    }
});

// Handle comma or Enter to add muscle on typing field
musclesTyping.addEventListener('keydown', function(e) {
    if (e.key === ',' || e.key === 'Enter') {
        e.preventDefault();
        const value = this.value.trim();
        if (value && !value.endsWith(',')) {
            addMuscle(value);
            this.value = '';
            hideMuscleSuggestions();
        }
    }
});

// Handle blur to add remaining text from typing field
musclesTyping.addEventListener('blur', function(e) {
    setTimeout(() => {
        if (isSelectingSuggestion) {
            isSelectingSuggestion = false;
            return;
        }
        const value = this.value.trim();
        if (value) {
            addMuscle(value);
            this.value = '';
        }
        hideMuscleSuggestions();
    }, 200);
});

// Load equipment variations data from JSON script tag
const equipmentVariationsData = JSON.parse(document.getElementById('equipmentVariationsData').textContent);

// Initialize existing equipment IDs on edit
{% if exercise %}
    {% for eq in exercise.equipment %}
        selectedEquipmentIds.add({{ eq.id }});
    {% endfor %}
{% endif %}

// Equipment search functionality
document.getElementById('equipmentSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('.equipment-row').forEach(row => {
        const name = row.dataset.name.toLowerCase();
        const type = row.dataset.type.toLowerCase();
        if (name.includes(searchTerm) || type.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Add equipment handler
document.querySelectorAll('.add-equipment').forEach(btn => {
    btn.addEventListener('click', function() {
        const equipId = parseInt(this.dataset.id);
        const equipName = this.dataset.name;
        const variationsCount = parseInt(this.dataset.variations || 0);
        
        if (!selectedEquipmentIds.has(equipId)) {
            // Get variations data from our loaded JSON
            const variations = equipmentVariationsData[equipId] || [];
            
            // If has variations, show variation selector
            if (variations.length > 0) {
                showVariationSelector(equipId, equipName, variations);
            } else {
                // No variations, just add it
                selectedEquipmentIds.add(equipId);
                selectedEquipmentData[equipId] = { name: equipName, variations: {} };
                addEquipmentBadge(equipId, equipName, {});
            }
        }
    });
});

function showVariationSelector(equipId, equipName, variations) {
    // Create variation selection UI
    const modalBody = document.querySelector('#equipmentModal .modal-body');
    const existingSelector = document.getElementById('variationSelector');
    if (existingSelector) existingSelector.remove();
    
    const selectorDiv = document.createElement('div');
    selectorDiv.id = 'variationSelector';
    selectorDiv.className = 'card mt-3 bg-light';
    selectorDiv.innerHTML = `
        <div class="card-header">
            <h6 class="mb-0">Configure: ${equipName}</h6>
        </div>
        <div class="card-body">
            ${variations.map(v => {
                // v.options is already an array from the loaded JSON data
                const options = Array.isArray(v.options) ? v.options : [];
                return `
                    <div class="mb-2">
                        <label class="form-label fw-bold">${v.name}</label>
                        <select class="form-select form-select-sm" data-variation-id="${v.id}" data-variation-name="${v.name}">
                            <option value="">-- Select ${v.name} --</option>
                            ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                    </div>
                `;
            }).join('')}
            <div class="d-flex gap-2 mt-3">
                <button type="button" class="btn btn-sm btn-success" onclick="confirmVariations(${equipId}, '${equipName}')">
                    <i class="bi bi-check"></i> Add Equipment
                </button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelVariations()">
                    Cancel
                </button>
            </div>
        </div>
    `;
    modalBody.appendChild(selectorDiv);
    selectorDiv.scrollIntoView({ behavior: 'smooth' });
}

// Initialize existing equipment on edit
{% if exercise %}
    {% for eq in exercise.equipment %}
        // Build variations object for this equipment
        const variations_{{ eq.id }} = {};
        {% if current_variations %}
            {% for var in current_variations %}
                {% if var.equipment_id == eq.id %}
                    variations_{{ eq.id }}[{{ var.variation_id }}] = {
                        name: '{{ var.variation.name }}',
                        option: '{{ var.selected_option }}'
                    };
                {% endif %}
            {% endfor %}
        {% endif %}
        
        selectedEquipmentIds.add({{ eq.id }});
        selectedEquipmentData[{{ eq.id }}] = { name: '{{ eq.name }}', variations: variations_{{ eq.id }} };
        addEquipmentBadge({{ eq.id }}, '{{ eq.name }}', variations_{{ eq.id }});
    {% endfor %}
{% endif %}

    // Debug form submission
    document.getElementById('exerciseForm').addEventListener('submit', function(e) {
        const equipIds = document.querySelectorAll('input[name="equipment_ids[]"]');
        const variations = document.querySelectorAll('input[name="variations[]"]');
        const secondaryMuscles = document.getElementById('secondary_muscles_input').value;
        console.log('Submitting form with:', {
            equipmentCount: equipIds.length,
            equipmentIds: Array.from(equipIds).map(i => i.value),
            variationsCount: variations.length,
            variations: Array.from(variations).map(v => v.value),
            secondaryMuscles: secondaryMuscles
        });
    });
    
    {% if exercise %}
    // Tier select change handler (edit mode only)
    const tierSelect = document.getElementById('tierSelect');
    if (tierSelect) {
        tierSelect.addEventListener('change', function() {
            const tier = this.value;
            
            fetch('/exercises/{{ exercise.id }}/tier', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tier: tier })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback briefly
                    const originalBg = this.style.backgroundColor;
                    this.style.backgroundColor = '#d1e7dd';
                    setTimeout(() => {
                        this.style.backgroundColor = originalBg;
                    }, 500);
                } else {
                    alert('Error updating tier: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating tier');
            });
        });
    }
    {% endif %}
}); // End DOMContentLoaded
</script>
{% endblock %}
