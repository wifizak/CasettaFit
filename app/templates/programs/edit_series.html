{% extends "base.html" %}
{% block title %}Edit Series - CasettaFit{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('programs.index') }}">Programs</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('programs.view', program_id=program.id) }}">{{ program.name }}</a></li>
                <li class="breadcrumb-item active">Edit Series - Day {{ day.day_number }}</li>
            </ol>
        </nav>
        <h2 class="mb-4">Edit Series - Day {{ day.day_number }}</h2>
        <p class="text-body-secondary">Week {{ week.week_number }}{% if day.day_name %} - {{ day.day_name }}{% endif %}</p>
    </div>
</div>
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" id="seriesForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-4">
                        {{ form.series_type.label(class="form-label") }}
                        {{ form.series_type(class="form-select", id="seriesType") }}
                        <div class="form-text">Choose single exercise or superset (2 exercises performed back-to-back)</div>
                    </div>
                    
                    <div class="mb-4" id="timeLimitField">
                        {{ form.time_seconds.label(class="form-label") }}
                        {{ form.time_seconds(class="form-control") }}
                        <div class="form-text">Optional: Set a time limit for completing the superset</div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.sets.label(class="form-label") }}
                        {{ form.sets(class="form-control") }}
                        <div class="form-text">Number of sets (applies to all exercises in series)</div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">Exercise 1</h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.exercise1_id.label(class="form-label") }}
                            {{ form.exercise1_id(class="form-select" + (" is-invalid" if form.exercise1_id.errors else "")) }}
                            {% if form.exercise1_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.exercise1_id.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.reps1.label(class="form-label") }}
                            {{ form.reps1(class="form-control" + (" is-invalid" if form.reps1.errors else "")) }}
                            {% if form.reps1.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.reps1.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.rest1_time_seconds.label(class="form-label") }}
                            {{ form.rest1_time_seconds(class="form-control") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.target_rpe1.label(class="form-label") }}
                            {{ form.target_rpe1(class="form-control") }}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Starting Weights (Ex 1)</label>
                        <div id="weights1Container" class="row g-2">
                            <!-- Weight inputs will be generated by JavaScript -->
                        </div>
                        <div class="form-text">Enter suggested starting weight for each set</div>
                    </div>
                    
                    <div id="exercise2Section">
                        <hr class="my-4">
                        
                        <h5 class="mb-3">Exercise 2</h5>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.exercise2_id.label(class="form-label") }}
                                {{ form.exercise2_id(class="form-select") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.reps2.label(class="form-label") }}
                                {{ form.reps2(class="form-control") }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.rest2_time_seconds.label(class="form-label") }}
                                {{ form.rest2_time_seconds(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.target_rpe2.label(class="form-label") }}
                                {{ form.target_rpe2(class="form-control") }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Starting Weights (Ex 2)</label>
                            <div id="weights2Container" class="row g-2">
                                <!-- Weight inputs will be generated by JavaScript -->
                            </div>
                            <div class="form-text">Enter suggested starting weight for each set</div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="mb-3">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control", rows=3) }}
                    </div>
                    
                    <div class="d-flex gap-2">
                        {{ form.submit(class="btn btn-primary") }}
                        <a href="{{ url_for('programs.view', program_id=program.id) }}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="card-title">Series Types</h6>
                <p class="small mb-2"><strong>Single Exercise:</strong> One exercise performed for all sets with rest between sets.</p>
                <p class="small mb-0"><strong>Superset:</strong> Two exercises performed back-to-back with rest after completing both. Great for time efficiency and muscle endurance.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const seriesType = document.getElementById('seriesType');
    const exercise2Section = document.getElementById('exercise2Section');
    const timeLimitField = document.getElementById('timeLimitField');
    const setsInput = document.querySelector('input[name="sets"]');
    const weights1Container = document.getElementById('weights1Container');
    const weights2Container = document.getElementById('weights2Container');
    
    // Get existing weights from form data (passed from server as JSON strings)
    let existingWeights1Raw = {{ form.starting_weights1.data|tojson if form.starting_weights1.data else '[]'|safe }};
    let existingWeights2Raw = {{ form.starting_weights2.data|tojson if form.starting_weights2.data else '[]'|safe }};
    
    // Parse if they're JSON strings
    let existingWeights1 = [];
    let existingWeights2 = [];
    
    try {
        existingWeights1 = typeof existingWeights1Raw === 'string' ? JSON.parse(existingWeights1Raw) : existingWeights1Raw;
    } catch(e) {
        existingWeights1 = [];
    }
    
    try {
        existingWeights2 = typeof existingWeights2Raw === 'string' ? JSON.parse(existingWeights2Raw) : existingWeights2Raw;
    } catch(e) {
        existingWeights2 = [];
    }
    
    function updateVisibility() {
        const isSuperset = seriesType.value === 'superset';
        exercise2Section.style.display = isSuperset ? 'block' : 'none';
        timeLimitField.style.display = isSuperset ? 'block' : 'none';
    }
    
    function generateWeightInputs() {
        const numSets = parseInt(setsInput.value) || 0;
        
        // Generate weights for exercise 1
        weights1Container.innerHTML = '';
        for (let i = 1; i <= numSets; i++) {
            const col = document.createElement('div');
            col.className = 'col-md-2';
            const value = existingWeights1[i-1] || '';
            col.innerHTML = `
                <input type="number" step="0.5" class="form-control" 
                       name="weight1_set${i}" placeholder="Set ${i}" value="${value}" />
            `;
            weights1Container.appendChild(col);
        }
        
        // Generate weights for exercise 2
        weights2Container.innerHTML = '';
        for (let i = 1; i <= numSets; i++) {
            const col = document.createElement('div');
            col.className = 'col-md-2';
            const value = existingWeights2[i-1] || '';
            col.innerHTML = `
                <input type="number" step="0.5" class="form-control" 
                       name="weight2_set${i}" placeholder="Set ${i}" value="${value}" />
            `;
            weights2Container.appendChild(col);
        }
    }
    
    seriesType.addEventListener('change', updateVisibility);
    setsInput.addEventListener('input', generateWeightInputs);
    
    updateVisibility();
    generateWeightInputs(); // Initial generation with existing values
});
</script>
{% endblock %}
