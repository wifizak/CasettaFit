{% extends "base.html" %}

{% block title %}Workout{% endblock %}

{% block extra_css %}
<!-- v2.0 CSS Update - Exercise 2-column layout -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
/* Hide sidebar on mobile and tablet devices (even in landscape) */
@media (max-width: 1024px) {
    .sidebar {
        display: none !important;
    }
    
    /* Expand main content to full width when sidebar is hidden */
    body:not(.c-sidebar-show) .wrapper {
        margin-left: 0 !important;
    }
    
    .wrapper {
        margin-left: 0 !important;
    }
}

/* Ensure workout content container uses full width */
#workoutContent {
    width: 100% !important;
    max-width: 100% !important;
    overflow: visible !important;
}

/* Default: 2-column layout using CSS Grid (avoiding Bootstrap's .row class) */
div#workoutContent div.exercise-grid {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 0.5rem !important;
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
}

/* Exercise columns - let grid handle the sizing */
div.exercise-col {
    box-sizing: border-box !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* Superset badges span full width (both columns) */
div.exercise-col.superset-badge-col {
    grid-column: 1 / -1 !important;
}

/* Prevent cards from overflowing */
div.exercise-col div.exercise-card {
    max-width: 100% !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

/* Mobile-only class: show only on screens under 1024px */
.mobile-only {
    display: inline-block !important;
}

@media (min-width: 1025px) {
    .mobile-only {
        display: none !important;
    }
}

/* Weight input color coding */
.weight-input-same {
    color: #28a745 !important; /* Muted green */
}

.weight-input-more {
    color: #6f42c1 !important; /* Muted purple */
}

.weight-input-less {
    color: #dc3545 !important; /* Muted red */
}

/* Custom teal color for Log Set buttons and Logged badges */
.btn-custom-teal {
    background-color: #497D74 !important;
    border-color: #497D74 !important;
    color: white !important;
}

.btn-custom-teal:hover {
    background-color: #3a655e !important;
    border-color: #3a655e !important;
}

.bg-custom-teal {
    background-color: #497D74 !important;
    color: white !important;
}

/* Mobile carousel input styling - applies to both portrait and landscape */
@media (max-width: 1024px) {
    .mobile-sets-carousel input.form-control {
        padding: 0.25rem !important;
        font-size: 1.5rem !important;
        font-weight: 600 !important;
    }
}

/* Portrait mobile: Stack exercises in single column */
@media (max-width: 1024px) and (orientation: portrait) {
    div#workoutContent div.exercise-grid {
        grid-template-columns: 1fr !important;
    }
}

/* Landscape mode optimizations for mobile/tablet */
@media (orientation: landscape) and (max-width: 1024px) {
    /* Ensure full width usage */
    .container-fluid {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
        max-width: 100% !important;
    }
    
    #workoutApp {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
    }
    
    /* Make cards more compact */
    .exercise-card {
        margin-bottom: 0 !important;
    }
    
    /* Reduce card padding in landscape for more space */
    .exercise-card .card-body {
        padding: 0.4rem !important;
    }
    
    /* Keep previous sets indicator visible with proper padding */
    .exercise-card .card-body.bg-light {
        padding: 0.4rem 0.5rem !important;
        display: block !important;
    }
    
    .previous-indicator {
        display: block !important;
        font-size: 0.7rem !important;
    }
    
    .exercise-card .card-header {
        padding: 0.4rem 0.5rem !important;
        font-size: 0.85rem !important;
    }
    
    /* Make carousel more compact */
    .mobile-sets-carousel {
        padding: 0.4rem !important;
    }
    
    /* Optimize mobile carousel in landscape */
    .mobile-sets-carousel .carousel-input-row {
        margin-bottom: 0.4rem !important;
        gap: 0.4rem !important;
    }
    
    .mobile-sets-carousel .carousel-input-label {
        font-size: 0.8rem !important;
        min-width: 60px !important;
    }
    
    .mobile-sets-carousel .carousel-input-label small {
        font-size: 0.7rem !important;
    }
    
    .mobile-sets-carousel button {
        padding: 0.4rem 0.5rem !important;
        font-size: 0.8rem !important;
    }
    
    .carousel-log-btn {
        min-width: 90px !important;
        font-size: 0.8rem !important;
    }
    
    .carousel-navigation button {
        padding: 0.35rem 0.5rem !important;
        font-size: 0.75rem !important;
        min-height: 32px !important;
    }
    
    .carousel-set-header {
        padding: 0.2rem !important;
        margin-bottom: 0.3rem !important;
    }
    
    .carousel-set-title,
    .carousel-set-subtitle {
        font-size: 0.75rem !important;
    }
    
    .carousel-set-subtitle.previous-indicator {
        font-size: 0.8rem !important;
    }
    
    /* Reduce accordion spacing in landscape */
    .set-accordion-item {
        margin-bottom: 0.3rem !important;
    }
    
    .set-accordion-header {
        padding: 0.4rem 0.6rem !important;
        font-size: 0.85rem !important;
    }
    
    .set-accordion-body {
        padding: 0.5rem !important;
    }
    
    /* Compact header in landscape */
    #workoutApp > .row {
        margin-bottom: 0.4rem !important;
    }
    
    h4 {
        font-size: 1rem !important;
        margin-bottom: 0.2rem !important;
    }
    
    small {
        font-size: 0.7rem !important;
    }
    
    /* Compact badges */
    .badge {
        font-size: 0.7rem !important;
        padding: 0.2rem 0.4rem !important;
    }
    
    /* Reduce button sizes slightly */
    .btn-sm {
        padding: 0.2rem 0.3rem !important;
        font-size: 0.75rem !important;
    }
    
    /* Optimize input spacing */
    .mobile-set-input-group {
        margin-bottom: 0.5rem !important;
    }
    
    /* Tighter modals in landscape */
    .modal-body {
        padding: 0.5rem !important;
    }
    
    .modal-header {
        padding: 0.5rem !important;
    }
    
    /* Overall exercise feeling section */
    .border-top {
        padding: 0.5rem 0.4rem 0.3rem 0.4rem !important;
    }
    
    .border-top .row {
        margin: 0 !important;
    }
    
    .border-top .btn-group button {
        min-width: 40px !important;
        padding: 0.3rem 0.4rem !important;
        font-size: 0.8rem !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-2 py-3" id="workoutApp">
    <!-- Header -->
    <div class="row mb-2">
        <div class="col">
            <h4 class="mb-0" id="workoutTitle">Loading...</h4>
            <small class="text-muted" id="workoutSubtitle"></small>
        </div>
    </div>
    
    <div class="row mb-3">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="skipRestsToggle" style="width: 3em; height: 1.5em; cursor: pointer;">
                    <label class="form-check-label ms-2" for="skipRestsToggle" style="cursor: pointer;">
                        Skip Rests
                    </label>
                </div>
                <button class="btn btn-sm btn-danger" onclick="finishWorkout()">
                    <i class="bi bi-check-circle"></i> Finish
                </button>
            </div>
        </div>
    </div>

    <!-- Rest Timer Modal -->
    <div class="modal fade" id="restTimerModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rest Timer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="display-1 fw-bold mb-3" id="restTimerCountdown">0:00</div>
                    <div class="progress mb-3" style="height: 30px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="restTimerProgress" 
                             role="progressbar" 
                             style="width: 100%"></div>
                    </div>
                    <button class="btn btn-primary btn-lg" onclick="skipRestTimer()">
                        <i class="bi bi-skip-forward"></i> Skip Rest
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Exercise Feeling Modal -->
    <div class="modal fade" id="overallFeelingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h6 class="modal-title mb-0">
                        <i class="bi bi-check-circle-fill"></i> All Sets Complete!
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-3">How did this feel overall?</p>
                    <div id="overallFeelingExerciseName" class="mb-3 text-muted small"></div>
                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-danger" style="min-width: 70px;" 
                                onclick="selectOverallFeeling('-')">
                            <div class="fs-3">-</div>
                            <small>Too Heavy</small>
                        </button>
                        <button type="button" class="btn btn-success" style="min-width: 70px;" 
                                onclick="selectOverallFeeling('=')">
                            <div class="fs-3">=</div>
                            <small>Good</small>
                        </button>
                        <button type="button" class="btn btn-primary" style="min-width: 70px;" 
                                onclick="selectOverallFeeling('+')">
                            <div class="fs-3">+</div>
                            <small>Too Easy</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Finish Workout Modal -->
    <div class="modal fade" id="finishWorkoutModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle-fill"></i> Finish Workout
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Are you sure you want to finish this workout?</p>
                    
                    <div class="mb-3">
                        <label for="workoutNotes" class="form-label">Workout Notes <small class="text-muted">(optional)</small></label>
                        <textarea class="form-control" id="workoutNotes" rows="3" 
                                  placeholder="How did the workout go? Any observations?"></textarea>
                    </div>
                    
                    <div id="finishWorkoutWarning" class="alert alert-warning" style="display: none;">
                        <strong>Missing Overall Feeling for:</strong>
                        <ul id="missingRpeList" class="mb-0 mt-2"></ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmFinishWorkout()">
                        <i class="bi bi-check-circle"></i> Finish Workout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Skip Exercise Modal -->
    <div class="modal fade" id="skipExerciseModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-skip-forward-fill"></i> Skip Exercise
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Are you sure you want to skip <strong id="skipExerciseName"></strong>?</p>
                    <p class="text-muted small mb-0">This will mark the exercise as skipped for this workout.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="doSkipExercise()">
                        <i class="bi bi-skip-forward"></i> Skip Exercise
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Workout Content -->
    <div id="workoutContent">
        <!-- Will be populated by JavaScript -->
    </div>

    <!-- Add Exercise (for standalone workouts) -->
    <div class="card mt-3" id="addExerciseCard" style="display: none;">
        <div class="card-body">
            <h5 class="card-title">Add Exercise</h5>
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="exerciseSearchInput" 
                       placeholder="Search exercises...">
                <button class="btn btn-outline-secondary" onclick="searchExercises()">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <div id="exerciseSearchResults"></div>
        </div>
    </div>

    <!-- Bottom Finish Button -->
    <div class="row mt-4 mb-3">
        <div class="col">
            <div class="d-flex justify-content-center align-items-center">
                <button class="btn btn-danger" onclick="finishWorkout()">
                    <i class="bi bi-check-circle"></i> Finish Workout
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Bottom Bar -->
<div id="floatingBottomBar" style="
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10100;
    display: block;
">
    <div class="d-flex justify-content-center align-items-center gap-3">
        <span id="workoutProgressFloating" class="badge bg-info" style="font-size: 1rem !important; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">0 / 0 exercises</span>
        <span id="timerDisplayFloating" class="badge bg-secondary" style="font-size: 1rem !important; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">0:00</span>
    </div>
</div>

<style>
/* Adjust floating bar for landscape mode - bottom nav moves to side, so bar goes to bottom */
@media (orientation: landscape) and (max-width: 1023px) {
    #floatingBottomBar {
        bottom: 10px !important;
    }
}
</style>

<!-- Previous Sets Modal -->
<div class="modal fade" id="previousSetsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Previous Sets</h5>
                <button type="button" class="btn-close" data-coreui-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previousSetsContent">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<style>
/* Fix for mobile switch rendering */
.form-switch .form-check-input {
    width: 3rem;
    height: 1.5rem;
    background-color: #6c757d;
    border: none;
    border-radius: 2rem;
    position: relative;
    cursor: pointer;
    -webkit-appearance: none;
    appearance: none;
    transition: background-color 0.15s ease-in-out;
}

.form-switch .form-check-input::before {
    content: '';
    position: absolute;
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 50%;
    background-color: #fff;
    top: 0.125rem;
    left: 0.125rem;
    transition: transform 0.15s ease-in-out;
}

.form-switch .form-check-input:checked {
    background-color: #0d6efd;
}

.form-switch .form-check-input:checked::before {
    transform: translateX(1.5rem) !important;
}

.form-switch .form-check-input.is-checked {
    background-color: #0d6efd !important;
}

.form-switch .form-check-input.is-checked::before {
    transform: translateX(1.5rem) !important;
}

.form-switch .form-check-input:focus {
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.exercise-card {
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.set-row {
    padding: 0.75rem;
    border-bottom: 1px solid #dee2e6;
    background-color: #fff;
}

.set-row:last-child {
    border-bottom: none;
}

.set-row.completed {
    background-color: #d1e7dd;
}

.set-input {
    width: 70px;
    padding: 0.375rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    text-align: center;
}

.set-number {
    font-weight: bold;
    font-size: 1.1rem;
    min-width: 40px;
}

.btn-log-set {
    min-width: 80px;
}

/* Skipped exercise styling */
.exercise-card.skipped {
    opacity: 0.6;
}

.exercise-card.skipped .card-header {
    background-color: #6c757d !important;
}

.badge-skipped {
    background-color: #6c757d !important;
    color: white !important;
}

.previous-indicator {
    font-size: 0.85rem;
    color: #6c757d;
    font-style: italic;
}

.superset-badge {
    background-color: #ffc107;
    color: #000;
}

/* Mobile View Styles */
@media (max-width: 1023px) {
    /* Hide table view on mobile/tablet */
    .desktop-sets-table {
        display: none !important;
    }
    
    /* Toggle button */
    .mobile-view-toggle {
        margin-bottom: 1rem;
    }
    
    .mobile-view-toggle button {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        font-weight: 600;
        min-height: 44px;
    }
    
    /* One at a time carousel (default) */
    .mobile-sets-carousel {
        display: block !important;
    }
    
    .mobile-sets-carousel.hidden {
        display: none !important;
    }
    
    .carousel-set-header {
        text-align: left;
        padding: 0.25rem;
        margin-bottom: 0.5rem;
    }
    
    .carousel-set-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0;
    }
    
    .carousel-set-subtitle {
        font-size: 0.85rem;
        color: #198754;
        font-weight: 600;
    }
    
    .carousel-set-subtitle.previous-indicator {
        background-color: #f8f9fa;
        padding: 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.9rem;
        color: #000;
        font-style: normal;
        font-weight: 500;
    }
    
    .carousel-input-row {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
        gap: 0.75rem;
    }
    
    .carousel-input-label {
        font-weight: 600;
        font-size: 0.8rem;
        min-width: 90px;
        flex-shrink: 0;
    }
    
    .carousel-input-label small {
        display: block;
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: normal;
    }
    
    .carousel-input-field {
        flex: 1;
        display: flex;
        gap: 0.5rem;
    }
    
    .carousel-input-field input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        font-size: 1rem;
        min-height: 44px;
    }
    
    .carousel-input-field button {
        padding: 0.75rem 1rem;
        min-height: 44px;
        white-space: nowrap;
    }
    
    .carousel-rpe-buttons {
        display: flex;
        gap: 0.5rem;
        flex: 1;
    }
    
    .carousel-rpe-buttons button {
        flex: 1;
        min-height: 38px;
        font-size: 0.95rem;
        font-weight: 600;
    }
    
    .carousel-rpe-row {
        display: flex;
        gap: 0.75rem;
        align-items: stretch;
    }
    
    .carousel-log-btn {
        min-height: 38px;
        font-size: 0.95rem;
        font-weight: 600;
        min-width: 120px;
        flex-shrink: 0;
    }
    
    .carousel-navigation {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #dee2e6;
    }
    
    .carousel-navigation button {
        flex: 1;
        min-height: 36px;
        font-size: 0.85rem;
    }
    
    .carousel-navigation button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    /* Mobile accordion container (show all mode) */
    .mobile-sets-accordion {
        display: none !important;
    }
    
    .mobile-sets-accordion.active {
        display: block !important;
    }
    
    .set-accordion-item {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        background: #fff;
    }
    
    .set-accordion-header {
        padding: 0.75rem 1rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
        border-radius: 0.375rem;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    .set-accordion-header.completed {
        background: #d1e7dd;
    }
    
    .set-accordion-header.current {
        background: #fff3cd;
        border: 2px solid #ffc107;
    }
    
    .set-accordion-item.editing-mode {
        border: 2px solid #fd7e14;
        box-shadow: 0 0 0 0.2rem rgba(253, 126, 20, 0.25);
    }
    
    .carousel-item.editing-mode {
        box-shadow: 0 0 0 0.25rem rgba(253, 126, 20, 0.25);
    }
    
    .set-accordion-title {
        font-weight: 600;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .set-accordion-summary {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .set-accordion-icon {
        transition: transform 0.2s;
        font-size: 1.2rem;
    }
    
    .set-accordion-icon.expanded {
        transform: rotate(180deg);
    }
    
    .set-accordion-body {
        padding: 1rem;
        display: none;
    }
    
    .set-accordion-body.expanded {
        display: block;
    }
    
    .mobile-set-input-group {
        margin-bottom: 1rem;
    }
    
    .mobile-set-input-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }
    
    .mobile-set-input-group input {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .mobile-set-input-group .input-with-button {
        display: flex;
        gap: 0.5rem;
    }
    
    .mobile-set-input-group .input-with-button input {
        flex: 1;
    }
    
    .mobile-set-input-group .input-with-button button {
        padding: 0.75rem 1rem;
        min-height: 44px;
    }
    
    .mobile-rpe-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: space-between;
    }
    
    .mobile-rpe-buttons button {
        flex: 1;
        min-height: 38px;
        font-size: 0.95rem;
        font-weight: 600;
    }
    
    .mobile-save-set-btn {
        width: 100%;
        min-height: 50px;
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 1rem;
    }
    
    /* Overall RPE buttons styling to match per-set RPE */
    .overall-rpe-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    .overall-rpe-buttons button {
        flex: 1;
        min-height: 38px;
        font-size: 0.95rem;
        font-weight: 600;
        min-width: 50px;
    }
}

/* Landscape phone: make RPE buttons wider */
@media (orientation: landscape) and (max-width: 1023px) {
    .carousel-rpe-buttons button,
    .overall-rpe-buttons button {
        min-width: 60px !important;
    }
}

/* Desktop: hide mobile accordion */
@media (min-width: 1024px) {
    .mobile-sets-accordion {
        display: none !important;
    }
}
</style>

<script>
const sessionId = {{ session.id }};
let workoutData = null;
let loggedSets = {};
let skippedExercises = {};
let workoutStartTime = new Date();
let timerInterval = null;
let durationSaveInterval = null;
let restTimerInterval = null;
let restTimerModal = null;
let overallFeelingModal = null;
let finishWorkoutModal = null;
let skipExerciseModal = null;
let pendingSkipExerciseId = null;
let currentOverallFeelingExerciseId = null;
let wakeLock = null;
let skipRests = false;

// ============================================
// Helper Functions
// ============================================

/**
 * Get exercise data by ID from workout structure
 */
function getExerciseData(exerciseId) {
    return workoutData?.series.flatMap(s => s.exercises).find(ex => ex.exercise_id === exerciseId);
}

/**
 * Update RPE button styles consistently across all views
 * @param {string} buttonPrefix - The ID prefix for buttons (e.g., 'rpe-btn', 'rpe-mobile-btn')
 * @param {number} exerciseId - Exercise ID
 * @param {number} setNumber - Set number
 * @param {string} rpeValue - RPE value ('-', '=', '+')
 */
function updateRpeButtons(buttonPrefix, exerciseId, setNumber, rpeValue) {
    const buttons = ['-', '=', '+'];
    const colorMap = {
        '-': { active: 'btn-danger', inactive: 'btn-outline-danger' },
        '=': { active: 'btn-success', inactive: 'btn-outline-success' },
        '+': { active: 'btn-primary', inactive: 'btn-outline-primary' }
    };
    
    buttons.forEach(btn => {
        const btnElement = document.getElementById(`${buttonPrefix}-${exerciseId}-${setNumber}-${btn}`);
        if (!btnElement) return;
        
        const colors = colorMap[btn];
        btnElement.classList.remove(colors.active, colors.inactive);
        btnElement.classList.add(btn === rpeValue ? colors.active : colors.inactive);
    });
}

/**
 * Update the logged badge and progress for an exercise after logging sets
 */
function updateExerciseCompletionUI(exerciseId) {
    const exercise = getExerciseData(exerciseId);
    if (!exercise) return;
    
    const logged = loggedSets[exerciseId] || [];
    const allSetsLogged = logged.length === exercise.sets;
    
    // Update logged badge
    let badge = document.getElementById(`logged-badge-${exerciseId}`);
    if (allSetsLogged && !badge) {
        const cardHeader = document.querySelector(`#overall-rpe-${exerciseId}`)?.closest('.card')?.querySelector('.card-header');
        if (cardHeader) {
            badge = document.createElement('span');
            badge.id = `logged-badge-${exerciseId}`;
            badge.className = 'badge bg-success me-2';
            badge.innerHTML = '✓ Logged';
            cardHeader.querySelector('div')?.appendChild(badge);
        }
    }
    
    // Update progress badge in carousel mode
    const progressBadge = document.getElementById(`set-progress-badge-${exerciseId}`);
    if (progressBadge) {
        // When all sets are logged, show the last set; otherwise show next incomplete set
        let setNumber;
        if (allSetsLogged) {
            setNumber = exercise.sets; // Show last set when complete
        } else {
            // Find first incomplete set
            setNumber = 1;
            for (let i = 1; i <= exercise.sets; i++) {
                if (!logged.find(s => s.set_number === i)) {
                    setNumber = i;
                    break;
                }
            }
        }
        progressBadge.innerHTML = `Set <span style="font-size: 1.6em; font-weight: 900;">${setNumber}</span> of ${exercise.sets}`;
        // Update colors based on set number
        const colors = getSetProgressColor(setNumber);
        progressBadge.style.backgroundColor = colors.bg;
        progressBadge.style.color = colors.text;
    }
}

function toggleSkipRests() {
    const checkbox = document.getElementById('skipRestsToggle');
    skipRests = checkbox.checked;
    console.log('Skip rests:', skipRests);
}

// Get heatmap color for set progress badge based on set number
function getSetProgressColor(setNumber) {
    switch(setNumber) {
        case 1:
            return { bg: '#360185', text: '#fff' }; // Deep Purple
        case 2:
            return { bg: '#8F0177', text: '#fff' }; // Magenta
        case 3:
            return { bg: '#DE1A58', text: '#fff' }; // Pink/Red
        case 4:
            return { bg: '#F4B342', text: '#000' }; // Yellow/Gold
        default: // 5+
            return { bg: '#F4B342', text: '#000' }; // Yellow/Gold
    }
}

// Request wake lock to keep screen on during workout
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake Lock active - screen will stay on');
            
            // Re-request wake lock if visibility changes (e.g., tab switch)
            wakeLock.addEventListener('release', () => {
                console.log('Wake Lock released');
            });
        }
    } catch (err) {
        console.log('Wake Lock not supported or failed:', err);
    }
}

// Release wake lock when leaving page
function releaseWakeLock() {
    if (wakeLock !== null) {
        wakeLock.release()
            .then(() => {
                wakeLock = null;
                console.log('Wake Lock released manually');
            });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    restTimerModal = new coreui.Modal(document.getElementById('restTimerModal'));
    overallFeelingModal = new coreui.Modal(document.getElementById('overallFeelingModal'));
    finishWorkoutModal = new coreui.Modal(document.getElementById('finishWorkoutModal'));
    skipExerciseModal = new coreui.Modal(document.getElementById('skipExerciseModal'));
    
    // Add event listener for skip rests toggle
    const skipRestsToggle = document.getElementById('skipRestsToggle');
    if (skipRestsToggle) {
        console.log('Skip rests toggle found');
        
        // Handle clicks and manually toggle
        skipRestsToggle.addEventListener('click', function(e) {
            // Manually toggle the state
            this.checked = !skipRests;
            skipRests = this.checked;
            
            // Add/remove class for mobile styling
            if (skipRests) {
                this.setAttribute('checked', 'checked');
                this.classList.add('is-checked');
            } else {
                this.removeAttribute('checked');
                this.classList.remove('is-checked');
            }
            
            console.log('Skip rests toggled to:', skipRests);
        });
    } else {
        console.error('Skip rests toggle not found!');
    }
    
    requestWakeLock();  // Keep screen on during workout
    loadWorkoutData();
    startWorkoutTimer();
});

// Re-acquire wake lock when page becomes visible again
document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible') {
        requestWakeLock();
    }
});

// Release wake lock when page is unloaded
window.addEventListener('beforeunload', releaseWakeLock);

function startWorkoutTimer() {
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((new Date() - workoutStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        const floatingTimer = document.getElementById('timerDisplayFloating');
        if (floatingTimer) {
            floatingTimer.textContent = timeString;
        }
    }, 1000);
    
    // Save duration to backend every 10 seconds
    durationSaveInterval = setInterval(async () => {
        const elapsed = Math.floor((new Date() - workoutStartTime) / 1000);
        try {
            await fetch(`/workout/api/session/${sessionId}/update-duration`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ duration_seconds: elapsed })
            });
        } catch (error) {
            console.error('Error saving duration:', error);
        }
    }, 10000);
}

async function loadWorkoutData() {
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/data`);
        workoutData = await response.json();
        loggedSets = workoutData.logged_sets || {};
        skippedExercises = workoutData.skipped_exercises || {};
        
        // Initialize workout timer from saved duration_seconds
        // Timer starts from saved duration, not from started_at timestamp
        if (workoutData.duration_seconds) {
            workoutStartTime = new Date(Date.now() - (workoutData.duration_seconds * 1000));
        }
        
        // Update header
        if (workoutData.is_standalone) {
            document.getElementById('workoutTitle').textContent = 'Standalone Workout';
            document.getElementById('workoutSubtitle').textContent = 
                workoutData.gym_name || 'No gym selected';
            document.getElementById('addExerciseCard').style.display = 'block';
        } else {
            document.getElementById('workoutTitle').textContent = 
                `${workoutData.program_name} - ${workoutData.day_name}`;
            document.getElementById('workoutSubtitle').textContent = 
                `${workoutData.calendar_date} • ${workoutData.gym_name || 'No gym'}`;
            renderWorkout();
        }
        
        // Update progress indicator
        updateWorkoutProgress();
    } catch (error) {
        console.error('Error loading workout data:', error);
        alert('Error loading workout. Please try again.');
    }
}

function updateWorkoutProgress() {
    if (!workoutData || !workoutData.series) return;
    
    // Count total exercises
    const allExercises = workoutData.series.flatMap(s => s.exercises);
    const totalExercises = allExercises.length;
    
    // Count completed exercises (all sets logged OR skipped)
    let completedExercises = 0;
    allExercises.forEach(exercise => {
        const logged = loggedSets[exercise.exercise_id] || [];
        const isSkipped = skippedExercises[exercise.exercise_id] !== undefined;
        if (logged.length === exercise.sets || isSkipped) {
            completedExercises++;
        }
    });
    
    const progressText = `${completedExercises} / ${totalExercises} exercises`;
    const progressFloating = document.getElementById('workoutProgressFloating');
    
    if (progressFloating) {
        progressFloating.textContent = progressText;
        // Change color based on completion
        if (completedExercises === totalExercises && totalExercises > 0) {
            progressFloating.classList.remove('bg-info', 'bg-warning');
            progressFloating.classList.add('bg-success');
        } else if (completedExercises > 0) {
            progressFloating.classList.remove('bg-info', 'bg-success');
            progressFloating.classList.add('bg-warning');
        } else {
            progressFloating.classList.remove('bg-warning', 'bg-success');
            progressFloating.classList.add('bg-info');
        }
    }
}

function renderWorkout() {
    const container = document.getElementById('workoutContent');
    
    // Build all exercise HTML first
    let exercisesHtml = '';
    
    workoutData.series.forEach((series, seriesIndex) => {
        const isSuperset = series.series_type === 'superset';
        const colors = ['primary', 'success', 'danger', 'warning', 'info'];
        const color = colors[seriesIndex % 5];
        
        if (isSuperset) {
            // Superset badge - full width
            exercisesHtml += `<div class="exercise-col superset-badge-col">`;
            exercisesHtml += `<div class="badge superset-badge mb-1">SUPERSET</div>`;
            exercisesHtml += `</div>`;
            
            // Superset exercises - each in its own column
            series.exercises.forEach((exercise, exIndex) => {
                const exerciseLabel = String.fromCharCode(65 + exIndex);
                exercisesHtml += `<div class="exercise-col">`;
                exercisesHtml += renderExerciseCard(exercise, exerciseLabel, color, seriesIndex);
                exercisesHtml += `</div>`;
            });
        } else {
            // Regular exercise - one column with empty badge spacer for consistent spacing
            const exercise = series.exercises[0];
            exercisesHtml += `<div class="exercise-col superset-badge-col">`;
            exercisesHtml += `<div class="mb-1" style="height: 28px;"></div>`;
            exercisesHtml += `</div>`;
            exercisesHtml += `<div class="exercise-col">`;
            exercisesHtml += renderExerciseCard(exercise, null, color, seriesIndex);
            exercisesHtml += `</div>`;
        }
    });
    
    // Create a temporary container to parse the HTML safely
    const tempDiv = document.createElement('div');
    tempDiv.className = 'exercise-grid';
    tempDiv.innerHTML = exercisesHtml;
    
    // Replace the container's content
    container.innerHTML = '';
    container.appendChild(tempDiv);
    
    // Apply initial weight colors for any pre-existing values
    setTimeout(() => initializeWeightColors(), 0);
}

function renderCarouselSet(exercise, setNumber, logged) {
    const numSets = exercise.sets;
    const loggedSet = logged.find(s => s.set_number === setNumber);
    const isCompleted = loggedSet !== undefined;
    const suggestedWeight = exercise.suggested_weights[setNumber - 1] || exercise.suggested_weights[0] || '';
    const suggestedReps = exercise.reps || '';
    
    // Get set-specific previous data
    const previousSet = exercise.previous_sets?.find(p => p.set_number === setNumber);
    
    let html = '';
    
    // Header - show previous set info or completion info
    if (isCompleted) {
        html += `<div class="carousel-set-header">`;
        html += `<div class="carousel-set-title">`;
        html += `<i class="bi bi-check-circle-fill text-success"></i> Completed`;
        html += `</div>`;
        html += `<div class="carousel-set-subtitle">`;
        html += `${loggedSet.weight} lbs × ${loggedSet.reps} reps${loggedSet.rpe ? ' @ RPE ' + loggedSet.rpe : ''}`;
        html += `</div>`;
        html += `</div>`;
    } else if (previousSet) {
        html += `<div class="carousel-set-header">`;
        html += `<div class="carousel-set-subtitle previous-indicator">`;
        const prevDate = previousSet.date ? new Date(previousSet.date) : null;
        const dateStr = prevDate ? `${prevDate.getMonth() + 1}/${prevDate.getDate()}:` : 'Last:';
        html += `${dateStr} <strong>${previousSet.weight}</strong> lbs × <strong>${previousSet.reps}</strong> reps (Set ${setNumber})`;
        if (previousSet.rpe) {
            const rpeColor = previousSet.rpe === '-' ? '#dc3545' : previousSet.rpe === '=' ? '#198754' : '#0d6efd';
            html += ` @ RPE <span style="display: inline-block; font-weight: 700; color: ${rpeColor}; transform: scale(1.5); position: relative; top: -2px;">${previousSet.rpe}</span>`;
        }
        html += `</div>`;
        html += `</div>`;
    }    
    
    // Weight
    html += `<div class="carousel-input-row">`;    
    html += `<div class="carousel-input-label">Weight <small>lbs</small></div>`;    
    html += `<div class="carousel-input-field">`;    
    html += `<input type="number" class="form-control" `;    
    html += `id="weight-carousel-${exercise.exercise_id}-${setNumber}" `;    
    html += `data-suggested="${suggestedWeight || ''}" `;
    html += `placeholder="${suggestedWeight || 'Enter weight'}" `;    
    html += `value="${loggedSet?.weight || ''}" step="0.5" `;
    html += `oninput="updateWeightColor(this, ${exercise.exercise_id}, ${setNumber}, 'carousel')">`;    
    if (suggestedWeight) {
        html += `<button type="button" class="btn btn-outline-secondary" `;        
        html += `onclick="applyWeightCarousel(${exercise.exercise_id}, ${setNumber}, ${suggestedWeight})">`;        
        html += `Use ${suggestedWeight}</button>`;        
    }
    html += `</div></div>`;    
    
    // Reps
    html += `<div class="carousel-input-row">`;    
    html += `<div class="carousel-input-label">Reps</div>`;    
    html += `<div class="carousel-input-field">`;    
    html += `<input type="number" class="form-control" `;    
    html += `id="reps-carousel-${exercise.exercise_id}-${setNumber}" `;    
    html += `value="${loggedSet?.reps || suggestedReps}" `;    
    html += `placeholder="${suggestedReps || 'Enter reps'}">`;    
    html += `</div></div>`;    
    
    // RPE + Log button row
    html += `<div class="carousel-input-row">`;    
    html += `<div class="carousel-input-label">RPE <small>optional</small></div>`;    
    html += `<div class="carousel-rpe-row">`;    
    html += `<div class="carousel-rpe-buttons">`;    
    const currentRpe = loggedSet?.rpe || '';
    html += `<button type="button" class="btn ${currentRpe === '-' ? 'btn-danger' : 'btn-outline-danger'}" `;    
    html += `onclick="setRpeCarousel(${exercise.exercise_id}, ${setNumber}, '-')" `;    
    html += `id="rpe-carousel-btn-${exercise.exercise_id}-${setNumber}--">-</button>`;    
    html += `<button type="button" class="btn ${currentRpe === '=' ? 'btn-success' : 'btn-outline-success'}" `;    
    html += `onclick="setRpeCarousel(${exercise.exercise_id}, ${setNumber}, '=')" `;    
    html += `id="rpe-carousel-btn-${exercise.exercise_id}-${setNumber}-=">=</button>`;    
    html += `<button type="button" class="btn ${currentRpe === '+' ? 'btn-primary' : 'btn-outline-primary'}" `;    
    html += `onclick="setRpeCarousel(${exercise.exercise_id}, ${setNumber}, '+')" `;    
    html += `id="rpe-carousel-btn-${exercise.exercise_id}-${setNumber}-+">+</button>`;    
    html += `</div>`;    
    // Log/Update button next to RPE buttons
    if (isCompleted) {
        // Show Edit button when set is logged
        html += `<button type="button" class="btn btn-warning carousel-log-btn" `;    
        html += `onclick="enableEditCarousel(${exercise.exercise_id}, ${setNumber})" `;    
        html += `id="edit-btn-carousel-${exercise.exercise_id}-${setNumber}">`;    
        html += `<i class="bi bi-pencil"></i> Edit`;    
        html += `</button>`;    
    } else {
        // Show Log button when set is not logged
        html += `<button type="button" class="btn btn-custom-teal carousel-log-btn" `;    
        html += `onclick="logSetCarousel(${exercise.exercise_id}, ${setNumber}, ${exercise.rest_time_seconds || 0})" `;    
        html += `id="log-btn-carousel-${exercise.exercise_id}-${setNumber}">`;    
        html += `<i class="bi bi-check-lg"></i> Log`;    
        html += `</button>`;    
    }
    html += `</div>`;    
    html += `<input type="hidden" id="rpe-carousel-${exercise.exercise_id}-${setNumber}" value="${currentRpe}">`;    
    html += `</div>`;    
    
    // Navigation
    html += `<div class="carousel-navigation">`;    
    html += `<button type="button" class="btn btn-outline-primary" `;    
    html += `onclick="navigateCarousel(${exercise.exercise_id}, ${setNumber - 1})" `;    
    html += `${setNumber <= 1 ? 'disabled' : ''}>`;    
    html += `<i class="bi bi-chevron-left"></i> Previous`;    
    html += `</button>`;    
    html += `<button type="button" class="btn btn-outline-primary" `;    
    html += `onclick="navigateCarousel(${exercise.exercise_id}, ${setNumber + 1})" `;    
    html += `${setNumber >= numSets ? 'disabled' : ''}>`;    
    html += `Next <i class="bi bi-chevron-right"></i>`;    
    html += `</button>`;    
    html += `</div>`;    
    
    return html;
}

function renderExerciseCard(exercise, label, color, seriesIndex) {
    const numSets = exercise.sets;
    const logged = loggedSets[exercise.exercise_id] || [];
    const isSkipped = skippedExercises[exercise.exercise_id] !== undefined;
    
    // Calculate first incomplete set early (needed for carousel)
    let firstIncompleteSet = 1;
    for (let setNum = 1; setNum <= numSets; setNum++) {
        if (!logged.find(s => s.set_number === setNum)) {
            firstIncompleteSet = setNum;
            break;
        }
        if (setNum === numSets && logged.find(s => s.set_number === setNum)) {
            firstIncompleteSet = numSets; // All complete - show last set
        }
    }
    
    let html = `<div class="card exercise-card ${isSkipped ? 'skipped' : ''} border-${color} border-3 mb-3" id="card-${exercise.exercise_id}">`;
    
    // Header
    html += `<div class="card-header bg-${color} text-white d-flex justify-content-between align-items-center">`;
    html += `<span>${label ? label + '. ' : ''}${exercise.exercise_name}</span>`;
    html += `<div class="d-flex align-items-center gap-2">`;
    
    // Show appropriate badge based on status
    if (isSkipped) {
        html += `<span class="badge badge-skipped" id="skipped-badge-${exercise.exercise_id}">Skipped</span>`;
    } else {
        // Add Set X of Y badge for mobile carousel view with heatmap colors
        const progressColors = getSetProgressColor(firstIncompleteSet);
        html += `<span class="badge mobile-only" id="set-progress-badge-${exercise.exercise_id}" `;
        html += `style="font-size: 0.875rem; background-color: ${progressColors.bg}; color: ${progressColors.text};">`;
        html += `Set <span style="font-size: 1.6em; font-weight: 900;">${firstIncompleteSet}</span> of ${numSets}</span>`;
        if (logged.length > 0 && logged.length === numSets) {
            html += `<span class="badge bg-custom-teal me-2" id="logged-badge-${exercise.exercise_id}">✓ Logged</span>`;
        }
    }
    
    html += `<button class="btn btn-sm btn-light mobile-only" onclick="toggleMobileView(${exercise.exercise_id})" `;
    html += `id="toggle-view-${exercise.exercise_id}" title="Show all sets">`;
    html += `<i class="bi bi-grid-3x3"></i></button>`;
    if (exercise.previous_sets && exercise.previous_sets.length > 0) {
        html += `<button class="btn btn-sm btn-light" onclick="showPreviousSets(${exercise.exercise_id})">`;
        html += `<i class="bi bi-clock-history"></i></button>`;
    }
    // Add Skip button (or Un-skip if already skipped)
    if (isSkipped) {
        html += `<button class="btn btn-sm btn-warning" onclick="unskipExercise(${exercise.exercise_id})" title="Un-skip exercise">`;
        html += `<i class="bi bi-arrow-counterclockwise"></i></button>`;
    } else if (logged.length === 0) {
        // Only show skip button if no sets have been logged
        html += `<button class="btn btn-sm btn-outline-light" onclick="confirmSkipExercise(${exercise.exercise_id})" title="Skip exercise">`;
        html += `<i class="bi bi-skip-forward"></i></button>`;
    }
    html += `</div>`;
    html += `</div>`;
    
    // Body with column-based sets (DESKTOP TABLE VIEW)
    html += `<div class="card-body p-3 desktop-sets-table">`;
    html += `<div class="table-responsive">`;
    html += `<table class="table table-sm table-borderless mb-0">`;
    
    // Header row with set numbers
    html += `<thead><tr><th></th>`;
    for (let setNum = 1; setNum <= numSets; setNum++) {
        const isCompleted = logged.find(s => s.set_number === setNum) !== undefined;
        const previousSet = exercise.previous_sets?.find(p => p.set_number === setNum);
        html += `<th class="text-center ${isCompleted ? 'text-success' : ''}">`;
        html += `<strong>Set ${setNum}</strong>`;
        if (isCompleted) html += ` <i class="bi bi-check-circle-fill"></i>`;
        if (previousSet && !isCompleted) {
            html += `<br><small class="previous-indicator" style="font-weight: normal;">`;
            html += `${previousSet.weight}×${previousSet.reps}`;
            if (previousSet.rpe) {
                const rpeColor = previousSet.rpe === '-' ? '#dc3545' : previousSet.rpe === '=' ? '#198754' : '#0d6efd';
                html += ` @<span style="display: inline-block; font-weight: 700; color: ${rpeColor}; transform: scale(1.3); position: relative; top: -1px;">${previousSet.rpe}</span>`;
            }
            html += `</small>`;
        }
        html += `</th>`;
    }
    html += `</tr></thead><tbody>`;
    
    // Weight row
    html += `<tr><td class="align-middle"><strong>Weight</strong><br><small class="text-muted">lbs</small></td>`;
    for (let setNum = 1; setNum <= numSets; setNum++) {
        const suggestedWeight = exercise.suggested_weights[setNum - 1] || exercise.suggested_weights[0] || '';
        const loggedSet = logged.find(s => s.set_number === setNum);
        html += `<td class="text-center">`;
        html += `<div class="d-flex align-items-center justify-content-center gap-1">`;
        html += `<input type="number" class="form-control form-control-sm text-center" `;
        html += `id="weight-${exercise.exercise_id}-${setNum}" `;
        html += `data-suggested="${suggestedWeight || ''}" `;
        html += `placeholder="${suggestedWeight}" `;
        html += `value="${loggedSet?.weight || ''}" step="0.5" style="width: 80px;" `;
        html += `oninput="updateWeightColor(this, ${exercise.exercise_id}, ${setNum}, 'desktop')">`;
        if (suggestedWeight) {
            html += `<button type="button" class="btn btn-sm btn-outline-secondary" `;
            html += `onclick="applySuggestedWeight(${exercise.exercise_id}, ${setNum}, ${suggestedWeight})" `;
            html += `title="Use suggested weight" style="padding: 0.25rem 0.4rem;">`;
            html += `<i class="bi bi-check2"></i></button>`;
        }
        html += `</div>`;
        html += `</td>`;
    }
    html += `</tr>`;
    
    // Reps row
    html += `<tr><td class="align-middle"><strong>Reps</strong></td>`;
    for (let setNum = 1; setNum <= numSets; setNum++) {
        const suggestedReps = exercise.reps || '';
        const loggedSet = logged.find(s => s.set_number === setNum);
        html += `<td class="text-center">`;
        html += `<input type="number" class="form-control form-control-sm text-center" `;
        html += `id="reps-${exercise.exercise_id}-${setNum}" `;
        html += `value="${loggedSet?.reps || suggestedReps}" style="width: 80px; margin: 0 auto;">`;
        html += `</td>`;
    }
    html += `</tr>`;
    
    // RPE row (clicking RPE logs the set)
    html += `<tr><td class="align-middle"><strong>RPE</strong><br><small class="text-muted">click to log</small></td>`;
    for (let setNum = 1; setNum <= numSets; setNum++) {
        const loggedSet = logged.find(s => s.set_number === setNum);
        const currentRpe = loggedSet?.rpe || '';
        html += `<td class="text-center">`;
        html += `<div class="btn-group btn-group-sm" role="group" style="width: 100px; margin: 0 auto;">`;
        html += `<button type="button" class="btn ${currentRpe === '-' ? 'btn-danger' : 'btn-outline-danger'}" `;
        html += `onclick="setRpe(${exercise.exercise_id}, ${setNum}, '-')" title="Too Heavy">-</button>`;
        html += `<button type="button" class="btn ${currentRpe === '=' ? 'btn-success' : 'btn-outline-success'}" `;
        html += `onclick="setRpe(${exercise.exercise_id}, ${setNum}, '=')" title="Good Weight">=</button>`;
        html += `<button type="button" class="btn ${currentRpe === '+' ? 'btn-primary' : 'btn-outline-primary'}" `;
        html += `onclick="setRpe(${exercise.exercise_id}, ${setNum}, '+')" title="Could Do More">+</button>`;
        html += `</div>`;
        html += `<input type="hidden" id="rpe-${exercise.exercise_id}-${setNum}" value="${currentRpe}">`;
        html += `</td>`;
    }
    html += `</tr>`;
    
    html += `</tbody></table></div>`;
    html += `</div>`; // End desktop-sets-table
    
    // MOBILE VIEWS (Carousel + Accordion)
    html += `<div class="card-body p-2 mobile-sets-carousel">`;
    // Carousel container for current set
    html += `<div id="carousel-${exercise.exercise_id}">`;    
    html += renderCarouselSet(exercise, firstIncompleteSet, logged);
    html += `</div>`;    
    
    html += `</div>`; // End mobile-sets-carousel
    
    // MOBILE ACCORDION VIEW (Show All)
    html += `<div class="card-body p-3 mobile-sets-accordion" id="accordion-view-${exercise.exercise_id}">`;    
    
    
    // Render each set as accordion item (firstIncompleteSet already calculated above)
    for (let setNum = 1; setNum <= numSets; setNum++) {
        const loggedSet = logged.find(s => s.set_number === setNum);
        const isCompleted = loggedSet !== undefined;
        const isCurrent = setNum === firstIncompleteSet;
        const suggestedWeight = exercise.suggested_weights[setNum - 1] || exercise.suggested_weights[0] || '';
        const suggestedReps = exercise.reps || '';
        const previousSet = exercise.previous_sets?.find(p => p.set_number === setNum);
        
        html += `<div class="set-accordion-item" id="accordion-${exercise.exercise_id}-${setNum}">`;
        
        // Header
        let headerClass = 'set-accordion-header';
        if (isCompleted) headerClass += ' completed';
        if (isCurrent && !isCompleted) headerClass += ' current';
        
        html += `<div class="${headerClass}" onclick="toggleSetAccordion(${exercise.exercise_id}, ${setNum})">`;
        html += `<div>`;
        html += `<div class="set-accordion-title">`;
        if (isCompleted) {
            html += `<i class="bi bi-check-circle-fill text-success"></i>`;
        }
        html += `<span>Set ${setNum}</span>`;
        html += `</div>`;
        
        // Summary for completed sets or previous set data
        if (isCompleted) {
            html += `<div class="set-accordion-summary">`;
            html += `${loggedSet.weight} lbs × ${loggedSet.reps} reps`;
            if (loggedSet.rpe) html += ` @ RPE ${loggedSet.rpe}`;
            html += `</div>`;
        } else if (previousSet) {
            html += `<div class="set-accordion-summary previous-indicator">`;
            const prevDate = previousSet.date ? new Date(previousSet.date) : null;
            const dateStr = prevDate ? `${prevDate.getMonth() + 1}/${prevDate.getDate()}:` : 'Last:';
            html += `${dateStr} <strong>${previousSet.weight}</strong> lbs × <strong>${previousSet.reps}</strong> reps (Set ${setNum})`;
            if (previousSet.rpe) {
                const rpeColor = previousSet.rpe === '-' ? '#dc3545' : previousSet.rpe === '=' ? '#198754' : '#0d6efd';
                html += ` @ RPE <span style="display: inline-block; font-weight: 700; color: ${rpeColor}; transform: scale(1.5); position: relative; top: -2px;">${previousSet.rpe}</span>`;
            }
            html += `</div>`;
        }
        html += `</div>`;
        
        html += `<i class="bi bi-chevron-down set-accordion-icon ${isCurrent ? 'expanded' : ''}" `;
        html += `id="icon-${exercise.exercise_id}-${setNum}"></i>`;
        html += `</div>`; // End header
        
        // Body (expanded for current set)
        html += `<div class="set-accordion-body ${isCurrent ? 'expanded' : ''}" `;
        html += `id="body-${exercise.exercise_id}-${setNum}">`;
        
        // Weight input
        html += `<div class="mobile-set-input-group">`;
        html += `<label>Weight (lbs)</label>`;
        html += `<div class="input-with-button">`;
        html += `<input type="number" class="form-control" `;
        html += `id="weight-mobile-${exercise.exercise_id}-${setNum}" `;
        html += `data-suggested="${suggestedWeight || ''}" `;
        html += `placeholder="${suggestedWeight || 'Enter weight'}" `;
        html += `value="${loggedSet?.weight || ''}" step="0.5" `;
        html += `oninput="updateWeightColor(this, ${exercise.exercise_id}, ${setNum}, 'mobile')">`;
        if (suggestedWeight) {
            html += `<button type="button" class="btn btn-outline-secondary" `;
            html += `onclick="applySuggestedWeightMobile(${exercise.exercise_id}, ${setNum}, ${suggestedWeight})">`;
            html += `Use ${suggestedWeight}</button>`;
        }
        html += `</div>`;
        html += `</div>`;
        
        // Reps input
        html += `<div class="mobile-set-input-group">`;
        html += `<label>Reps</label>`;
        html += `<input type="number" class="form-control" `;
        html += `id="reps-mobile-${exercise.exercise_id}-${setNum}" `;
        html += `value="${loggedSet?.reps || suggestedReps}" `;
        html += `placeholder="${suggestedReps || 'Enter reps'}">`;
        html += `</div>`;
        
        // RPE buttons
        html += `<div class="mobile-set-input-group">`;
        html += `<label>How did this set feel? <span class="text-muted">(optional)</span></label>`;
        const currentRpe = loggedSet?.rpe || '';
        html += `<div class="mobile-rpe-buttons">`;
        html += `<button type="button" class="btn ${currentRpe === '-' ? 'btn-danger' : 'btn-outline-danger'}" `;
        html += `onclick="setRpeMobile(${exercise.exercise_id}, ${setNum}, '-')" `;
        html += `id="rpe-mobile-btn-${exercise.exercise_id}-${setNum}--">-</button>`;
        html += `<button type="button" class="btn ${currentRpe === '=' ? 'btn-success' : 'btn-outline-success'}" `;
        html += `onclick="setRpeMobile(${exercise.exercise_id}, ${setNum}, '=')" `;
        html += `id="rpe-mobile-btn-${exercise.exercise_id}-${setNum}-=">=</button>`;
        html += `<button type="button" class="btn ${currentRpe === '+' ? 'btn-primary' : 'btn-outline-primary'}" `;
        html += `onclick="setRpeMobile(${exercise.exercise_id}, ${setNum}, '+')" `;
        html += `id="rpe-mobile-btn-${exercise.exercise_id}-${setNum}-+">+</button>`;
        html += `</div>`;
        html += `<input type="hidden" id="rpe-mobile-${exercise.exercise_id}-${setNum}" value="${currentRpe}">`;
        html += `</div>`;
        
        // Log Set or Edit button
        if (isCompleted) {
            html += `<button type="button" class="btn btn-warning mobile-save-set-btn" `;
            html += `id="edit-btn-mobile-${exercise.exercise_id}-${setNum}" `;
            html += `onclick="enableEditMobile(${exercise.exercise_id}, ${setNum})">`;
            html += `<i class="cil-pencil"></i> Edit Set ${setNum}`;
            html += `</button>`;
        } else {
            html += `<button type="button" class="btn btn-custom-teal mobile-save-set-btn" `;
            html += `id="log-btn-mobile-${exercise.exercise_id}-${setNum}" `;
            html += `onclick="logSingleSetMobile(${exercise.exercise_id}, ${setNum}, ${exercise.rest_time_seconds || 0})">`;
            html += `<i class="bi bi-check-lg"></i> Log${setNum}`;
            html += `</button>`;
        }
        
        html += `</div>`; // End body
        html += `</div>`; // End accordion item
    }
    
    html += `</div>`; // End mobile-sets-accordion
    
    // Overall exercise RPE section
    const anySetLogged = logged.length > 0;
    const overallRpe = logged.find(s => s.overall_rpe)?.overall_rpe || '';
    
    html += `<div class="border-top pt-3 px-3 pb-2">`;
    html += `<div class="row align-items-center">`;
    html += `<div class="col-auto">`;
    html += `<div class="carousel-input-label">Overall RPE: <span class="text-danger">*</span>`;
    // Show previous overall RPE if available
    if (exercise.previous_overall_rpe) {
        const prevRpeColor = exercise.previous_overall_rpe === '-' ? '#dc3545' : exercise.previous_overall_rpe === '=' ? '#198754' : '#0d6efd';
        html += ` <span style="color: #6c757d; font-size: 0.75rem;">(Last: <span style="display: inline-block; font-weight: 700; color: ${prevRpeColor}; transform: scale(1.3); position: relative; top: -1px;">${exercise.previous_overall_rpe}</span>)</span>`;
    }
    html += `</div>`;
    html += `</div>`;
    html += `<div class="col-auto">`;
    html += `<div class="overall-rpe-buttons">`;
    html += `<button type="button" class="btn ${overallRpe === '-' ? 'btn-danger' : 'btn-outline-danger'}" `;
    html += `onclick="setOverallRpe(${exercise.exercise_id}, '-')" `;
    html += `id="overall-rpe-btn-${exercise.exercise_id}--" title="Too Heavy">-</button>`;
    html += `<button type="button" class="btn ${overallRpe === '=' ? 'btn-success' : 'btn-outline-success'}" `;
    html += `onclick="setOverallRpe(${exercise.exercise_id}, '=')" `;
    html += `id="overall-rpe-btn-${exercise.exercise_id}-=" title="Good Weight">=</button>`;
    html += `<button type="button" class="btn ${overallRpe === '+' ? 'btn-primary' : 'btn-outline-primary'}" `;
    html += `onclick="setOverallRpe(${exercise.exercise_id}, '+')" `;
    html += `id="overall-rpe-btn-${exercise.exercise_id}-+" title="Could Do More">+</button>`;
    html += `</div>`;
    html += `<input type="hidden" id="overall-rpe-${exercise.exercise_id}" value="${overallRpe}">`;
    html += `</div>`;
    html += `</div>`;
    html += `</div>`;
    html += `</div>`;
    html += `</div>`;
    
    html += `</div></div>`;
    
    return html;
}
function setRpe(exerciseId, setNumber, rpeValue) {
    // Update hidden input
    const rpeInput = document.getElementById(`rpe-${exerciseId}-${setNumber}`);
    if (rpeInput) {
        rpeInput.value = rpeValue;
    }
    
    // Update button styles using consolidated helper
    updateRpeButtons('rpe-btn', exerciseId, setNumber, rpeValue);
    
    // Automatically log the set when RPE is selected
    logSingleSet(exerciseId, setNumber);
}

async function logSingleSet(exerciseId, setNumber) {
    // Get weight and reps from desktop view inputs
    const weightInput = document.getElementById(`weight-${exerciseId}-${setNumber}`);
    const repsInput = document.getElementById(`reps-${exerciseId}-${setNumber}`);
    const rpeInput = document.getElementById(`rpe-${exerciseId}-${setNumber}`);
    
    const weight = parseFloat(weightInput?.value);
    const reps = parseInt(repsInput?.value);
    const rpe = rpeInput?.value || null;
    
    if (!weight || !reps || isNaN(weight) || isNaN(reps)) {
        alert('Please enter both weight and reps before selecting RPE.');
        // Reset RPE if validation fails
        if (rpeInput) rpeInput.value = '';
        // Reset button styles
        const buttonGroup = rpeInput?.parentElement;
        if (buttonGroup) {
            buttonGroup.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('btn-danger', 'btn-success', 'btn-primary');
                const btnValue = btn.textContent.trim();
                if (btnValue === '-') btn.classList.add('btn-outline-danger');
                else if (btnValue === '=') btn.classList.add('btn-outline-success');
                else if (btnValue === '+') btn.classList.add('btn-outline-primary');
            });
        }
        return;
    }
    
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/log-set`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                exercise_id: exerciseId,
                set_number: setNumber,
                weight: weight,
                reps: reps,
                rpe: rpe
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update logged sets
            if (!loggedSets[exerciseId]) {
                loggedSets[exerciseId] = [];
            }
            const existingIndex = loggedSets[exerciseId].findIndex(s => s.set_number === setNumber);
            if (existingIndex >= 0) {
                loggedSets[exerciseId][existingIndex] = data;
            } else {
                loggedSets[exerciseId].push(data);
            }
            
            // Update workout progress
            updateWorkoutProgress();
            
            // Update the set header to show it's completed
            const exercise = workoutData.series.flatMap(s => s.exercises).find(ex => ex.exercise_id === exerciseId);
            if (exercise) {
                const setHeader = document.querySelector(`th:has(+ th):nth-child(${setNumber + 1})`);
                // Find the correct header by traversing the table
                const card = document.querySelector(`#overall-rpe-${exerciseId}`)?.closest('.card');
                if (card) {
                    const table = card.querySelector('.desktop-sets-table table');
                    if (table) {
                        const headers = table.querySelectorAll('thead th');
                        if (headers[setNumber]) {
                            headers[setNumber].classList.add('text-success');
                            if (!headers[setNumber].querySelector('.bi-check-circle-fill')) {
                                headers[setNumber].innerHTML += ` <i class="bi bi-check-circle-fill"></i>`;
                            }
                        }
                    }
                }
                
                // Check if all sets complete
                const numSets = exercise.sets;
                if (loggedSets[exerciseId].length === numSets) {
                    promptOverallFeeling(exerciseId);
                } else if (setNumber < numSets) {
                    // Start rest timer if not the last set
                    const restTime = exercise.rest_time_seconds || 0;
                    console.log(`Desktop view: Starting rest timer for ${restTime} seconds`);
                    if (restTime > 0) {
                        startRestTimer(restTime);
                    }
                }
            }
        } else {
            throw new Error('Failed to log set');
        }
    } catch (error) {
        console.error('Error logging set:', error);
        alert('Error logging set. Please try again.');
    }
}

// Initialize weight colors for all inputs with existing values
function initializeWeightColors() {
    // Find all weight inputs across all views
    const allWeightInputs = document.querySelectorAll('input[id^="weight-"]');
    
    allWeightInputs.forEach(input => {
        // Extract exercise ID and set number from the input ID
        const idParts = input.id.split('-');
        let viewType, exerciseId, setNumber;
        
        if (input.id.startsWith('weight-carousel-')) {
            // Format: weight-carousel-{exerciseId}-{setNumber}
            viewType = 'carousel';
            exerciseId = idParts[2];
            setNumber = idParts[3];
        } else if (input.id.startsWith('weight-mobile-')) {
            // Format: weight-mobile-{exerciseId}-{setNumber}
            viewType = 'mobile';
            exerciseId = idParts[2];
            setNumber = idParts[3];
        } else {
            // Format: weight-{exerciseId}-{setNumber}
            viewType = 'desktop';
            exerciseId = idParts[1];
            setNumber = idParts[2];
        }
        
        // Only update color if there's an actual value
        if (input.value) {
            updateWeightColor(input, exerciseId, setNumber, viewType);
        }
    });
}

// Update weight input color based on comparison with suggested weight
function updateWeightColor(inputElement, exerciseId, setNumber, viewType) {
    const currentValue = parseFloat(inputElement.value);
    const suggestedWeight = parseFloat(inputElement.dataset.suggested);
    
    // Remove all color classes
    inputElement.classList.remove('weight-input-same', 'weight-input-more', 'weight-input-less');
    
    // If no value or no suggested weight, don't apply any color
    if (!currentValue || !suggestedWeight) {
        return;
    }
    
    // Compare and apply appropriate color class
    if (currentValue === suggestedWeight) {
        inputElement.classList.add('weight-input-same'); // Muted green
    } else if (currentValue > suggestedWeight) {
        inputElement.classList.add('weight-input-more'); // Muted purple
    } else {
        inputElement.classList.add('weight-input-less'); // Muted red
    }
}

function applySuggestedWeight(exerciseId, setNumber, suggestedWeight) {
    const weightInput = document.getElementById(`weight-${exerciseId}-${setNumber}`);
    if (weightInput) {
        weightInput.value = suggestedWeight;
        // Update color based on comparison
        updateWeightColor(weightInput, exerciseId, setNumber, 'desktop');
        // Brief visual feedback
        weightInput.classList.add('border-success');
        setTimeout(() => {
            weightInput.classList.remove('border-success');
        }, 500);
    }
}

// Mobile-specific functions
function toggleSetAccordion(exerciseId, setNumber) {
    const body = document.getElementById(`body-${exerciseId}-${setNumber}`);
    const icon = document.getElementById(`icon-${exerciseId}-${setNumber}`);
    
    if (body.classList.contains('expanded')) {
        body.classList.remove('expanded');
        icon.classList.remove('expanded');
    } else {
        body.classList.add('expanded');
        icon.classList.add('expanded');
    }
}

function applySuggestedWeightMobile(exerciseId, setNumber, suggestedWeight) {
    const weightInput = document.getElementById(`weight-mobile-${exerciseId}-${setNumber}`);
    if (weightInput) {
        weightInput.value = suggestedWeight;
        // Update color based on comparison
        updateWeightColor(weightInput, exerciseId, setNumber, 'mobile');
        // Brief visual feedback
        weightInput.classList.add('border-success');
        setTimeout(() => {
            weightInput.classList.remove('border-success');
        }, 500);
    }
}

function setRpeMobile(exerciseId, setNumber, rpeValue) {
    // Update hidden input
    const rpeInput = document.getElementById(`rpe-mobile-${exerciseId}-${setNumber}`);
    if (rpeInput) {
        rpeInput.value = rpeValue;
    }
    
    // Update button styles using shared helper
    updateRpeButtons('rpe-mobile-btn', exerciseId, setNumber, rpeValue);
}

async function logSingleSetMobile(exerciseId, setNumber, restTime) {
    const weight = parseFloat(document.getElementById(`weight-mobile-${exerciseId}-${setNumber}`)?.value);
    const reps = parseInt(document.getElementById(`reps-mobile-${exerciseId}-${setNumber}`)?.value);
    const rpeInput = document.getElementById(`rpe-mobile-${exerciseId}-${setNumber}`);
    const rpe = rpeInput?.value || null;
    
    if (!weight || !reps) {
        alert('Please enter both weight and reps.');
        return;
    }
    
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/log-set`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                exercise_id: exerciseId,
                set_number: setNumber,
                weight: weight,
                reps: reps,
                rpe: rpe
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update logged sets
            if (!loggedSets[exerciseId]) {
                loggedSets[exerciseId] = [];
            }
            const existingIndex = loggedSets[exerciseId].findIndex(s => s.set_number === setNumber);
            if (existingIndex >= 0) {
                loggedSets[exerciseId][existingIndex] = data;
            } else {
                loggedSets[exerciseId].push(data);
            }
            
            // Update workout progress
            updateWorkoutProgress();
            
            // Update UI for completion
            updateExerciseCompletionUI(exerciseId);
            
            // Update accordion item to show as completed
            const accordionItem = document.getElementById(`accordion-${exerciseId}-${setNumber}`);
            const header = accordionItem.querySelector('.set-accordion-header');
            const body = accordionItem.querySelector('.set-accordion-body');
            const icon = accordionItem.querySelector('.set-accordion-icon');
            
            // Mark as completed
            header.classList.remove('current');
            header.classList.add('completed');
            
            // Update title with checkmark and summary
            const titleDiv = header.querySelector('div');
            titleDiv.innerHTML = `
                <div>
                    <div class="set-accordion-title">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        <span>Set ${setNumber}</span>
                    </div>
                    <div class="set-accordion-summary">
                        ${weight} lbs × ${reps} reps${rpe ? ' @ RPE ' + rpe : ''}
                    </div>
                </div>
            `;
            
            // Update button to Edit button
            const logBtn = body.querySelector('.mobile-save-set-btn');
            if (logBtn) {
                logBtn.id = `edit-btn-mobile-${exerciseId}-${setNumber}`;
                logBtn.className = 'btn btn-warning mobile-save-set-btn';
                logBtn.innerHTML = `<i class="cil-pencil"></i> Edit Set ${setNumber}`;
                logBtn.setAttribute('onclick', `enableEditMobile(${exerciseId}, ${setNumber})`);
            }
            
            // Remove editing mode class if present
            accordionItem.classList.remove('editing-mode');
            
            // Collapse this set
            body.classList.remove('expanded');
            icon.classList.remove('expanded');
            
            // Find and expand next set
            const exercise = getExerciseData(exerciseId);
            if (exercise) {
                const numSets = exercise.sets;
                if (setNumber < numSets) {
                    const nextBody = document.getElementById(`body-${exerciseId}-${setNumber + 1}`);
                    const nextIcon = document.getElementById(`icon-${exerciseId}-${setNumber + 1}`);
                    const nextHeader = document.getElementById(`accordion-${exerciseId}-${setNumber + 1}`)?.querySelector('.set-accordion-header');
                    
                    if (nextBody && nextIcon && nextHeader) {
                        nextBody.classList.add('expanded');
                        nextIcon.classList.add('expanded');
                        nextHeader.classList.add('current');
                        
                        // Scroll to next set
                        setTimeout(() => {
                            nextHeader.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 200);
                    }
                }
                
                // Check if all sets are complete for this exercise
                const allSetsLogged = loggedSets[exerciseId] && loggedSets[exerciseId].length === numSets;
                if (allSetsLogged) {
                    // Show overall feeling prompt
                    setTimeout(() => {
                        promptOverallFeeling(exerciseId);
                    }, 500);
                }
            }
            
            // Start rest timer
            if (restTime > 0 && setNumber < exercise.sets) {
                startRestTimer(restTime);
            }
            
        } else {
            throw new Error('Failed to log set');
        }
    } catch (error) {
        console.error('Error logging set:', error);
        alert('Error logging set. Please try again.');
    }
}

function enableEditMobile(exerciseId, setNumber) {
    // Change Edit button to Update button
    const editBtn = document.getElementById(`edit-btn-mobile-${exerciseId}-${setNumber}`);
    if (editBtn) {
        editBtn.innerHTML = '<i class="bi bi-check-lg"></i> Update Set ' + setNumber;
        editBtn.classList.remove('btn-warning');
        editBtn.classList.add('btn-custom-teal');
        editBtn.setAttribute('id', `log-btn-mobile-${exerciseId}-${setNumber}`);
        editBtn.setAttribute('onclick', `logSingleSetMobile(${exerciseId}, ${setNumber}, 0)`);
    }
    
    // Show visual feedback that editing is enabled
    const accordionItem = document.getElementById(`accordion-${exerciseId}-${setNumber}`);
    if (accordionItem) {
        accordionItem.classList.add('editing-mode');
    }
}

function promptOverallFeeling(exerciseId) {
    // Store the exercise ID for later use
    currentOverallFeelingExerciseId = exerciseId;
    
    // Get exercise name
    const exercise = getExerciseData(exerciseId);
    const exerciseName = exercise ? exercise.exercise_name : 'Exercise';
    
    // Update modal content
    document.getElementById('overallFeelingExerciseName').textContent = exerciseName;
    
    // Scroll to overall feeling section
    const overallSection = document.querySelector(`#overall-rpe-${exerciseId}`)?.closest('.border-top');
    if (overallSection) {
        overallSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Highlight briefly
        overallSection.style.backgroundColor = '#fff3cd';
        setTimeout(() => {
            overallSection.style.backgroundColor = '';
        }, 2000);
    }
    
    // Show modal
    setTimeout(() => {
        overallFeelingModal.show();
    }, 300);
}

function selectOverallFeeling(rpeValue) {
    if (currentOverallFeelingExerciseId) {
        setOverallRpe(currentOverallFeelingExerciseId, rpeValue);
        overallFeelingModal.hide();
        currentOverallFeelingExerciseId = null;
    }
}

// Carousel mode functions
function toggleMobileView(exerciseId) {
    const carouselView = document.querySelector(`#carousel-${exerciseId}`)?.closest('.mobile-sets-carousel');
    const accordionView = document.getElementById(`accordion-view-${exerciseId}`);
    const toggleBtn = document.getElementById(`toggle-view-${exerciseId}`);
    
    if (carouselView && accordionView && toggleBtn) {
        const isCarouselVisible = carouselView.style.display !== 'none';
        
        if (isCarouselVisible) {
            // Switch to accordion (show all)
            carouselView.style.display = 'none';
            accordionView.style.display = 'block';
            accordionView.classList.add('active');
            toggleBtn.innerHTML = '<i class="bi bi-arrow-left"></i>';
            toggleBtn.title = 'One at a time';
        } else {
            // Switch to carousel (one at a time)
            carouselView.style.display = 'block';
            accordionView.style.display = 'none';
            accordionView.classList.remove('active');
            toggleBtn.innerHTML = '<i class="bi bi-grid-3x3"></i>';
            toggleBtn.title = 'Show all sets';
        }
    }
}

function navigateCarousel(exerciseId, setNumber) {
    const exercise = getExerciseData(exerciseId);
    if (!exercise) return;
    
    const logged = loggedSets[exerciseId] || [];
    const numSets = exercise.sets;
    
    // Bounds check: ensure setNumber is within valid range
    if (setNumber < 1) setNumber = 1;
    if (setNumber > numSets) setNumber = numSets;
    
    const carousel = document.getElementById(`carousel-${exerciseId}`);
    
    if (carousel) {
        carousel.innerHTML = renderCarouselSet(exercise, setNumber, logged);
        
        // Update the set progress badge in the card header
        const progressBadge = document.getElementById(`set-progress-badge-${exerciseId}`);
        if (progressBadge) {
            progressBadge.innerHTML = `Set <span style="font-size: 1.6em; font-weight: 900;">${setNumber}</span> of ${exercise.sets}`;
            // Update colors based on set number
            const colors = getSetProgressColor(setNumber);
            progressBadge.style.backgroundColor = colors.bg;
            progressBadge.style.color = colors.text;
        }
    }
}

function applyWeightCarousel(exerciseId, setNumber, weight) {
    const input = document.getElementById(`weight-carousel-${exerciseId}-${setNumber}`);
    if (input) {
        input.value = weight;
        // Update color based on comparison
        updateWeightColor(input, exerciseId, setNumber, 'carousel');
        input.classList.add('border-success');
        setTimeout(() => input.classList.remove('border-success'), 500);
    }
}

function setRpeCarousel(exerciseId, setNumber, rpeValue) {
    const rpeInput = document.getElementById(`rpe-carousel-${exerciseId}-${setNumber}`);
    if (rpeInput) {
        rpeInput.value = rpeValue;
    }
    
    // Update button styles using shared helper
    updateRpeButtons('rpe-carousel-btn', exerciseId, setNumber, rpeValue);
}

async function logSetCarousel(exerciseId, setNumber, restTime) {
    const weight = parseFloat(document.getElementById(`weight-carousel-${exerciseId}-${setNumber}`)?.value);
    const reps = parseInt(document.getElementById(`reps-carousel-${exerciseId}-${setNumber}`)?.value);
    const rpeInput = document.getElementById(`rpe-carousel-${exerciseId}-${setNumber}`);
    const rpe = rpeInput?.value || null;
    
    if (!weight || !reps) {
        alert('Please enter both weight and reps.');
        return;
    }
    
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/log-set`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                exercise_id: exerciseId,
                set_number: setNumber,
                weight: weight,
                reps: reps,
                rpe: rpe
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update logged sets
            if (!loggedSets[exerciseId]) {
                loggedSets[exerciseId] = [];
            }
            const existingIndex = loggedSets[exerciseId].findIndex(s => s.set_number === setNumber);
            if (existingIndex >= 0) {
                loggedSets[exerciseId][existingIndex] = data;
            } else {
                loggedSets[exerciseId].push(data);
            }
            
            // Update workout progress
            updateWorkoutProgress();
            
            // Update UI
            updateExerciseCompletionUI(exerciseId);
            
            const exercise = getExerciseData(exerciseId);
            if (exercise) {
                const numSets = exercise.sets;
                
                // Remove editing mode class
                const carouselItem = document.querySelector(`.carousel-item[data-exercise-id="${exerciseId}"][data-set-number="${setNumber}"]`);
                if (carouselItem) {
                    carouselItem.classList.remove('editing-mode');
                }
                
                // Check if all sets complete
                if (loggedSets[exerciseId].length === numSets) {
                    promptOverallFeeling(exerciseId);
                } else if (setNumber < numSets) {
                    // Move to next set
                    setTimeout(() => {
                        navigateCarousel(exerciseId, setNumber + 1);
                    }, 300);
                    
                    // Start rest timer
                    if (restTime > 0) {
                        startRestTimer(restTime);
                    }
                } else {
                    // Refresh current set to show as completed
                    navigateCarousel(exerciseId, setNumber);
                }
            }
        } else {
            throw new Error('Failed to log set');
        }
    } catch (error) {
        console.error('Error logging set:', error);
        alert('Error logging set. Please try again.');
    }
}

function enableEditCarousel(exerciseId, setNumber) {
    // Change Edit button to Update button
    const editBtn = document.getElementById(`edit-btn-carousel-${exerciseId}-${setNumber}`);
    if (editBtn) {
        editBtn.innerHTML = '<i class="cil-check"></i> Update Set';
        editBtn.classList.remove('btn-warning');
        editBtn.classList.add('btn-custom-teal');
        editBtn.setAttribute('onclick', `logSetCarousel(${exerciseId}, ${setNumber})`);
    }
    
    // Show visual feedback that editing is enabled
    const carouselItem = document.querySelector(`.carousel-item[data-exercise-id="${exerciseId}"][data-set-number="${setNumber}"]`);
    if (carouselItem) {
        carouselItem.classList.add('editing-mode');
    }
}

function setOverallRpe(exerciseId, rpeValue) {
    const exercise = getExerciseData(exerciseId);
    if (!exercise) return;
    
    const numSets = exercise.sets;
    const logged = loggedSets[exerciseId] || [];
    
    // Check if all sets are logged
    if (logged.length !== numSets) {
        alert(`Please log all sets before selecting overall feeling.\n\nYou have logged ${logged.length} of ${numSets} sets.`);
        return;
    }
    
    // Update hidden input
    const overallRpeInput = document.getElementById(`overall-rpe-${exerciseId}`);
    if (overallRpeInput) {
        overallRpeInput.value = rpeValue;
    }
    
    // Just save overall RPE (sets already logged)
    saveOverallRpe(exerciseId, rpeValue);
}

async function logAllSetsForExercise(exerciseId, setsToLog, overallRpe, restTime) {
    try {
        // Log each set
        for (const setData of setsToLog) {
            const response = await fetch(`/workout/api/session/${sessionId}/log-set`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    exercise_id: exerciseId,
                    set_number: setData.set_number,
                    weight: setData.weight,
                    reps: setData.reps,
                    rpe: setData.rpe
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update logged sets
                if (!loggedSets[exerciseId]) {
                    loggedSets[exerciseId] = [];
                }
                const existingIndex = loggedSets[exerciseId].findIndex(s => s.set_number === setData.set_number);
                if (existingIndex >= 0) {
                    loggedSets[exerciseId][existingIndex] = data;
                } else {
                    loggedSets[exerciseId].push(data);
                }
            } else {
                throw new Error('Failed to log set');
            }
        }
        
        // Now save overall RPE
        await saveOverallRpe(exerciseId, overallRpe);
        
        // Update workout progress
        updateWorkoutProgress();
        
        // Show logged indicator
        const cardHeader = document.querySelector(`#logged-badge-${exerciseId}`);
        if (!cardHeader) {
            // Add badge if it doesn't exist
            const exerciseCard = document.querySelector(`#overall-rpe-${exerciseId}`)?.closest('.card');
            if (exerciseCard) {
                const header = exerciseCard.querySelector('.card-header > div');
                if (header) {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-custom-teal me-2';
                    badge.id = `logged-badge-${exerciseId}`;
                    badge.textContent = '✓ Logged';
                    header.prepend(badge);
                }
            }
        }
        
        // Start rest timer after completing exercise
        if (restTime > 0) {
            startRestTimer(restTime);
        }
        
    } catch (error) {
        console.error('Error logging exercise:', error);
        alert('Error logging exercise. Please try again.');
    }
}

async function saveOverallRpe(exerciseId, overallRpe) {
    if (!overallRpe) {
        const overallRpeInput = document.getElementById(`overall-rpe-${exerciseId}`);
        overallRpe = overallRpeInput?.value;
    }
    
    if (!overallRpe) {
        alert('Please select how the exercise felt overall');
        return;
    }
    
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/overall-rpe`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                exercise_id: exerciseId,
                overall_rpe: overallRpe
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update logged sets with overall RPE
            if (loggedSets[exerciseId] && loggedSets[exerciseId].length > 0) {
                loggedSets[exerciseId][0].overall_rpe = overallRpe;
            }
            
            // Visual feedback - re-render to show updated button styles
            loadWorkoutData();
            
            // Brief success message
            const btn = document.getElementById(`overall-rpe-btn-${exerciseId}-${overallRpe}`);
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '✓ Saved!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 1500);
            }
        }
    } catch (error) {
        console.error('Error saving overall RPE:', error);
        alert('Error saving feeling. Please try again.');
    }
}

function startRestTimer(seconds) {
    // Check if rest timer is disabled
    if (skipRests) {
        console.log('Rest timer skipped by user preference');
        return;
    }
    
    const totalSeconds = seconds;
    let remaining = seconds;
    
    const modalElement = document.getElementById('restTimerModal');
    const countdown = document.getElementById('restTimerCountdown');
    const progress = document.getElementById('restTimerProgress');
    
    restTimerModal.show();
    
    if (restTimerInterval) {
        clearInterval(restTimerInterval);
    }
    
    restTimerInterval = setInterval(() => {
        remaining--;
        const minutes = Math.floor(remaining / 60);
        const secs = remaining % 60;
        countdown.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
        
        const percentRemaining = (remaining / totalSeconds) * 100;
        progress.style.width = `${percentRemaining}%`;
        
        if (remaining <= 0) {
            clearInterval(restTimerInterval);
            restTimerModal.hide();
            // Play sound or notification
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
        }
    }, 1000);
}

function skipRestTimer() {
    if (restTimerInterval) {
        clearInterval(restTimerInterval);
    }
    restTimerModal.hide();
}

function showPreviousSets(exerciseId) {
    const exercise = workoutData.series
        .flatMap(s => s.exercises)
        .find(ex => ex.exercise_id === exerciseId);
    
    if (!exercise || !exercise.previous_sets) return;
    
    let html = `<h6>${exercise.exercise_name}</h6>`;
    html += `<table class="table table-sm">`;
    html += `<thead><tr><th>Date</th><th>Set</th><th>Weight</th><th>Reps</th><th>RPE</th></tr></thead>`;
    html += `<tbody>`;
    
    exercise.previous_sets.forEach(set => {
        html += `<tr>`;
        html += `<td>${set.date}</td>`;
        html += `<td>${set.set_number}</td>`;
        html += `<td>${set.weight} lbs</td>`;
        html += `<td>${set.reps}</td>`;
        html += `<td>${set.rpe || '-'}</td>`;
        html += `</tr>`;
    });
    
    html += `</tbody></table>`;
    
    document.getElementById('previousSetsContent').innerHTML = html;
    new coreui.Modal(document.getElementById('previousSetsModal')).show();
}

async function finishWorkout() {
    // Check if all exercises have overall RPE set (for scheduled workouts)
    if (workoutData && !workoutData.is_standalone && workoutData.series) {
        const missingRpe = [];
        
        workoutData.series.forEach(series => {
            series.exercises.forEach(exercise => {
                const hasLoggedSets = loggedSets[exercise.exercise_id] && loggedSets[exercise.exercise_id].length > 0;
                if (hasLoggedSets) {
                    const hasOverallRpe = loggedSets[exercise.exercise_id].some(s => s.overall_rpe);
                    if (!hasOverallRpe) {
                        missingRpe.push(exercise.exercise_name);
                    }
                }
            });
        });
        
        if (missingRpe.length > 0) {
            // Show warning in modal
            const warningDiv = document.getElementById('finishWorkoutWarning');
            const listDiv = document.getElementById('missingRpeList');
            listDiv.innerHTML = missingRpe.map(name => `<li>${name}</li>`).join('');
            warningDiv.style.display = 'block';
        } else {
            // Hide warning if all RPEs are set
            document.getElementById('finishWorkoutWarning').style.display = 'none';
        }
    } else {
        // Hide warning for standalone workouts
        document.getElementById('finishWorkoutWarning').style.display = 'none';
    }
    
    // Clear notes field
    document.getElementById('workoutNotes').value = '';
    
    // Show modal
    finishWorkoutModal.show();
}

async function confirmFinishWorkout() {
    // Save final duration before completing
    const finalDuration = Math.floor((new Date() - workoutStartTime) / 1000);
    try {
        await fetch(`/workout/api/session/${sessionId}/update-duration`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ duration_seconds: finalDuration })
        });
    } catch (error) {
        console.error('Error saving final duration:', error);
    }
    const notes = document.getElementById('workoutNotes').value;
    
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/complete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: notes || '' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            clearInterval(timerInterval);
            clearInterval(durationSaveInterval);  // Stop periodic duration saves
            releaseWakeLock();  // Release wake lock when workout is finished
            finishWorkoutModal.hide();
            
            // Show success message briefly before redirect
            const modalBody = document.querySelector('#finishWorkoutModal .modal-body');
            const originalContent = modalBody.innerHTML;
            modalBody.innerHTML = '<div class="text-center py-4"><h4 class="text-success"><i class="bi bi-check-circle-fill"></i> Workout Completed!</h4><p>Great job! 💪</p></div>';
            
            setTimeout(() => {
                window.location.href = '/calendar';
            }, 1500);
        }
    } catch (error) {
        console.error('Error completing workout:', error);
        alert('Error completing workout. Please try again.');
    }
}

// Standalone workout functions
async function searchExercises() {
    const query = document.getElementById('exerciseSearchInput').value;
    
    try {
        const response = await fetch(`/workout/api/exercises/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        let html = '<div class="list-group">';
        data.exercises.forEach(ex => {
            html += `<button class="list-group-item list-group-item-action" `;
            html += `onclick="addExerciseToWorkout(${ex.id}, '${ex.name}')">`;
            html += `${ex.name} <small class="text-muted">(${ex.category})</small>`;
            html += `</button>`;
        });
        html += '</div>';
        
        document.getElementById('exerciseSearchResults').innerHTML = html;
    } catch (error) {
        console.error('Error searching exercises:', error);
    }
}

function addExerciseToWorkout(exerciseId, exerciseName) {
    // TODO: Implement adding exercise to standalone workout
    alert(`Adding ${exerciseName} to workout - feature coming soon!`);
}

// Skip/Unskip exercise functions
function confirmSkipExercise(exerciseId) {
    const exercise = getExerciseData(exerciseId);
    if (!exercise) return;
    
    // Set the exercise name in the modal
    document.getElementById('skipExerciseName').textContent = exercise.exercise_name;
    
    // Store the exercise ID for when user confirms
    pendingSkipExerciseId = exerciseId;
    
    // Show the modal
    skipExerciseModal.show();
}

function doSkipExercise() {
    if (pendingSkipExerciseId !== null) {
        // Hide the modal
        skipExerciseModal.hide();
        
        // Skip the exercise
        skipExercise(pendingSkipExerciseId, '');
        
        // Clear pending ID
        pendingSkipExerciseId = null;
    }
}

async function skipExercise(exerciseId, reason) {
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/skip-exercise`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ exercise_id: exerciseId, reason: reason })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update local state
            skippedExercises[exerciseId] = { reason: reason, skipped_at: data.skipped_at };
            
            // Update just this exercise card instead of re-rendering everything
            const card = document.getElementById(`card-${exerciseId}`);
            if (card) {
                card.classList.add('skipped');
                
                // Find and update the badge area
                const badgeArea = card.querySelector('.card-header > div');
                if (badgeArea) {
                    // Remove progress badge if exists
                    const progressBadge = document.getElementById(`set-progress-badge-${exerciseId}`);
                    if (progressBadge) progressBadge.remove();
                    
                    // Remove logged badge if exists
                    const loggedBadge = document.getElementById(`logged-badge-${exerciseId}`);
                    if (loggedBadge) loggedBadge.remove();
                    
                    // Add skipped badge
                    const skippedBadge = document.createElement('span');
                    skippedBadge.className = 'badge badge-skipped';
                    skippedBadge.id = `skipped-badge-${exerciseId}`;
                    skippedBadge.textContent = 'Skipped';
                    badgeArea.insertBefore(skippedBadge, badgeArea.firstChild);
                    
                    // Update skip button to un-skip button
                    const skipBtn = badgeArea.querySelector('button[onclick*="confirmSkipExercise"]');
                    if (skipBtn) {
                        skipBtn.className = 'btn btn-sm btn-warning';
                        skipBtn.setAttribute('onclick', `unskipExercise(${exerciseId})`);
                        skipBtn.title = 'Un-skip exercise';
                        skipBtn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i>';
                    }
                }
            }
            
            // Update progress
            updateWorkoutProgress();
        } else {
            alert('Error skipping exercise: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error skipping exercise:', error);
        alert('Error skipping exercise. Please try again.');
    }
}

async function unskipExercise(exerciseId) {
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/unskip-exercise`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ exercise_id: exerciseId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update local state
            delete skippedExercises[exerciseId];
            
            // Update just this exercise card instead of re-rendering everything
            const card = document.getElementById(`card-${exerciseId}`);
            if (card) {
                card.classList.remove('skipped');
                
                // Find and update the badge area
                const badgeArea = card.querySelector('.card-header > div');
                if (badgeArea) {
                    // Remove skipped badge
                    const skippedBadge = document.getElementById(`skipped-badge-${exerciseId}`);
                    if (skippedBadge) skippedBadge.remove();
                    
                    // Re-add progress badge
                    const exercise = getExerciseData(exerciseId);
                    if (exercise) {
                        const logged = loggedSets[exerciseId] || [];
                        let firstIncompleteSet = 1;
                        for (let setNum = 1; setNum <= exercise.sets; setNum++) {
                            if (!logged.find(s => s.set_number === setNum)) {
                                firstIncompleteSet = setNum;
                                break;
                            }
                        }
                        
                        const progressColors = getSetProgressColor(firstIncompleteSet);
                        const progressBadge = document.createElement('span');
                        progressBadge.className = 'badge mobile-only';
                        progressBadge.id = `set-progress-badge-${exerciseId}`;
                        progressBadge.style.fontSize = '0.875rem';
                        progressBadge.style.backgroundColor = progressColors.bg;
                        progressBadge.style.color = progressColors.text;
                        progressBadge.textContent = `Set ${firstIncompleteSet} of ${exercise.sets}`;
                        badgeArea.insertBefore(progressBadge, badgeArea.firstChild);
                    }
                    
                    // Update un-skip button back to skip button
                    const unskipBtn = badgeArea.querySelector('button[onclick*="unskipExercise"]');
                    if (unskipBtn) {
                        unskipBtn.className = 'btn btn-sm btn-outline-light';
                        unskipBtn.setAttribute('onclick', `confirmSkipExercise(${exerciseId})`);
                        unskipBtn.title = 'Skip exercise';
                        unskipBtn.innerHTML = '<i class="bi bi-skip-forward"></i>';
                    }
                }
            }
            
            // Update progress
            updateWorkoutProgress();
        } else {
            alert('Error un-skipping exercise: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error un-skipping exercise:', error);
        alert('Error un-skipping exercise. Please try again.');
    }
}
</script>
{% endblock %}
