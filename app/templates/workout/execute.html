{% extends "base.html" %}

{% block title %}Workout{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div class="container-fluid px-2 py-3" id="workoutApp">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0" id="workoutTitle">Loading...</h4>
                    <small class="text-muted" id="workoutSubtitle"></small>
                </div>
                <div>
                    <span id="workoutProgress" class="badge bg-info fs-6 me-2">0 / 0 exercises</span>
                    <span id="timerDisplay" class="badge bg-secondary fs-6 me-2">0:00</span>
                    <button class="btn btn-sm btn-danger" onclick="finishWorkout()">
                        <i class="bi bi-check-circle"></i> Finish
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rest Timer Modal -->
    <div class="modal fade" id="restTimerModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rest Timer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="display-1 fw-bold mb-3" id="restTimerCountdown">0:00</div>
                    <div class="progress mb-3" style="height: 30px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="restTimerProgress" 
                             role="progressbar" 
                             style="width: 100%"></div>
                    </div>
                    <button class="btn btn-primary btn-lg" onclick="skipRestTimer()">
                        <i class="bi bi-skip-forward"></i> Skip Rest
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Workout Content -->
    <div id="workoutContent">
        <!-- Will be populated by JavaScript -->
    </div>

    <!-- Add Exercise (for standalone workouts) -->
    <div class="card mt-3" id="addExerciseCard" style="display: none;">
        <div class="card-body">
            <h5 class="card-title">Add Exercise</h5>
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="exerciseSearchInput" 
                       placeholder="Search exercises...">
                <button class="btn btn-outline-secondary" onclick="searchExercises()">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <div id="exerciseSearchResults"></div>
        </div>
    </div>

    <!-- Bottom Timer & Finish Button -->
    <div class="row mt-4 mb-3">
        <div class="col">
            <div class="d-flex justify-content-center align-items-center gap-3">
                <span id="workoutProgressBottom" class="badge bg-info fs-6">0 / 0 exercises</span>
                <span id="timerDisplayBottom" class="badge bg-secondary fs-6">0:00</span>
                <button class="btn btn-danger" onclick="finishWorkout()">
                    <i class="bi bi-check-circle"></i> Finish Workout
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Previous Sets Modal -->
<div class="modal fade" id="previousSetsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Previous Sets</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previousSetsContent">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<style>
.exercise-card {
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.set-row {
    padding: 0.75rem;
    border-bottom: 1px solid #dee2e6;
    background-color: #fff;
}

.set-row:last-child {
    border-bottom: none;
}

.set-row.completed {
    background-color: #d1e7dd;
}

.set-input {
    width: 70px;
    padding: 0.375rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    text-align: center;
}

.set-number {
    font-weight: bold;
    font-size: 1.1rem;
    min-width: 40px;
}

.btn-log-set {
    min-width: 80px;
}

.previous-indicator {
    font-size: 0.85rem;
    color: #6c757d;
    font-style: italic;
}

.superset-badge {
    background-color: #ffc107;
    color: #000;
}

/* Mobile View Styles */
@media (max-width: 767px) {
    /* Hide table view on mobile */
    .desktop-sets-table {
        display: none !important;
    }
    
    /* Toggle button */
    .mobile-view-toggle {
        margin-bottom: 1rem;
    }
    
    .mobile-view-toggle button {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        font-weight: 600;
        min-height: 44px;
    }
    
    /* One at a time carousel (default) */
    .mobile-sets-carousel {
        display: block !important;
    }
    
    .mobile-sets-carousel.hidden {
        display: none !important;
    }
    
    .carousel-set-header {
        text-align: left;
        padding: 0.25rem;
        margin-bottom: 0.5rem;
    }
    
    .carousel-set-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0;
    }
    
    .carousel-set-subtitle {
        font-size: 0.85rem;
        color: #198754;
        font-weight: 600;
    }
    
    .carousel-input-row {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
        gap: 0.75rem;
    }
    
    .carousel-input-label {
        font-weight: 600;
        font-size: 1rem;
        min-width: 90px;
        flex-shrink: 0;
    }
    
    .carousel-input-label small {
        display: block;
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: normal;
    }
    
    .carousel-input-field {
        flex: 1;
        display: flex;
        gap: 0.5rem;
    }
    
    .carousel-input-field input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        font-size: 1rem;
        min-height: 44px;
    }
    
    .carousel-input-field button {
        padding: 0.75rem 1rem;
        min-height: 44px;
        white-space: nowrap;
    }
    
    .carousel-rpe-buttons {
        display: flex;
        gap: 0.5rem;
        flex: 1;
    }
    
    .carousel-rpe-buttons button {
        flex: 1;
        min-height: 38px;
        font-size: 0.95rem;
        font-weight: 600;
    }
    
    .carousel-rpe-row {
        display: flex;
        gap: 0.75rem;
        align-items: stretch;
    }
    
    .carousel-log-btn {
        min-height: 38px;
        font-size: 0.95rem;
        font-weight: 600;
        min-width: 120px;
        flex-shrink: 0;
    }
    
    .carousel-navigation {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #dee2e6;
    }
    
    .carousel-navigation button {
        flex: 1;
        min-height: 36px;
        font-size: 0.85rem;
    }
    
    .carousel-navigation button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    /* Mobile accordion container (show all mode) */
    .mobile-sets-accordion {
        display: none !important;
    }
    
    .mobile-sets-accordion.active {
        display: block !important;
    }
    
    .set-accordion-item {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        background: #fff;
    }
    
    .set-accordion-header {
        padding: 0.75rem 1rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
        border-radius: 0.375rem;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    .set-accordion-header.completed {
        background: #d1e7dd;
    }
    
    .set-accordion-header.current {
        background: #fff3cd;
        border: 2px solid #ffc107;
    }
    
    .set-accordion-item.editing-mode {
        border: 2px solid #fd7e14;
        box-shadow: 0 0 0 0.2rem rgba(253, 126, 20, 0.25);
    }
    
    .carousel-item.editing-mode {
        box-shadow: 0 0 0 0.25rem rgba(253, 126, 20, 0.25);
    }
    
    .set-accordion-title {
        font-weight: 600;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .set-accordion-summary {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .set-accordion-icon {
        transition: transform 0.2s;
        font-size: 1.2rem;
    }
    
    .set-accordion-icon.expanded {
        transform: rotate(180deg);
    }
    
    .set-accordion-body {
        padding: 1rem;
        display: none;
    }
    
    .set-accordion-body.expanded {
        display: block;
    }
    
    .mobile-set-input-group {
        margin-bottom: 1rem;
    }
    
    .mobile-set-input-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }
    
    .mobile-set-input-group input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        font-size: 1rem;
    }
    
    .mobile-set-input-group .input-with-button {
        display: flex;
        gap: 0.5rem;
    }
    
    .mobile-set-input-group .input-with-button input {
        flex: 1;
    }
    
    .mobile-set-input-group .input-with-button button {
        padding: 0.75rem 1rem;
        min-height: 44px;
    }
    
    .mobile-rpe-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: space-between;
    }
    
    .mobile-rpe-buttons button {
        flex: 1;
        min-height: 38px;
        font-size: 0.95rem;
        font-weight: 600;
    }
    
    .mobile-save-set-btn {
        width: 100%;
        min-height: 50px;
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 1rem;
    }
}

/* Desktop: hide mobile accordion */
@media (min-width: 768px) {
    .mobile-sets-accordion {
        display: none !important;
    }
}
</style>

<script>
const sessionId = {{ session.id }};
let workoutData = null;
let loggedSets = {};
let workoutStartTime = new Date();
let timerInterval = null;
let restTimerInterval = null;
let restTimerModal = null;
let wakeLock = null;

// Request wake lock to keep screen on during workout
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake Lock active - screen will stay on');
            
            // Re-request wake lock if visibility changes (e.g., tab switch)
            wakeLock.addEventListener('release', () => {
                console.log('Wake Lock released');
            });
        }
    } catch (err) {
        console.log('Wake Lock not supported or failed:', err);
    }
}

// Release wake lock when leaving page
function releaseWakeLock() {
    if (wakeLock !== null) {
        wakeLock.release()
            .then(() => {
                wakeLock = null;
                console.log('Wake Lock released manually');
            });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    restTimerModal = new coreui.Modal(document.getElementById('restTimerModal'));
    requestWakeLock();  // Keep screen on during workout
    loadWorkoutData();
    startWorkoutTimer();
});

// Re-acquire wake lock when page becomes visible again
document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible') {
        requestWakeLock();
    }
});

// Release wake lock when page is unloaded
window.addEventListener('beforeunload', releaseWakeLock);

function startWorkoutTimer() {
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((new Date() - workoutStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('timerDisplay').textContent = timeString;
        document.getElementById('timerDisplayBottom').textContent = timeString;
    }, 1000);
}

async function loadWorkoutData() {
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/data`);
        workoutData = await response.json();
        loggedSets = workoutData.logged_sets || {};
        
        // Update header
        if (workoutData.is_standalone) {
            document.getElementById('workoutTitle').textContent = 'Standalone Workout';
            document.getElementById('workoutSubtitle').textContent = 
                workoutData.gym_name || 'No gym selected';
            document.getElementById('addExerciseCard').style.display = 'block';
        } else {
            document.getElementById('workoutTitle').textContent = 
                `${workoutData.program_name} - ${workoutData.day_name}`;
            document.getElementById('workoutSubtitle').textContent = 
                `${workoutData.calendar_date} â€¢ ${workoutData.gym_name || 'No gym'}`;
            renderWorkout();
        }
        
        // Update progress indicator
        updateWorkoutProgress();
    } catch (error) {
        console.error('Error loading workout data:', error);
        alert('Error loading workout. Please try again.');
    }
}

function updateWorkoutProgress() {
    if (!workoutData || !workoutData.series) return;
    
    // Count total exercises
    const allExercises = workoutData.series.flatMap(s => s.exercises);
    const totalExercises = allExercises.length;
    
    // Count completed exercises (all sets logged)
    let completedExercises = 0;
    allExercises.forEach(exercise => {
        const logged = loggedSets[exercise.exercise_id] || [];
        if (logged.length === exercise.sets) {
            completedExercises++;
        }
    });
    
    const progressText = `${completedExercises} / ${totalExercises} exercises`;
    const progressTop = document.getElementById('workoutProgress');
    const progressBottom = document.getElementById('workoutProgressBottom');
    
    if (progressTop) {
        progressTop.textContent = progressText;
        // Change color based on completion
        if (completedExercises === totalExercises && totalExercises > 0) {
            progressTop.classList.remove('bg-info', 'bg-warning');
            progressTop.classList.add('bg-success');
        } else if (completedExercises > 0) {
            progressTop.classList.remove('bg-info', 'bg-success');
            progressTop.classList.add('bg-warning');
        } else {
            progressTop.classList.remove('bg-warning', 'bg-success');
            progressTop.classList.add('bg-info');
        }
    }
    
    if (progressBottom) {
        progressBottom.textContent = progressText;
        // Change color based on completion
        if (completedExercises === totalExercises && totalExercises > 0) {
            progressBottom.classList.remove('bg-info', 'bg-warning');
            progressBottom.classList.add('bg-success');
        } else if (completedExercises > 0) {
            progressBottom.classList.remove('bg-info', 'bg-success');
            progressBottom.classList.add('bg-warning');
        } else {
            progressBottom.classList.remove('bg-warning', 'bg-success');
            progressBottom.classList.add('bg-info');
        }
    }
}

function renderWorkout() {
    const container = document.getElementById('workoutContent');
    let html = '';
    
    workoutData.series.forEach((series, seriesIndex) => {
        const isSuperset = series.series_type === 'superset';
        const colors = ['primary', 'success', 'danger', 'warning', 'info'];
        const color = colors[seriesIndex % 5];
        
        if (isSuperset) {
            // Superset - render exercises side by side
            html += `<div class="mb-3"><div class="badge superset-badge mb-2">SUPERSET</div></div>`;
            html += `<div class="row mb-3">`;
            
            series.exercises.forEach((exercise, exIndex) => {
                const exerciseLabel = String.fromCharCode(65 + exIndex);
                html += `<div class="col-md-6 mb-2">`;
                html += renderExerciseCard(exercise, exerciseLabel, color, seriesIndex);
                html += `</div>`;
            });
            
            html += `</div>`;
        } else {
            // Regular exercise
            const exercise = series.exercises[0];
            html += renderExerciseCard(exercise, null, color, seriesIndex);
        }
    });
    
    container.innerHTML = html;
}

function renderCarouselSet(exercise, setNumber, logged) {
    const numSets = exercise.sets;
    const loggedSet = logged.find(s => s.set_number === setNumber);
    const isCompleted = loggedSet !== undefined;
    const suggestedWeight = exercise.suggested_weights[setNumber - 1] || exercise.suggested_weights[0] || '';
    const suggestedReps = exercise.reps || '';
    
    let html = '';
    
    // Header - only show completion info if set is already logged
    if (isCompleted) {
        html += `<div class="carousel-set-header">`;
        html += `<div class="carousel-set-title">`;
        html += `<i class="bi bi-check-circle-fill text-success"></i> Completed`;
        html += `</div>`;
        html += `<div class="carousel-set-subtitle">`;
        html += `${loggedSet.weight}lbs Ã— ${loggedSet.reps} reps${loggedSet.rpe ? ' @ RPE ' + loggedSet.rpe : ''}`;
        html += `</div>`;
        html += `</div>`;
    }    
    
    // Weight
    html += `<div class="carousel-input-row">`;    
    html += `<div class="carousel-input-label">Weight <small>lbs</small></div>`;    
    html += `<div class="carousel-input-field">`;    
    html += `<input type="number" class="form-control" `;    
    html += `id="weight-carousel-${exercise.exercise_id}-${setNumber}" `;    
    html += `placeholder="${suggestedWeight || 'Enter weight'}" `;    
    html += `value="${loggedSet?.weight || ''}" step="0.5">`;    
    if (suggestedWeight) {
        html += `<button type="button" class="btn btn-outline-secondary" `;        
        html += `onclick="applyWeightCarousel(${exercise.exercise_id}, ${setNumber}, ${suggestedWeight})">`;        
        html += `Use ${suggestedWeight}</button>`;        
    }
    html += `</div></div>`;    
    
    // Reps
    html += `<div class="carousel-input-row">`;    
    html += `<div class="carousel-input-label">Reps</div>`;    
    html += `<div class="carousel-input-field">`;    
    html += `<input type="number" class="form-control" `;    
    html += `id="reps-carousel-${exercise.exercise_id}-${setNumber}" `;    
    html += `value="${loggedSet?.reps || suggestedReps}" `;    
    html += `placeholder="${suggestedReps || 'Enter reps'}">`;    
    html += `</div></div>`;    
    
    // RPE + Log button row
    html += `<div class="carousel-input-row">`;    
    html += `<div class="carousel-input-label">RPE <small>optional</small></div>`;    
    html += `<div class="carousel-rpe-row">`;    
    html += `<div class="carousel-rpe-buttons">`;    
    const currentRpe = loggedSet?.rpe || '';
    html += `<button type="button" class="btn ${currentRpe === '-' ? 'btn-danger' : 'btn-outline-danger'}" `;    
    html += `onclick="setRpeCarousel(${exercise.exercise_id}, ${setNumber}, '-')" `;    
    html += `id="rpe-carousel-btn-${exercise.exercise_id}-${setNumber}--">-</button>`;    
    html += `<button type="button" class="btn ${currentRpe === '=' ? 'btn-success' : 'btn-outline-success'}" `;    
    html += `onclick="setRpeCarousel(${exercise.exercise_id}, ${setNumber}, '=')" `;    
    html += `id="rpe-carousel-btn-${exercise.exercise_id}-${setNumber}-=">=</button>`;    
    html += `<button type="button" class="btn ${currentRpe === '+' ? 'btn-primary' : 'btn-outline-primary'}" `;    
    html += `onclick="setRpeCarousel(${exercise.exercise_id}, ${setNumber}, '+')" `;    
    html += `id="rpe-carousel-btn-${exercise.exercise_id}-${setNumber}-+">+</button>`;    
    html += `</div>`;    
    // Log/Update button next to RPE buttons
    if (isCompleted) {
        // Show Edit button when set is logged
        html += `<button type="button" class="btn btn-warning carousel-log-btn" `;    
        html += `onclick="enableEditCarousel(${exercise.exercise_id}, ${setNumber})" `;    
        html += `id="edit-btn-carousel-${exercise.exercise_id}-${setNumber}">`;    
        html += `<i class="bi bi-pencil"></i> Edit`;    
        html += `</button>`;    
    } else {
        // Show Log button when set is not logged
        html += `<button type="button" class="btn btn-success carousel-log-btn" `;    
        html += `onclick="logSetCarousel(${exercise.exercise_id}, ${setNumber}, ${exercise.rest_time_seconds || 0})" `;    
        html += `id="log-btn-carousel-${exercise.exercise_id}-${setNumber}">`;    
        html += `<i class="bi bi-check-lg"></i> Log Set`;    
        html += `</button>`;    
    }
    html += `</div>`;    
    html += `<input type="hidden" id="rpe-carousel-${exercise.exercise_id}-${setNumber}" value="${currentRpe}">`;    
    html += `</div>`;    
    
    // Navigation
    html += `<div class="carousel-navigation">`;    
    html += `<button type="button" class="btn btn-outline-primary" `;    
    html += `onclick="navigateCarousel(${exercise.exercise_id}, ${setNumber - 1})" `;    
    html += `${setNumber <= 1 ? 'disabled' : ''}>`;    
    html += `<i class="bi bi-chevron-left"></i> Previous`;    
    html += `</button>`;    
    html += `<button type="button" class="btn btn-outline-primary" `;    
    html += `onclick="navigateCarousel(${exercise.exercise_id}, ${setNumber + 1})" `;    
    html += `${setNumber >= numSets ? 'disabled' : ''}>`;    
    html += `Next <i class="bi bi-chevron-right"></i>`;    
    html += `</button>`;    
    html += `</div>`;    
    
    return html;
}

function renderExerciseCard(exercise, label, color, seriesIndex) {
    const numSets = exercise.sets;
    const logged = loggedSets[exercise.exercise_id] || [];
    
    // Calculate first incomplete set early (needed for carousel)
    let firstIncompleteSet = 1;
    for (let setNum = 1; setNum <= numSets; setNum++) {
        if (!logged.find(s => s.set_number === setNum)) {
            firstIncompleteSet = setNum;
            break;
        }
        if (setNum === numSets && logged.find(s => s.set_number === setNum)) {
            firstIncompleteSet = numSets + 1; // All complete
        }
    }
    
    let html = `<div class="card exercise-card border-${color} border-3 mb-3">`;
    
    // Header
    html += `<div class="card-header bg-${color} text-white d-flex justify-content-between align-items-center">`;
    html += `<span>${label ? label + '. ' : ''}${exercise.exercise_name}</span>`;
    html += `<div class="d-flex align-items-center gap-2">`;
    // Add Set X of Y badge for mobile carousel view
    html += `<span class="badge bg-light text-dark d-md-none" id="set-progress-badge-${exercise.exercise_id}" style="font-size: 0.875rem;">Set ${firstIncompleteSet} of ${numSets}</span>`;
    if (logged.length > 0) {
        html += `<span class="badge bg-success me-2" id="logged-badge-${exercise.exercise_id}">âœ“ Logged</span>`;
    }
    html += `<button class="btn btn-sm btn-light d-md-none" onclick="toggleMobileView(${exercise.exercise_id})" `;
    html += `id="toggle-view-${exercise.exercise_id}" title="Show all sets">`;
    html += `<i class="bi bi-grid-3x3"></i></button>`;
    if (exercise.previous_sets && exercise.previous_sets.length > 0) {
        html += `<button class="btn btn-sm btn-light" onclick="showPreviousSets(${exercise.exercise_id})">`;
        html += `<i class="bi bi-clock-history"></i></button>`;
    }
    html += `</div>`;
    html += `</div>`;
    
    // Show previous set info if available
    if (exercise.previous_sets && exercise.previous_sets.length > 0) {
        const prev = exercise.previous_sets[0];
        html += `<div class="card-body py-2 px-3 bg-light border-bottom">`;
        html += `<small class="previous-indicator">Last: ${prev.weight}lbs Ã— ${prev.reps} reps`;
        if (prev.rpe) html += ` @ RPE ${prev.rpe}`;
        html += ` (${prev.date})</small>`;
        html += `</div>`;
    }
    
    // Body with column-based sets (DESKTOP TABLE VIEW)
    html += `<div class="card-body p-3 desktop-sets-table">`;
    html += `<div class="table-responsive">`;
    html += `<table class="table table-sm table-borderless mb-0">`;
    
    // Header row with set numbers
    html += `<thead><tr><th></th>`;
    for (let setNum = 1; setNum <= numSets; setNum++) {
        const isCompleted = logged.find(s => s.set_number === setNum) !== undefined;
        html += `<th class="text-center ${isCompleted ? 'text-success' : ''}">`;
        html += `<strong>Set ${setNum}</strong>`;
        if (isCompleted) html += ` <i class="bi bi-check-circle-fill"></i>`;
        html += `</th>`;
    }
    html += `</tr></thead><tbody>`;
    
    // Weight row
    html += `<tr><td class="align-middle"><strong>Weight</strong><br><small class="text-muted">lbs</small></td>`;
    for (let setNum = 1; setNum <= numSets; setNum++) {
        const suggestedWeight = exercise.suggested_weights[setNum - 1] || exercise.suggested_weights[0] || '';
        const loggedSet = logged.find(s => s.set_number === setNum);
        html += `<td class="text-center">`;
        html += `<div class="d-flex align-items-center justify-content-center gap-1">`;
        html += `<input type="number" class="form-control form-control-sm text-center" `;
        html += `id="weight-${exercise.exercise_id}-${setNum}" `;
        html += `placeholder="${suggestedWeight}" `;
        html += `value="${loggedSet?.weight || ''}" step="0.5" style="width: 80px;">`;
        if (suggestedWeight) {
            html += `<button type="button" class="btn btn-sm btn-outline-secondary" `;
            html += `onclick="applySuggestedWeight(${exercise.exercise_id}, ${setNum}, ${suggestedWeight})" `;
            html += `title="Use suggested weight" style="padding: 0.25rem 0.4rem;">`;
            html += `<i class="bi bi-check2"></i></button>`;
        }
        html += `</div>`;
        html += `</td>`;
    }
    html += `</tr>`;
    
    // Reps row
    html += `<tr><td class="align-middle"><strong>Reps</strong></td>`;
    for (let setNum = 1; setNum <= numSets; setNum++) {
        const suggestedReps = exercise.reps || '';
        const loggedSet = logged.find(s => s.set_number === setNum);
        html += `<td class="text-center">`;
        html += `<input type="number" class="form-control form-control-sm text-center" `;
        html += `id="reps-${exercise.exercise_id}-${setNum}" `;
        html += `value="${loggedSet?.reps || suggestedReps}" style="width: 80px; margin: 0 auto;">`;
        html += `</td>`;
    }
    html += `</tr>`;
    
    // RPE row
    html += `<tr><td class="align-middle"><strong>RPE</strong><br><small class="text-muted">optional</small></td>`;
    for (let setNum = 1; setNum <= numSets; setNum++) {
        const loggedSet = logged.find(s => s.set_number === setNum);
        const currentRpe = loggedSet?.rpe || '';
        html += `<td class="text-center">`;
        html += `<div class="btn-group btn-group-sm" role="group" style="width: 100px; margin: 0 auto;">`;
        html += `<button type="button" class="btn ${currentRpe === '-' ? 'btn-danger' : 'btn-outline-danger'}" `;
        html += `onclick="setRpe(${exercise.exercise_id}, ${setNum}, '-')" title="Too Heavy">-</button>`;
        html += `<button type="button" class="btn ${currentRpe === '=' ? 'btn-success' : 'btn-outline-success'}" `;
        html += `onclick="setRpe(${exercise.exercise_id}, ${setNum}, '=')" title="Good Weight">=</button>`;
        html += `<button type="button" class="btn ${currentRpe === '+' ? 'btn-primary' : 'btn-outline-primary'}" `;
        html += `onclick="setRpe(${exercise.exercise_id}, ${setNum}, '+')" title="Could Do More">+</button>`;
        html += `</div>`;
        html += `<input type="hidden" id="rpe-${exercise.exercise_id}-${setNum}" value="${currentRpe}">`;
        html += `</td>`;
    }
    html += `</tr>`;
    
    html += `</tbody></table></div>`;
    html += `</div>`; // End desktop-sets-table
    
    // MOBILE VIEWS (Carousel + Accordion)
    html += `<div class="card-body p-2 mobile-sets-carousel" style="display: none;">`;
    
    // Carousel container for current set
    html += `<div id="carousel-${exercise.exercise_id}">`;    
    html += renderCarouselSet(exercise, firstIncompleteSet, logged);
    html += `</div>`;    
    
    html += `</div>`; // End mobile-sets-carousel
    
    // MOBILE ACCORDION VIEW (Show All)
    html += `<div class="card-body p-3 mobile-sets-accordion" style="display: none;" id="accordion-view-${exercise.exercise_id}">`;    
    
    
    // Render each set as accordion item (firstIncompleteSet already calculated above)
    for (let setNum = 1; setNum <= numSets; setNum++) {
        const loggedSet = logged.find(s => s.set_number === setNum);
        const isCompleted = loggedSet !== undefined;
        const isCurrent = setNum === firstIncompleteSet;
        const suggestedWeight = exercise.suggested_weights[setNum - 1] || exercise.suggested_weights[0] || '';
        const suggestedReps = exercise.reps || '';
        
        html += `<div class="set-accordion-item" id="accordion-${exercise.exercise_id}-${setNum}">`;
        
        // Header
        let headerClass = 'set-accordion-header';
        if (isCompleted) headerClass += ' completed';
        if (isCurrent && !isCompleted) headerClass += ' current';
        
        html += `<div class="${headerClass}" onclick="toggleSetAccordion(${exercise.exercise_id}, ${setNum})">`;
        html += `<div>`;
        html += `<div class="set-accordion-title">`;
        if (isCompleted) {
            html += `<i class="bi bi-check-circle-fill text-success"></i>`;
        }
        html += `<span>Set ${setNum}</span>`;
        html += `</div>`;
        
        // Summary for completed sets
        if (isCompleted) {
            html += `<div class="set-accordion-summary">`;
            html += `${loggedSet.weight}lbs Ã— ${loggedSet.reps} reps`;
            if (loggedSet.rpe) html += ` @ RPE ${loggedSet.rpe}`;
            html += `</div>`;
        }
        html += `</div>`;
        
        html += `<i class="bi bi-chevron-down set-accordion-icon ${isCurrent ? 'expanded' : ''}" `;
        html += `id="icon-${exercise.exercise_id}-${setNum}"></i>`;
        html += `</div>`; // End header
        
        // Body (expanded for current set)
        html += `<div class="set-accordion-body ${isCurrent ? 'expanded' : ''}" `;
        html += `id="body-${exercise.exercise_id}-${setNum}">`;
        
        // Weight input
        html += `<div class="mobile-set-input-group">`;
        html += `<label>Weight (lbs)</label>`;
        html += `<div class="input-with-button">`;
        html += `<input type="number" class="form-control" `;
        html += `id="weight-mobile-${exercise.exercise_id}-${setNum}" `;
        html += `placeholder="${suggestedWeight || 'Enter weight'}" `;
        html += `value="${loggedSet?.weight || ''}" step="0.5">`;
        if (suggestedWeight) {
            html += `<button type="button" class="btn btn-outline-secondary" `;
            html += `onclick="applySuggestedWeightMobile(${exercise.exercise_id}, ${setNum}, ${suggestedWeight})">`;
            html += `Use ${suggestedWeight}</button>`;
        }
        html += `</div>`;
        html += `</div>`;
        
        // Reps input
        html += `<div class="mobile-set-input-group">`;
        html += `<label>Reps</label>`;
        html += `<input type="number" class="form-control" `;
        html += `id="reps-mobile-${exercise.exercise_id}-${setNum}" `;
        html += `value="${loggedSet?.reps || suggestedReps}" `;
        html += `placeholder="${suggestedReps || 'Enter reps'}">`;
        html += `</div>`;
        
        // RPE buttons
        html += `<div class="mobile-set-input-group">`;
        html += `<label>How did this set feel? <span class="text-muted">(optional)</span></label>`;
        const currentRpe = loggedSet?.rpe || '';
        html += `<div class="mobile-rpe-buttons">`;
        html += `<button type="button" class="btn ${currentRpe === '-' ? 'btn-danger' : 'btn-outline-danger'}" `;
        html += `onclick="setRpeMobile(${exercise.exercise_id}, ${setNum}, '-')" `;
        html += `id="rpe-mobile-btn-${exercise.exercise_id}-${setNum}--">-</button>`;
        html += `<button type="button" class="btn ${currentRpe === '=' ? 'btn-success' : 'btn-outline-success'}" `;
        html += `onclick="setRpeMobile(${exercise.exercise_id}, ${setNum}, '=')" `;
        html += `id="rpe-mobile-btn-${exercise.exercise_id}-${setNum}-=">=</button>`;
        html += `<button type="button" class="btn ${currentRpe === '+' ? 'btn-primary' : 'btn-outline-primary'}" `;
        html += `onclick="setRpeMobile(${exercise.exercise_id}, ${setNum}, '+')" `;
        html += `id="rpe-mobile-btn-${exercise.exercise_id}-${setNum}-+">+</button>`;
        html += `</div>`;
        html += `<input type="hidden" id="rpe-mobile-${exercise.exercise_id}-${setNum}" value="${currentRpe}">`;
        html += `</div>`;
        
        // Log Set or Edit button
        if (isCompleted) {
            html += `<button type="button" class="btn btn-warning mobile-save-set-btn" `;
            html += `id="edit-btn-mobile-${exercise.exercise_id}-${setNum}" `;
            html += `onclick="enableEditMobile(${exercise.exercise_id}, ${setNum})">`;
            html += `<i class="cil-pencil"></i> Edit Set ${setNum}`;
            html += `</button>`;
        } else {
            html += `<button type="button" class="btn btn-success mobile-save-set-btn" `;
            html += `id="log-btn-mobile-${exercise.exercise_id}-${setNum}" `;
            html += `onclick="logSingleSetMobile(${exercise.exercise_id}, ${setNum}, ${exercise.rest_time_seconds || 0})">`;
            html += `<i class="bi bi-check-lg"></i> Log Set ${setNum}`;
            html += `</button>`;
        }
        
        html += `</div>`; // End body
        html += `</div>`; // End accordion item
    }
    
    html += `</div>`; // End mobile-sets-accordion
    
    // Overall exercise RPE section
    const anySetLogged = logged.length > 0;
    const overallRpe = logged.find(s => s.overall_rpe)?.overall_rpe || '';
    
    html += `<div class="border-top pt-3 px-3 pb-2">`;
    html += `<div class="row align-items-center">`;
    html += `<div class="col-auto">`;
    html += `<strong>Overall Exercise Feeling:</strong> <span class="text-danger">*required</span>`;
    html += `</div>`;
    html += `<div class="col-auto">`;
    html += `<div class="btn-group" role="group">`;
    html += `<button type="button" class="btn ${overallRpe === '-' ? 'btn-danger' : 'btn-outline-danger'}" `;
    html += `onclick="setOverallRpe(${exercise.exercise_id}, '-')" `;
    html += `id="overall-rpe-btn-${exercise.exercise_id}--" title="Too Heavy" style="min-width: 50px;">-</button>`;
    html += `<button type="button" class="btn ${overallRpe === '=' ? 'btn-success' : 'btn-outline-success'}" `;
    html += `onclick="setOverallRpe(${exercise.exercise_id}, '=')" `;
    html += `id="overall-rpe-btn-${exercise.exercise_id}-=" title="Good Weight" style="min-width: 50px;">=</button>`;
    html += `<button type="button" class="btn ${overallRpe === '+' ? 'btn-primary' : 'btn-outline-primary'}" `;
    html += `onclick="setOverallRpe(${exercise.exercise_id}, '+')" `;
    html += `id="overall-rpe-btn-${exercise.exercise_id}-+" title="Could Do More" style="min-width: 50px;">+</button>`;
    html += `</div>`;
    html += `<input type="hidden" id="overall-rpe-${exercise.exercise_id}" value="${overallRpe}">`;
    html += `</div>`;
    html += `</div>`;
    html += `</div>`;
    html += `</div>`;
    html += `</div>`;
    
    html += `</div></div>`;
    
    return html;
}
function setRpe(exerciseId, setNumber, rpeValue) {
    // Update hidden input
    const rpeInput = document.getElementById(`rpe-${exerciseId}-${setNumber}`);
    if (rpeInput) {
        rpeInput.value = rpeValue;
    }
    
    // Update button styles - find all buttons in this set's RPE group
    const buttonGroup = rpeInput?.parentElement;
    if (buttonGroup) {
        const buttons = buttonGroup.querySelectorAll('button');
        buttons.forEach(btn => {
            const btnValue = btn.textContent.trim();
            
            // Handle each button's specific color
            if (btnValue === '-') {
                if (rpeValue === '-') {
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-danger');
                } else {
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-danger');
                }
            } else if (btnValue === '=') {
                if (rpeValue === '=') {
                    btn.classList.remove('btn-outline-success');
                    btn.classList.add('btn-success');
                } else {
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-success');
                }
            } else if (btnValue === '+') {
                if (rpeValue === '+') {
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-primary');
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                }
            }
        });
    }
}

function applySuggestedWeight(exerciseId, setNumber, suggestedWeight) {
    const weightInput = document.getElementById(`weight-${exerciseId}-${setNumber}`);
    if (weightInput) {
        weightInput.value = suggestedWeight;
        // Brief visual feedback
        weightInput.classList.add('border-success');
        setTimeout(() => {
            weightInput.classList.remove('border-success');
        }, 500);
    }
}

// Mobile-specific functions
function toggleSetAccordion(exerciseId, setNumber) {
    const body = document.getElementById(`body-${exerciseId}-${setNumber}`);
    const icon = document.getElementById(`icon-${exerciseId}-${setNumber}`);
    
    if (body.classList.contains('expanded')) {
        body.classList.remove('expanded');
        icon.classList.remove('expanded');
    } else {
        body.classList.add('expanded');
        icon.classList.add('expanded');
    }
}

function applySuggestedWeightMobile(exerciseId, setNumber, suggestedWeight) {
    const weightInput = document.getElementById(`weight-mobile-${exerciseId}-${setNumber}`);
    if (weightInput) {
        weightInput.value = suggestedWeight;
        // Brief visual feedback
        weightInput.classList.add('border-success');
        setTimeout(() => {
            weightInput.classList.remove('border-success');
        }, 500);
    }
}

function setRpeMobile(exerciseId, setNumber, rpeValue) {
    // Update hidden input
    const rpeInput = document.getElementById(`rpe-mobile-${exerciseId}-${setNumber}`);
    if (rpeInput) {
        rpeInput.value = rpeValue;
    }
    
    // Update button styles
    const buttons = ['-', '=', '+'];
    buttons.forEach(btn => {
        const btnElement = document.getElementById(`rpe-mobile-btn-${exerciseId}-${setNumber}-${btn}`);
        if (!btnElement) return;
        
        if (btn === rpeValue) {
            // Activate this button
            if (btn === '-') {
                btnElement.classList.remove('btn-outline-danger');
                btnElement.classList.add('btn-danger');
            } else if (btn === '=') {
                btnElement.classList.remove('btn-outline-success');
                btnElement.classList.add('btn-success');
            } else if (btn === '+') {
                btnElement.classList.remove('btn-outline-primary');
                btnElement.classList.add('btn-primary');
            }
        } else {
            // Deactivate other buttons
            if (btn === '-') {
                btnElement.classList.remove('btn-danger');
                btnElement.classList.add('btn-outline-danger');
            } else if (btn === '=') {
                btnElement.classList.remove('btn-success');
                btnElement.classList.add('btn-outline-success');
            } else if (btn === '+') {
                btnElement.classList.remove('btn-primary');
                btnElement.classList.add('btn-outline-primary');
            }
        }
    });
}

async function logSingleSetMobile(exerciseId, setNumber, restTime) {
    const weight = parseFloat(document.getElementById(`weight-mobile-${exerciseId}-${setNumber}`)?.value);
    const reps = parseInt(document.getElementById(`reps-mobile-${exerciseId}-${setNumber}`)?.value);
    const rpeInput = document.getElementById(`rpe-mobile-${exerciseId}-${setNumber}`);
    const rpe = rpeInput?.value || null;
    
    if (!weight || !reps) {
        alert('Please enter both weight and reps.');
        return;
    }
    
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/log-set`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                exercise_id: exerciseId,
                set_number: setNumber,
                weight: weight,
                reps: reps,
                rpe: rpe
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update logged sets
            if (!loggedSets[exerciseId]) {
                loggedSets[exerciseId] = [];
            }
            const existingIndex = loggedSets[exerciseId].findIndex(s => s.set_number === setNumber);
            if (existingIndex >= 0) {
                loggedSets[exerciseId][existingIndex] = data;
            } else {
                loggedSets[exerciseId].push(data);
            }
            
            // Update workout progress
            updateWorkoutProgress();
            
            // Update accordion item to show as completed
            const accordionItem = document.getElementById(`accordion-${exerciseId}-${setNumber}`);
            const header = accordionItem.querySelector('.set-accordion-header');
            const body = accordionItem.querySelector('.set-accordion-body');
            const icon = accordionItem.querySelector('.set-accordion-icon');
            
            // Mark as completed
            header.classList.remove('current');
            header.classList.add('completed');
            
            // Update title with checkmark and summary
            const titleDiv = header.querySelector('div');
            titleDiv.innerHTML = `
                <div>
                    <div class="set-accordion-title">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        <span>Set ${setNumber}</span>
                    </div>
                    <div class="set-accordion-summary">
                        ${weight}lbs Ã— ${reps} reps${rpe ? ' @ RPE ' + rpe : ''}
                    </div>
                </div>
            `;
            
            // Update button to Edit button
            const logBtn = body.querySelector('.mobile-save-set-btn');
            if (logBtn) {
                logBtn.id = `edit-btn-mobile-${exerciseId}-${setNumber}`;
                logBtn.className = 'btn btn-warning mobile-save-set-btn';
                logBtn.innerHTML = `<i class="cil-pencil"></i> Edit Set ${setNumber}`;
                logBtn.setAttribute('onclick', `enableEditMobile(${exerciseId}, ${setNumber})`);
            }
            
            // Remove editing mode class if present
            accordionItem.classList.remove('editing-mode');
            
            // Collapse this set
            body.classList.remove('expanded');
            icon.classList.remove('expanded');
            
            // Find and expand next set
            const exercise = workoutData.series.flatMap(s => s.exercises).find(ex => ex.exercise_id === exerciseId);
            if (exercise) {
                const numSets = exercise.sets;
                if (setNumber < numSets) {
                    const nextBody = document.getElementById(`body-${exerciseId}-${setNumber + 1}`);
                    const nextIcon = document.getElementById(`icon-${exerciseId}-${setNumber + 1}`);
                    const nextHeader = document.getElementById(`accordion-${exerciseId}-${setNumber + 1}`)?.querySelector('.set-accordion-header');
                    
                    if (nextBody && nextIcon && nextHeader) {
                        nextBody.classList.add('expanded');
                        nextIcon.classList.add('expanded');
                        nextHeader.classList.add('current');
                        
                        // Scroll to next set
                        setTimeout(() => {
                            nextHeader.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 200);
                    }
                }
                
                // Check if all sets are complete for this exercise
                const allSetsLogged = loggedSets[exerciseId] && loggedSets[exerciseId].length === numSets;
                if (allSetsLogged) {
                    // Show overall feeling prompt
                    setTimeout(() => {
                        promptOverallFeeling(exerciseId);
                    }, 500);
                }
            }
            
            // Start rest timer
            if (restTime > 0 && setNumber < exercise.sets) {
                startRestTimer(restTime);
            }
            
        } else {
            throw new Error('Failed to log set');
        }
    } catch (error) {
        console.error('Error logging set:', error);
        alert('Error logging set. Please try again.');
    }
}

function enableEditMobile(exerciseId, setNumber) {
    // Change Edit button to Update button
    const editBtn = document.getElementById(`edit-btn-mobile-${exerciseId}-${setNumber}`);
    if (editBtn) {
        editBtn.innerHTML = '<i class="bi bi-check-lg"></i> Update Set ' + setNumber;
        editBtn.classList.remove('btn-warning');
        editBtn.classList.add('btn-success');
        editBtn.setAttribute('id', `log-btn-mobile-${exerciseId}-${setNumber}`);
        editBtn.setAttribute('onclick', `logSingleSetMobile(${exerciseId}, ${setNumber}, 0)`);
    }
    
    // Show visual feedback that editing is enabled
    const accordionItem = document.getElementById(`accordion-${exerciseId}-${setNumber}`);
    if (accordionItem) {
        accordionItem.classList.add('editing-mode');
    }
}

function promptOverallFeeling(exerciseId) {
    // Scroll to overall feeling section
    const overallSection = document.querySelector(`#overall-rpe-${exerciseId}`)?.closest('.border-top');
    if (overallSection) {
        overallSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Highlight briefly
        overallSection.style.backgroundColor = '#fff3cd';
        setTimeout(() => {
            overallSection.style.backgroundColor = '';
        }, 2000);
    }
    
    // Show alert
    setTimeout(() => {
        alert('All sets complete! ðŸ’ª\n\nPlease select how the exercise felt overall.');
    }, 300);
}

// Carousel mode functions
function toggleMobileView(exerciseId) {
    const carouselView = document.querySelector(`#carousel-${exerciseId}`)?.closest('.mobile-sets-carousel');
    const accordionView = document.getElementById(`accordion-view-${exerciseId}`);
    const toggleBtn = document.getElementById(`toggle-view-${exerciseId}`);
    
    if (carouselView && accordionView && toggleBtn) {
        const isCarouselVisible = carouselView.style.display !== 'none';
        
        if (isCarouselVisible) {
            // Switch to accordion (show all)
            carouselView.style.display = 'none';
            accordionView.style.display = 'block';
            accordionView.classList.add('active');
            toggleBtn.innerHTML = '<i class="bi bi-arrow-left"></i>';
            toggleBtn.title = 'One at a time';
        } else {
            // Switch to carousel (one at a time)
            carouselView.style.display = 'block';
            accordionView.style.display = 'none';
            accordionView.classList.remove('active');
            toggleBtn.innerHTML = '<i class="bi bi-grid-3x3"></i>';
            toggleBtn.title = 'Show all sets';
        }
    }
}

function navigateCarousel(exerciseId, setNumber) {
    const exercise = workoutData.series.flatMap(s => s.exercises).find(ex => ex.exercise_id === exerciseId);
    if (!exercise) return;
    
    const logged = loggedSets[exerciseId] || [];
    const numSets = exercise.sets;
    
    // Bounds check: ensure setNumber is within valid range
    if (setNumber < 1) setNumber = 1;
    if (setNumber > numSets) setNumber = numSets;
    
    const carousel = document.getElementById(`carousel-${exerciseId}`);
    
    if (carousel) {
        carousel.innerHTML = renderCarouselSet(exercise, setNumber, logged);
        
        // Update the set progress badge in the card header
        const progressBadge = document.getElementById(`set-progress-badge-${exerciseId}`);
        if (progressBadge) {
            progressBadge.textContent = `Set ${setNumber} of ${exercise.sets}`;
        }
    }
}

function applyWeightCarousel(exerciseId, setNumber, weight) {
    const input = document.getElementById(`weight-carousel-${exerciseId}-${setNumber}`);
    if (input) {
        input.value = weight;
        input.classList.add('border-success');
        setTimeout(() => input.classList.remove('border-success'), 500);
    }
}

function setRpeCarousel(exerciseId, setNumber, rpeValue) {
    const rpeInput = document.getElementById(`rpe-carousel-${exerciseId}-${setNumber}`);
    if (rpeInput) {
        rpeInput.value = rpeValue;
    }
    
    const buttons = ['-', '=', '+'];
    buttons.forEach(btn => {
        const btnElement = document.getElementById(`rpe-carousel-btn-${exerciseId}-${setNumber}-${btn}`);
        if (!btnElement) return;
        
        if (btn === rpeValue) {
            if (btn === '-') {
                btnElement.classList.remove('btn-outline-danger');
                btnElement.classList.add('btn-danger');
            } else if (btn === '=') {
                btnElement.classList.remove('btn-outline-success');
                btnElement.classList.add('btn-success');
            } else if (btn === '+') {
                btnElement.classList.remove('btn-outline-primary');
                btnElement.classList.add('btn-primary');
            }
        } else {
            if (btn === '-') {
                btnElement.classList.remove('btn-danger');
                btnElement.classList.add('btn-outline-danger');
            } else if (btn === '=') {
                btnElement.classList.remove('btn-success');
                btnElement.classList.add('btn-outline-success');
            } else if (btn === '+') {
                btnElement.classList.remove('btn-primary');
                btnElement.classList.add('btn-outline-primary');
            }
        }
    });
}

async function logSetCarousel(exerciseId, setNumber, restTime) {
    const weight = parseFloat(document.getElementById(`weight-carousel-${exerciseId}-${setNumber}`)?.value);
    const reps = parseInt(document.getElementById(`reps-carousel-${exerciseId}-${setNumber}`)?.value);
    const rpeInput = document.getElementById(`rpe-carousel-${exerciseId}-${setNumber}`);
    const rpe = rpeInput?.value || null;
    
    if (!weight || !reps) {
        alert('Please enter both weight and reps.');
        return;
    }
    
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/log-set`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                exercise_id: exerciseId,
                set_number: setNumber,
                weight: weight,
                reps: reps,
                rpe: rpe
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update logged sets
            if (!loggedSets[exerciseId]) {
                loggedSets[exerciseId] = [];
            }
            const existingIndex = loggedSets[exerciseId].findIndex(s => s.set_number === setNumber);
            if (existingIndex >= 0) {
                loggedSets[exerciseId][existingIndex] = data;
            } else {
                loggedSets[exerciseId].push(data);
            }
            
            // Update workout progress
            updateWorkoutProgress();
            
            const exercise = workoutData.series.flatMap(s => s.exercises).find(ex => ex.exercise_id === exerciseId);
            if (exercise) {
                const numSets = exercise.sets;
                
                // Remove editing mode class
                const carouselItem = document.querySelector(`.carousel-item[data-exercise-id="${exerciseId}"][data-set-number="${setNumber}"]`);
                if (carouselItem) {
                    carouselItem.classList.remove('editing-mode');
                }
                
                // Check if all sets complete
                if (loggedSets[exerciseId].length === numSets) {
                    promptOverallFeeling(exerciseId);
                } else if (setNumber < numSets) {
                    // Move to next set
                    setTimeout(() => {
                        navigateCarousel(exerciseId, setNumber + 1);
                    }, 300);
                    
                    // Start rest timer
                    if (restTime > 0) {
                        startRestTimer(restTime);
                    }
                } else {
                    // Refresh current set to show as completed
                    navigateCarousel(exerciseId, setNumber);
                }
            }
        } else {
            throw new Error('Failed to log set');
        }
    } catch (error) {
        console.error('Error logging set:', error);
        alert('Error logging set. Please try again.');
    }
}

function enableEditCarousel(exerciseId, setNumber) {
    // Change Edit button to Update button
    const editBtn = document.getElementById(`edit-btn-carousel-${exerciseId}-${setNumber}`);
    if (editBtn) {
        editBtn.innerHTML = '<i class="cil-check"></i> Update Set';
        editBtn.classList.remove('btn-warning');
        editBtn.classList.add('btn-success');
        editBtn.setAttribute('onclick', `logSetCarousel(${exerciseId}, ${setNumber})`);
    }
    
    // Show visual feedback that editing is enabled
    const carouselItem = document.querySelector(`.carousel-item[data-exercise-id="${exerciseId}"][data-set-number="${setNumber}"]`);
    if (carouselItem) {
        carouselItem.classList.add('editing-mode');
    }
}

function setOverallRpe(exerciseId, rpeValue) {
    const exercise = workoutData.series.flatMap(s => s.exercises).find(ex => ex.exercise_id === exerciseId);
    if (!exercise) return;
    
    const numSets = exercise.sets;
    const logged = loggedSets[exerciseId] || [];
    
    // Check if all sets are logged
    if (logged.length !== numSets) {
        alert(`Please log all sets before selecting overall feeling.\n\nYou have logged ${logged.length} of ${numSets} sets.`);
        return;
    }
    
    // Update hidden input
    const overallRpeInput = document.getElementById(`overall-rpe-${exerciseId}`);
    if (overallRpeInput) {
        overallRpeInput.value = rpeValue;
    }
    
    // Just save overall RPE (sets already logged)
    saveOverallRpe(exerciseId, rpeValue);
}

async function logAllSetsForExercise(exerciseId, setsToLog, overallRpe, restTime) {
    try {
        // Log each set
        for (const setData of setsToLog) {
            const response = await fetch(`/workout/api/session/${sessionId}/log-set`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    exercise_id: exerciseId,
                    set_number: setData.set_number,
                    weight: setData.weight,
                    reps: setData.reps,
                    rpe: setData.rpe
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update logged sets
                if (!loggedSets[exerciseId]) {
                    loggedSets[exerciseId] = [];
                }
                const existingIndex = loggedSets[exerciseId].findIndex(s => s.set_number === setData.set_number);
                if (existingIndex >= 0) {
                    loggedSets[exerciseId][existingIndex] = data;
                } else {
                    loggedSets[exerciseId].push(data);
                }
            } else {
                throw new Error('Failed to log set');
            }
        }
        
        // Now save overall RPE
        await saveOverallRpe(exerciseId, overallRpe);
        
        // Update workout progress
        updateWorkoutProgress();
        
        // Show logged indicator
        const cardHeader = document.querySelector(`#logged-badge-${exerciseId}`);
        if (!cardHeader) {
            // Add badge if it doesn't exist
            const exerciseCard = document.querySelector(`#overall-rpe-${exerciseId}`)?.closest('.card');
            if (exerciseCard) {
                const header = exerciseCard.querySelector('.card-header > div');
                if (header) {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-success me-2';
                    badge.id = `logged-badge-${exerciseId}`;
                    badge.textContent = 'âœ“ Logged';
                    header.prepend(badge);
                }
            }
        }
        
        // Start rest timer after completing exercise
        if (restTime > 0) {
            startRestTimer(restTime);
        }
        
    } catch (error) {
        console.error('Error logging exercise:', error);
        alert('Error logging exercise. Please try again.');
    }
}

async function saveOverallRpe(exerciseId, overallRpe) {
    if (!overallRpe) {
        const overallRpeInput = document.getElementById(`overall-rpe-${exerciseId}`);
        overallRpe = overallRpeInput?.value;
    }
    
    if (!overallRpe) {
        alert('Please select how the exercise felt overall');
        return;
    }
    
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/overall-rpe`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                exercise_id: exerciseId,
                overall_rpe: overallRpe
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update logged sets with overall RPE
            if (loggedSets[exerciseId] && loggedSets[exerciseId].length > 0) {
                loggedSets[exerciseId][0].overall_rpe = overallRpe;
            }
            
            // Visual feedback - re-render to show updated button styles
            loadWorkoutData();
            
            // Brief success message
            const btn = document.getElementById(`overall-rpe-btn-${exerciseId}-${overallRpe}`);
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ“ Saved!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 1500);
            }
        }
    } catch (error) {
        console.error('Error saving overall RPE:', error);
        alert('Error saving feeling. Please try again.');
    }
}

function startRestTimer(seconds) {
    const totalSeconds = seconds;
    let remaining = seconds;
    
    const modalElement = document.getElementById('restTimerModal');
    const countdown = document.getElementById('restTimerCountdown');
    const progress = document.getElementById('restTimerProgress');
    
    restTimerModal.show();
    
    if (restTimerInterval) {
        clearInterval(restTimerInterval);
    }
    
    restTimerInterval = setInterval(() => {
        remaining--;
        const minutes = Math.floor(remaining / 60);
        const secs = remaining % 60;
        countdown.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
        
        const percentRemaining = (remaining / totalSeconds) * 100;
        progress.style.width = `${percentRemaining}%`;
        
        if (remaining <= 0) {
            clearInterval(restTimerInterval);
            restTimerModal.hide();
            // Play sound or notification
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
        }
    }, 1000);
}

function skipRestTimer() {
    if (restTimerInterval) {
        clearInterval(restTimerInterval);
    }
    restTimerModal.hide();
}

function showPreviousSets(exerciseId) {
    const exercise = workoutData.series
        .flatMap(s => s.exercises)
        .find(ex => ex.exercise_id === exerciseId);
    
    if (!exercise || !exercise.previous_sets) return;
    
    let html = `<h6>${exercise.exercise_name}</h6>`;
    html += `<table class="table table-sm">`;
    html += `<thead><tr><th>Date</th><th>Weight</th><th>Reps</th><th>RPE</th></tr></thead>`;
    html += `<tbody>`;
    
    exercise.previous_sets.forEach(set => {
        html += `<tr>`;
        html += `<td>${set.date}</td>`;
        html += `<td>${set.weight} lbs</td>`;
        html += `<td>${set.reps}</td>`;
        html += `<td>${set.rpe || '-'}</td>`;
        html += `</tr>`;
    });
    
    html += `</tbody></table>`;
    
    document.getElementById('previousSetsContent').innerHTML = html;
    new coreui.Modal(document.getElementById('previousSetsModal')).show();
}

async function finishWorkout() {
    // Check if all exercises have overall RPE set (for scheduled workouts)
    if (workoutData && !workoutData.is_standalone && workoutData.series) {
        const missingRpe = [];
        
        workoutData.series.forEach(series => {
            series.exercises.forEach(exercise => {
                const hasLoggedSets = loggedSets[exercise.exercise_id] && loggedSets[exercise.exercise_id].length > 0;
                if (hasLoggedSets) {
                    const hasOverallRpe = loggedSets[exercise.exercise_id].some(s => s.overall_rpe);
                    if (!hasOverallRpe) {
                        missingRpe.push(exercise.exercise_name);
                    }
                }
            });
        });
        
        if (missingRpe.length > 0) {
            alert(`Please set "Overall Exercise Feeling" for:\n\n${missingRpe.join('\n')}\n\nThis is required to track how exercises felt overall.`);
            return;
        }
    }
    
    if (!confirm('Are you sure you want to finish this workout?')) {
        return;
    }
    
    const notes = prompt('Any notes about this workout?');
    
    try {
        const response = await fetch(`/workout/api/session/${sessionId}/complete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: notes || '' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            clearInterval(timerInterval);
            releaseWakeLock();  // Release wake lock when workout is finished
            alert('Workout completed! Great job! ðŸ’ª');
            window.location.href = '/calendar';
        }
    } catch (error) {
        console.error('Error completing workout:', error);
        alert('Error completing workout. Please try again.');
    }
}

// Standalone workout functions
async function searchExercises() {
    const query = document.getElementById('exerciseSearchInput').value;
    
    try {
        const response = await fetch(`/workout/api/exercises/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        let html = '<div class="list-group">';
        data.exercises.forEach(ex => {
            html += `<button class="list-group-item list-group-item-action" `;
            html += `onclick="addExerciseToWorkout(${ex.id}, '${ex.name}')">`;
            html += `${ex.name} <small class="text-muted">(${ex.category})</small>`;
            html += `</button>`;
        });
        html += '</div>';
        
        document.getElementById('exerciseSearchResults').innerHTML = html;
    } catch (error) {
        console.error('Error searching exercises:', error);
    }
}

function addExerciseToWorkout(exerciseId, exerciseName) {
    // TODO: Implement adding exercise to standalone workout
    alert(`Adding ${exerciseName} to workout - feature coming soon!`);
}
</script>
{% endblock %}
