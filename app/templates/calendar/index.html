{% extends "base.html" %}

{% block title %}Calendar - CasettaFit{% endblock %}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    #calendar {
        min-height: 600px;
        height: auto;
    }
    
    /* Mobile-specific calendar styles */
    @media (max-width: 767px) {
        /* Remove container padding for full width */
        .calendar-page-container {
            padding-left: 0.25rem !important;
            padding-right: 0.25rem !important;
        }
        .calendar-page-container .row {
            margin-left: 0 !important;
            margin-right: 0 !important;
        }
        .calendar-page-container .col-12 {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
        #calendar {
            min-height: 400px;
        }
        .fc-view-harness {
            min-height: 350px !important;
        }
        .fc-daygrid-day-frame {
            min-height: 80px !important;
        }
        /* Reduce card padding */
        .calendar-page-container .card {
            border-radius: 0.25rem !important;
        }
        .calendar-page-container .card-body {
            min-height: auto !important;
            padding: 0.5rem !important;
            padding-bottom: 80px !important;
        }
        #calendar {
            margin: 0 !important;
        }
        .fc-daygrid-day {
            padding: 1px !important;
        }
        .fc-col-header-cell {
            padding: 0.35rem 1px !important;
        }
        /* Better toolbar layout - force proper structure */
        #calendar .fc-header-toolbar.fc-toolbar {
            margin-bottom: 0.75rem !important;
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: wrap !important;
            width: 100% !important;
        }
        /* Left chunk - buttons */
        #calendar .fc-header-toolbar .fc-toolbar-chunk:first-child {
            flex: 0 0 auto !important;
            order: 1 !important;
        }
        /* Center chunk - title - force to new line */
        #calendar .fc-header-toolbar .fc-toolbar-chunk:nth-child(2) {
            flex: 1 1 100% !important;
            order: 3 !important;
            margin-top: 0.75rem !important;
        }
        /* Right chunk - arrows */
        #calendar .fc-header-toolbar .fc-toolbar-chunk:last-child {
            flex: 0 0 auto !important;
            order: 2 !important;
            margin-left: auto !important;
        }
        #calendar .fc-toolbar-chunk {
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
        }
        /* Title styling - prevent wrapping */
        #calendar .fc-toolbar-title {
            display: block !important;
            font-size: 1.05rem !important;
            font-weight: 600 !important;
            text-align: center !important;
            width: 100% !important;
            padding: 0.5rem 0 !important;
            line-height: 1.2 !important;
            white-space: nowrap !important;
            overflow: visible !important;
        }
        /* Larger touch targets for navigation */
        #calendar .fc .fc-button,
        #calendar .fc .fc-button-primary {
            padding: 0.5rem 0.75rem !important;
            font-size: 0.9rem !important;
            min-width: 44px !important;
            min-height: 44px !important;
            line-height: 1.2 !important;
        }
        #calendar .fc .fc-today-button {
            font-size: 0.85rem !important;
        }
        #calendar .fc .fc-button-group {
            gap: 2px !important;
        }
        /* Better day headers - hide dates, show only day names */
        .fc-col-header-cell {
            padding: 0.5rem 0 !important;
        }
        .fc-col-header-cell-cushion {
            font-size: 0.75rem !important;
            font-weight: 600 !important;
        }
        /* Hide the day numbers/dates in cells */
        .fc-daygrid-day-top {
            justify-content: center !important;
        }
        .fc-daygrid-day-number {
            display: none !important;
        }
        /* Simplified event display */
        .fc-event-gym {
            display: none !important;
        }
        .fc-event {
            font-size: 0.85rem !important;
            padding: 4px 3px !important;
            line-height: 1.3 !important;
            margin-bottom: 2px !important;
        }
        .fc-event-title {
            font-weight: 500 !important;
        }
    }
    
    .fc {
        font-size: 0.9rem;
    }
    .fc-event {
        cursor: move !important;
        white-space: normal !important;
        padding: 3px 4px !important;
    }
    .fc-event:hover {
        opacity: 0.9;
    }
    .fc-event-title {
        font-weight: 500;
        line-height: 1.4;
        white-space: normal !important;
        overflow: visible !important;
    }
    .fc-daygrid-event {
        white-space: normal !important;
        min-height: 28px !important;
    }
    .fc-daygrid-event-harness {
        margin-bottom: 2px;
    }
    /* Make calendar cells taller to accommodate multi-line events */
    .fc-daygrid-day-frame {
        min-height: 100px;
    }
    .fc-scrollgrid-sync-table {
        height: 100% !important;
    }
    /* Different colors for different programs */
    .fc-event.program-1 { background-color: #4f46e5; border-color: #4338ca; }
    .fc-event.program-2 { background-color: #059669; border-color: #047857; }
    .fc-event.program-3 { background-color: #dc2626; border-color: #b91c1c; }
    .fc-event.program-4 { background-color: #7c3aed; border-color: #6d28d9; }
    .fc-event.program-5 { background-color: #ea580c; border-color: #c2410c; }
    
    /* Completed workouts - more specific selectors */
    .fc-event.fc-event-completed,
    .fc-daygrid-event.fc-event-completed {
        background-color: #198754 !important;
        border-color: #146c43 !important;
        opacity: 0.85 !important;
    }
    
    .fc-event-completed .fc-event-title:after,
    .fc-event-completed .fc-daygrid-event-title:after {
        content: " ‚úì";
        font-weight: bold;
        font-size: 1.1em;
        margin-left: 4px;
    }
    
    /* Ensure calendar is visible */
    .fc-view-harness {
        min-height: 500px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid calendar-page-container">
    <div class="row mb-3">
        <div class="col-12 col-md-auto mb-2 mb-md-0">
            <h2 class="mb-0">Workout Calendar</h2>
            <small class="text-muted d-none d-md-inline">
                <i class="cil-cursor-move"></i> Drag workouts to reschedule them
            </small>
        </div>
        <div class="col-12 col-md-auto ms-md-auto">
            <button type="button" class="btn btn-primary w-100 w-md-auto" onclick="showScheduleProgramModal()">
                <i class="cil-plus"></i> Schedule Program
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-9">
            <div class="card">
                <div class="card-body calendar-card-body" style="min-height: 650px;">
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card mb-3">
                <div class="card-header">
                    <strong>Scheduled Programs</strong>
                </div>
                <div class="card-body p-2">
                    {% if instances %}
                        <div class="list-group list-group-flush">
                            {% for instance in instances %}
                            <a href="{{ url_for('calendar.instance_workout_plan', instance_id=instance.id) }}" 
                               class="list-group-item list-group-item-action p-2">
                                <strong class="d-block">{{ instance.program.name }}</strong>
                                <small class="text-muted d-block">Started: {{ instance.scheduled_date.strftime('%b %d, %Y') }}</small>
                                {% if instance.gym %}
                                <small class="text-muted">üìç {{ instance.gym.name }}</small>
                                {% endif %}
                            </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center mb-0">No scheduled programs</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <strong>Unscheduled Days</strong>
                </div>
                <div class="card-body" id="missingDaysContainer">
                    <p class="text-muted text-center" id="noMissingDays">No missing days</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Program Modal -->
<div class="modal fade" id="scheduleProgramModal" tabindex="-1" aria-labelledby="scheduleProgramModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleProgramModalLabel">Schedule Program</h5>
                <button type="button" class="btn-close" data-coreui-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="scheduleFormContainer">
                    <!-- Step 1: Select Program & Start Date -->
                    <div id="step1">
                        <h6 class="mb-3">Select Program and Gym</h6>
                        <div class="mb-3">
                            <label for="programSelect" class="form-label">Program</label>
                            <select class="form-select" id="programSelect" onchange="loadProgramDetails()">
                                <option value="">-- Select a program --</option>
                                {% for program in programs %}
                                <option value="{{ program.id }}">{{ program.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="gymSelect" class="form-label">Gym</label>
                            <select class="form-select" id="gymSelect">
                                <option value="">-- Select a gym (optional) --</option>
                                {% for gym in gyms %}
                                <option value="{{ gym.id }}">{{ gym.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Choose where you'll complete this program</div>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div id="programPreview" style="display: none;">
                            <h6 class="mt-4">Program Structure</h6>
                            <div id="programStructure"></div>
                        </div>
                        <button type="button" class="btn btn-primary mt-3" onclick="showDayMapping()" id="nextStepBtn" disabled>
                            Next: Map Days
                        </button>
                    </div>

                    <!-- Step 2: Map Days to Calendar -->
                    <div id="step2" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Map Program Days to Calendar</h6>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="showStep(1)">
                                <i class="cil-arrow-left"></i> Back
                            </button>
                        </div>
                        <div id="dayMappingContainer"></div>
                        <button type="button" class="btn btn-success mt-3" onclick="scheduleProgram()">
                            Schedule Workouts
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View/Edit Scheduled Day Modal -->
<div class="modal fade" id="viewDayModal" tabindex="-1" aria-labelledby="viewDayModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDayModalLabel">Scheduled Workout</h5>
                <button type="button" class="btn-close" data-coreui-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="viewDayContent">
                <!-- Dynamic content loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-coreui-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="deleteScheduledDay()">Delete</button>
                <button type="button" class="btn btn-primary" onclick="startWorkout()">Start Workout</button>
            </div>
        </div>
    </div>
</div>

<!-- Conflict Resolution Modal -->
<div class="modal fade" id="conflictModal" tabindex="-1" aria-labelledby="conflictModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="conflictModalLabel">Schedule Conflict</h5>
                <button type="button" class="btn-close" data-coreui-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="conflictModalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-coreui-dismiss="modal" onclick="cancelDrop()">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="swapDays()">Swap Days</button>
                <button type="button" class="btn btn-primary" onclick="shiftDays()">Shift Forward</button>
            </div>
        </div>
    </div>
</div>

<!-- Override FullCalendar styles AFTER it loads -->
<style>
    /* Force calendar cells to be taller */
    .fc .fc-daygrid-day-frame {
        min-height: 100px !important;
    }
    
    /* Force events to wrap and be taller */
    .fc .fc-daygrid-event {
        white-space: normal !important;
        min-height: 28px !important;
        padding: 3px 4px !important;
    }
    
    /* Force event title to wrap */
    .fc .fc-event-title {
        white-space: normal !important;
        overflow: visible !important;
        line-height: 1.4 !important;
    }
    
    /* Completed workout styling with maximum specificity */
    .fc .fc-daygrid-event.fc-event-completed,
    .fc .fc-event.fc-event-completed {
        background-color: #198754 !important;
        border-color: #146c43 !important;
        opacity: 0.85 !important;
    }
    
    /* Style for gym name in events */
    .fc .fc-event-gym {
        font-size: 0.85em;
        margin-top: 2px;
        line-height: 1.2;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
let calendar;
let selectedEvent = null;
let scheduleProgramModal;
let viewDayModal;
let conflictModal;
let currentDropInfo = null;
let conflictData = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing calendar...');
    const calendarEl = document.getElementById('calendar');
    
    if (!calendarEl) {
        console.error('Calendar element not found!');
        return;
    }
    
    try {
        // Detect mobile device
        const isMobile = window.innerWidth < 768;
        
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: isMobile ? 'dayGridWeek' : 'dayGridMonth',
            height: 'auto',
            contentHeight: isMobile ? 400 : 650,
            aspectRatio: isMobile ? 1.0 : 1.5,
            headerToolbar: isMobile ? {
                start: 'today dayGridWeek,dayGridMonth',
                center: 'title',
                end: 'prev,next'
            } : {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            titleFormat: isMobile ? { month: 'short', day: 'numeric', year: 'numeric' } : { year: 'numeric', month: 'long' },
            dayHeaderFormat: isMobile ? { weekday: 'short' } : { weekday: 'short', month: 'numeric', day: 'numeric', omitCommas: true },
            editable: true,
            droppable: true,
            eventDrop: handleEventDrop,
            eventClick: handleEventClick,
            drop: handleExternalDrop,
            events: '/calendar/events',
            eventDisplay: 'block',
            displayEventTime: false,
            eventClassNames: function(arg) {
                // Add program-specific class for coloring
                return ['program-' + (arg.event.extendedProps.programId % 5 + 1)];
            },
            eventContent: function(arg) {
                // Custom render to add italicized gym name and checkmark
                const isMobile = window.innerWidth < 768;
                let title = arg.event.title;
                
                // Simplify title on mobile - just show program name and day number
                if (isMobile) {
                    const parts = title.split(' - ');
                    if (parts.length > 0) {
                        // Extract just program name and day (e.g., "Test 1 - Day 2" becomes "Test 1 D2")
                        title = parts[0];
                        if (parts[1] && parts[1].includes('Day')) {
                            const dayNum = parts[1].replace('Day ', 'D');
                            title += ' ' + dayNum;
                        }
                    }
                }
                
                let html = '<div class="fc-event-title">' + title;
                
                // Add checkmark for completed workouts
                if (arg.event.extendedProps.isCompleted) {
                    html += ' ‚úì';
                }
                
                html += '</div>';
                
                // Add italicized gym name if present (desktop only)
                if (!isMobile && arg.event.extendedProps.gymName) {
                    html += '<div class="fc-event-gym"><i>' + arg.event.extendedProps.gymName + '</i></div>';
                }
                
                return { html: html };
            },
            loading: function(isLoading) {
                console.log('Calendar loading:', isLoading);
            }
        });
        
        calendar.render();
        console.log('Calendar rendered successfully');
        
        // Force mobile toolbar layout after render
        if (isMobile) {
            setTimeout(function() {
                const toolbar = document.querySelector('#calendar .fc-header-toolbar');
                if (toolbar) {
                    toolbar.style.display = 'flex';
                    toolbar.style.flexWrap = 'wrap';
                    toolbar.style.marginBottom = '0.75rem';
                    
                    const chunks = toolbar.querySelectorAll('.fc-toolbar-chunk');
                    if (chunks.length >= 3) {
                        // First chunk (left buttons)
                        chunks[0].style.order = '1';
                        chunks[0].style.flex = '0 0 auto';
                        
                        // Second chunk (title) - force to new line
                        chunks[1].style.order = '3';
                        chunks[1].style.flex = '1 1 100%';
                        chunks[1].style.marginTop = '0.75rem';
                        chunks[1].style.textAlign = 'center';
                        
                        // Third chunk (right arrows)
                        chunks[2].style.order = '2';
                        chunks[2].style.flex = '0 0 auto';
                        chunks[2].style.marginLeft = 'auto';
                    }
                }
            }, 100);
        }
    } catch (error) {
        console.error('Error initializing calendar:', error);
    }
    
    // Initialize modals
    scheduleProgramModal = new coreui.Modal(document.getElementById('scheduleProgramModal'));
    viewDayModal = new coreui.Modal(document.getElementById('viewDayModal'));
    conflictModal = new coreui.Modal(document.getElementById('conflictModal'));
    
    // Set today as default start date
    document.getElementById('startDate').valueAsDate = new Date();
    
    // Load missing days
    loadMissingDays();
});

function showScheduleProgramModal() {
    showStep(1);
    scheduleProgramModal.show();
}

function showStep(step) {
    document.getElementById('step1').style.display = step === 1 ? 'block' : 'none';
    document.getElementById('step2').style.display = step === 2 ? 'block' : 'none';
}

function loadProgramDetails() {
    const programId = document.getElementById('programSelect').value;
    const nextBtn = document.getElementById('nextStepBtn');
    
    if (!programId) {
        document.getElementById('programPreview').style.display = 'none';
        nextBtn.disabled = true;
        return;
    }
    
    fetch(`/calendar/program/${programId}/details`)
        .then(response => response.json())
        .then(data => {
            displayProgramStructure(data);
            document.getElementById('programPreview').style.display = 'block';
            nextBtn.disabled = false;
        })
        .catch(error => {
            console.error('Error loading program:', error);
            alert('Error loading program details');
        });
}

function displayProgramStructure(program) {
    const container = document.getElementById('programStructure');
    let html = '<div class="alert alert-info">';
    html += `<strong>${program.name}</strong><br>`;
    html += `${program.weeks.length} week(s), `;
    
    let totalDays = 0;
    program.weeks.forEach(week => {
        totalDays += week.days.length;
    });
    html += `${totalDays} total workout day(s)`;
    html += '</div>';
    
    program.weeks.forEach(week => {
        html += `<div class="card mb-2">`;
        html += `<div class="card-body">`;
        html += `<strong>Week ${week.week_number}:</strong> `;
        html += week.days.map(day => day.name).join(', ');
        html += `</div></div>`;
    });
    
    container.innerHTML = html;
}

function showDayMapping() {
    const programId = document.getElementById('programSelect').value;
    const startDate = document.getElementById('startDate').value;
    
    if (!startDate) {
        alert('Please select a start date');
        return;
    }
    
    fetch(`/calendar/program/${programId}/details`)
        .then(response => response.json())
        .then(program => {
            displayDayMapping(program, startDate);
            showStep(2);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading program');
        });
}

function displayDayMapping(program, startDate) {
    const container = document.getElementById('dayMappingContainer');
    // Create date in local timezone by parsing the YYYY-MM-DD string
    const [year, month, day] = startDate.split('-').map(Number);
    let currentDate = new Date(year, month - 1, day);
    let html = '';
    
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    program.weeks.forEach((week, weekIndex) => {
        html += `<div class="card mb-3">`;
        html += `<div class="card-header"><strong>Week ${week.week_number}</strong></div>`;
        html += `<div class="card-body">`;
        html += `<div class="row g-2">`;
        
        week.days.forEach((day, dayIndex) => {
            // Format date as YYYY-MM-DD for the input value
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const dayNum = String(currentDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${dayNum}`;
            
            const dayOfWeek = dayNames[currentDate.getDay()];
            const formattedDate = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            html += `<div class="col-md-4">`;
            html += `<div class="border rounded p-2">`;
            html += `<strong>${day.name}</strong><br>`;
            html += `<small class="text-muted">${dayOfWeek}, ${formattedDate}</small><br>`;
            html += `<input type="date" class="form-control form-control-sm mt-1" 
                     id="day_${day.id}" value="${dateStr}" 
                     data-program-day-id="${day.id}"
                     onchange="updateDayLabel(this, ${day.id})">`;
            html += `</div></div>`;
            
            currentDate.setDate(currentDate.getDate() + 1);
        });
        
        html += `</div></div></div>`;
    });
    
    container.innerHTML = html;
}

function updateDayLabel(input, dayId) {
    // Update the day of week label when date is changed
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    // Parse as local date
    const [year, month, day] = input.value.split('-').map(Number);
    const selectedDate = new Date(year, month - 1, day);
    const dayOfWeek = dayNames[selectedDate.getDay()];
    const formattedDate = selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    
    // Find the label element (it's the previous sibling before the input)
    const label = input.parentElement.querySelector('small.text-muted');
    if (label) {
        label.textContent = `${dayOfWeek}, ${formattedDate}`;
    }
}

function scheduleProgram() {
    const programId = document.getElementById('programSelect').value;
    const gymId = document.getElementById('gymSelect').value;
    const dayInputs = document.querySelectorAll('[data-program-day-id]');
    
    const mappings = [];
    dayInputs.forEach(input => {
        mappings.push({
            program_day_id: parseInt(input.dataset.programDayId),
            calendar_date: input.value
        });
    });
    
    fetch('/calendar/schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            program_id: parseInt(programId),
            gym_id: gymId ? parseInt(gymId) : null,
            mappings: mappings
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            scheduleProgramModal.hide();
            alert('Program scheduled successfully!');
            location.reload();  // Reload to update Scheduled Programs card
        } else if (data.conflicts) {
            handleConflicts(data.conflicts, mappings);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error scheduling program');
    });
}

function handleConflicts(conflicts, mappings) {
    let message = 'Warning: The following dates already have workouts from this program:\n\n';
    conflicts.forEach(conflict => {
        message += `${conflict.date}: ${conflict.existing_day}\n`;
    });
    message += '\nDo you want to proceed anyway? (Existing workouts will remain scheduled)';
    
    if (confirm(message)) {
        // Force schedule despite conflicts
        const programId = document.getElementById('programSelect').value;
        fetch('/calendar/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                program_id: parseInt(programId),
                mappings: mappings,
                force: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                scheduleProgramModal.hide();
                calendar.refetchEvents();
                alert('Program scheduled!');
            }
        });
    }
}

function handleEventDrop(info) {
    const eventId = info.event.id;
    const newDate = info.event.start.toISOString().split('T')[0];
    const oldDate = info.oldEvent.start.toISOString().split('T')[0];
    
    fetch(`/calendar/reschedule/${eventId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ new_date: newDate })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            calendar.refetchEvents();
        } else if (data.conflict) {
            // Show conflict resolution modal
            showConflictResolutionModal(info, data.conflict_details, oldDate, newDate);
        } else {
            info.revert();
            alert('Error rescheduling workout');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        info.revert();
        alert('Error rescheduling workout');
    });
}

function handleExternalDrop(info) {
    try {
        const data = JSON.parse(info.draggedEl.dataset.instanceId ? 
            JSON.stringify({
                instanceId: parseInt(info.draggedEl.dataset.instanceId),
                programDayId: parseInt(info.draggedEl.dataset.programDayId)
            }) : 
            info.jsEvent.dataTransfer.getData('application/json')
        );
        
        const dateStr = info.dateStr;
        scheduleMissingDay(data.instanceId, data.programDayId, dateStr);
    } catch (error) {
        console.error('Error handling drop:', error);
    }
}

function handleEventClick(info) {
    selectedEvent = info.event;
    loadScheduledDayDetails(info.event.id);
    viewDayModal.show();
}

function loadScheduledDayDetails(scheduledDayId) {
    fetch(`/calendar/scheduled-day/${scheduledDayId}`)
        .then(response => response.json())
        .then(data => {
            displayScheduledDayDetails(data);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('viewDayContent').innerHTML = 
                '<div class="alert alert-danger">Error loading workout details</div>';
        });
}

function displayScheduledDayDetails(data) {
    let html = `
        <h5>${data.program_name} - ${data.day_name}</h5>
        <p class="text-muted mb-1">Scheduled for: ${data.calendar_date}</p>
    `;
    
    if (data.gym_name) {
        html += `<p class="text-muted mb-3"><i class="cil-location-pin"></i> ${data.gym_name}</p>`;
    } else {
        html += `<p class="text-muted mb-3"><i class="cil-location-pin"></i> No gym selected</p>`;
    }
    
    if (data.series && data.series.length > 0) {
        html += '<h6 class="mt-3">Workout:</h6>';
        data.series.forEach((series, index) => {
            const colors = ['primary', 'success', 'danger', 'warning', 'info'];
            const color = colors[index % 5];
            
            html += `<div class="border-start border-${color} border-4 ps-3 mb-3">`;
            
            if (series.series_type === 'superset') {
                html += '<span class="badge bg-warning text-dark">SUPERSET</span><br>';
                series.exercises.forEach((ex, exIndex) => {
                    html += `<strong>${String.fromCharCode(65 + exIndex)}. ${ex.exercise_name}</strong>: `;
                    html += `${ex.sets} √ó ${ex.reps}`;
                    
                    // Display weights: custom (green) with default in parentheses, or just default
                    if (ex.custom_weights && ex.custom_weights.length > 0) {
                        html += ` @ <span class="text-success fw-bold">${ex.custom_weights.join('/')}</span>`;
                        if (ex.default_weights && ex.default_weights.length > 0) {
                            html += ` <span class="text-muted">(default: ${ex.default_weights.join('/')})</span>`;
                        }
                        html += ' lbs';
                    } else if (ex.default_weights && ex.default_weights.length > 0) {
                        html += ` @ ${ex.default_weights.join('/')} lbs`;
                    }
                    
                    html += '<br>';
                    
                    // Show custom notes if they exist
                    if (ex.custom_notes) {
                        html += `<small class="text-muted fst-italic">Notes: ${ex.custom_notes}</small><br>`;
                    }
                });
            } else {
                const ex = series.exercises[0];
                html += `<strong>${ex.exercise_name}</strong>: ${ex.sets} √ó ${ex.reps}`;
                
                // Display weights: custom (green) with default in parentheses, or just default
                if (ex.custom_weights && ex.custom_weights.length > 0) {
                    html += ` @ <span class="text-success fw-bold">${ex.custom_weights.join('/')}</span>`;
                    if (ex.default_weights && ex.default_weights.length > 0) {
                        html += ` <span class="text-muted">(default: ${ex.default_weights.join('/')})</span>`;
                    }
                    html += ' lbs';
                } else if (ex.default_weights && ex.default_weights.length > 0) {
                    html += ` @ ${ex.default_weights.join('/')} lbs`;
                }
                
                // Show custom notes if they exist
                if (ex.custom_notes) {
                    html += `<br><small class="text-muted fst-italic">Notes: ${ex.custom_notes}</small>`;
                }
            }
            
            html += '</div>';
        });
        
        // Add link to workout plan editor if instance exists
        if (data.instance_id) {
            html += `
                <div class="mt-3">
                    <a href="/calendar/instance/${data.instance_id}/workout-plan" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil-square"></i> Edit Program Instance Weights
                    </a>
                </div>
            `;
        }
    } else {
        html += '<p class="text-muted">No exercises scheduled for this day.</p>';
    }
    
    document.getElementById('viewDayContent').innerHTML = html;
}

function deleteScheduledDay() {
    if (!selectedEvent) return;
    
    if (!confirm('Are you sure you want to delete this scheduled workout?')) {
        return;
    }
    
    fetch(`/calendar/scheduled-day/${selectedEvent.id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            viewDayModal.hide();
            calendar.refetchEvents();
        } else {
            alert('Error deleting workout');
        }
    });
}

function startWorkout() {
    if (!selectedEvent) return;
    
    // Navigate to workout execution page
    window.location.href = `/workout/start/${selectedEvent.id}`;
}

function showConflictResolutionModal(dropInfo, conflict, oldDate, newDate) {
    currentDropInfo = dropInfo;
    conflictData = conflict;
    
    const oldDateFormatted = new Date(oldDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
    const newDateFormatted = new Date(newDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
    
    const html = `
        <p><strong>You're trying to move:</strong><br>
        <span class="text-primary">${dropInfo.event.title}</span><br>
        from ${oldDateFormatted} to ${newDateFormatted}</p>
        
        <p><strong>But ${newDateFormatted} already has:</strong><br>
        <span class="text-warning">${conflict.existing_day_name}</span></p>
        
        <p class="mb-0"><strong>What would you like to do?</strong></p>
        <ul class="mb-0">
            <li><strong>Swap Days:</strong> Exchange the two workouts (put the existing workout on ${oldDateFormatted})</li>
            <li><strong>Shift Forward:</strong> Move the existing workout to the next available date</li>
            <li><strong>Cancel:</strong> Keep everything as it was</li>
        </ul>
    `;
    
    document.getElementById('conflictModalBody').innerHTML = html;
    conflictModal.show();
}

function cancelDrop() {
    if (currentDropInfo) {
        currentDropInfo.revert();
        currentDropInfo = null;
        conflictData = null;
    }
    conflictModal.hide();
}

function swapDays() {
    if (!currentDropInfo || !conflictData) return;
    
    const eventId = currentDropInfo.event.id;
    const newDate = currentDropInfo.event.start.toISOString().split('T')[0];
    
    fetch(`/calendar/reschedule/${eventId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            new_date: newDate,
            action: 'swap',
            conflict_id: conflictData.conflict_id
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            conflictModal.hide();
            calendar.refetchEvents();
        } else {
            alert('Error swapping days: ' + (data.error || 'Unknown error'));
            currentDropInfo.revert();
        }
        currentDropInfo = null;
        conflictData = null;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error swapping days');
        currentDropInfo.revert();
        currentDropInfo = null;
        conflictData = null;
    });
}

function shiftDays() {
    if (!currentDropInfo || !conflictData) return;
    
    const eventId = currentDropInfo.event.id;
    const newDate = currentDropInfo.event.start.toISOString().split('T')[0];
    
    fetch(`/calendar/reschedule/${eventId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            new_date: newDate,
            action: 'shift',
            conflict_id: conflictData.conflict_id
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            conflictModal.hide();
            calendar.refetchEvents();
            if (data.shifted_to) {
                alert(`Workout shifted to ${data.shifted_to}`);
            }
        } else {
            alert('Error shifting days: ' + (data.error || 'Unknown error'));
            currentDropInfo.revert();
        }
        currentDropInfo = null;
        conflictData = null;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error shifting days');
        currentDropInfo.revert();
        currentDropInfo = null;
        conflictData = null;
    });
}

function loadMissingDays() {
    fetch('/calendar/missing-days')
        .then(response => response.json())
        .then(data => {
            displayMissingDays(data);
        })
        .catch(error => {
            console.error('Error loading missing days:', error);
        });
}

function displayMissingDays(missingDays) {
    const container = document.getElementById('missingDaysContainer');
    const noMissingMsg = document.getElementById('noMissingDays');
    
    if (missingDays.length === 0) {
        noMissingMsg.style.display = 'block';
        return;
    }
    
    noMissingMsg.style.display = 'none';
    
    let html = '<div class="list-group list-group-flush">';
    missingDays.forEach(day => {
        html += `
            <div class="list-group-item p-2" style="cursor: move;" 
                 data-instance-id="${day.instance_id}"
                 data-program-day-id="${day.program_day_id}"
                 draggable="true"
                 ondragstart="handleMissingDayDragStart(event)">
                <small class="text-muted d-block">Week ${day.week_number}</small>
                <strong class="d-block">${day.day_name}</strong>
                <small class="text-primary">${day.program_name}</small>
                ${day.gym_name ? '<br><small class="text-muted">üìç ' + day.gym_name + '</small>' : ''}
                <button class="btn btn-sm btn-outline-primary w-100 mt-2" 
                        onclick="scheduleMissingDayPrompt(${day.instance_id}, ${day.program_day_id}, '${day.day_name}')">
                    Schedule
                </button>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function handleMissingDayDragStart(event) {
    event.dataTransfer.effectAllowed = 'copy';
    event.dataTransfer.setData('application/json', JSON.stringify({
        instanceId: parseInt(event.target.dataset.instanceId),
        programDayId: parseInt(event.target.dataset.programDayId)
    }));
}

function scheduleMissingDayPrompt(instanceId, programDayId, dayName) {
    const dateStr = prompt(`Enter date for ${dayName} (YYYY-MM-DD):`, new Date().toISOString().split('T')[0]);
    if (dateStr) {
        scheduleMissingDay(instanceId, programDayId, dateStr);
    }
}

function scheduleMissingDay(instanceId, programDayId, calendarDate) {
    fetch('/calendar/schedule-missing-day', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            instance_id: instanceId,
            program_day_id: programDayId,
            calendar_date: calendarDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            calendar.refetchEvents();
            loadMissingDays();
        } else if (data.conflict) {
            alert(data.message);
        } else {
            alert('Error scheduling day: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error scheduling day');
    });
}
</script>
{% endblock %}
