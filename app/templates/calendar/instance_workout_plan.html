{% extends "base.html" %}

{% block title %}Workout Plan - {{ instance.program.name }} - CasettaFit{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('calendar.index') }}">Calendar</a></li>
                    <li class="breadcrumb-item active">Workout Plan</li>
                </ol>
            </nav>
            <h2 class="mb-0">{{ instance.program.name }}</h2>
            <p class="text-muted mb-0">
                Started: {{ instance.scheduled_date.strftime('%B %d, %Y') }}
                {% if instance.gym %}
                | <i class="cil-location-pin"></i> {{ instance.gym.name }}
                {% endif %}
            </p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" onclick="saveAllChanges()">
                <i class="cil-save"></i> Save All Changes
            </button>
            <a href="{{ url_for('calendar.index') }}" class="btn btn-secondary">
                <i class="cil-arrow-left"></i> Back to Calendar
            </a>
        </div>
    </div>

    <div id="workoutPlanContainer">
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Edit Logged Sets Modal -->
<div class="modal fade" id="editSetsModal" tabindex="-1" aria-labelledby="editSetsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSetsModalLabel">Edit Logged Sets</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editSetsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAllLoggedSets()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let workoutData = null;
let instanceId = {{ instance.id }};
let pendingChanges = {};

document.addEventListener('DOMContentLoaded', function() {
    loadWorkoutPlan();
});

function loadWorkoutPlan() {
    fetch(`/calendar/instance/${instanceId}/workout-data`)
        .then(response => response.json())
        .then(data => {
            workoutData = data;
            displayWorkoutPlan(data);
        })
        .catch(error => {
            console.error('Error loading workout plan:', error);
            document.getElementById('workoutPlanContainer').innerHTML = 
                '<div class="alert alert-danger">Error loading workout plan</div>';
        });
}

function displayWorkoutPlan(data) {
    const container = document.getElementById('workoutPlanContainer');
    let html = '';
    
    data.weeks.forEach(week => {
        html += `<div class="card mb-4">`;
        html += `<div class="card-header bg-primary text-white">`;
        html += `<h4 class="mb-0">Week ${week.week_number}</h4>`;
        html += `</div>`;
        html += `<div class="card-body">`;
        
        week.days.forEach(day => {
            html += `<div class="d-flex justify-content-between align-items-center mb-3">`;
            html += `<h5 class="border-bottom pb-2 mb-0 flex-grow-1">${day.name}</h5>`;
            
            // Show completion status
            if (day.is_completed) {
                html += `<span class="badge bg-success ms-3">
                         <i class="bi bi-check-circle-fill"></i> Completed
                         </span>`;
            } else if (day.scheduled_date) {
                html += `<span class="badge bg-secondary ms-3">
                         <i class="bi bi-calendar-event"></i> Scheduled ${day.scheduled_date}
                         </span>`;
            } else {
                html += `<span class="badge bg-light text-dark ms-3">
                         <i class="bi bi-circle"></i> Not Scheduled
                         </span>`;
            }
            
            html += `</div>`;
            
            if (day.series.length === 0) {
                html += `<p class="text-muted">No exercises scheduled</p>`;
            }
            
            day.series.forEach((series, seriesIndex) => {
                const colors = ['primary', 'success', 'danger', 'warning', 'info'];
                const color = colors[seriesIndex % 5];
                
                html += `<div class="border-start border-${color} border-4 ps-3 mb-4">`;
                
                if (series.series_type === 'superset') {
                    html += `<span class="badge bg-warning text-dark mb-2">SUPERSET</span>`;
                }
                
                // Table for exercises
                html += `<table class="table table-sm">`;
                html += `<thead><tr>`;
                html += `<th>Exercise</th><th>Sets</th><th>Reps</th>`;
                html += `<th>Weights (per set)</th><th>Notes</th><th></th>`;
                html += `</tr></thead><tbody>`;
                
                series.exercises.forEach(exercise => {
                    html += `<tr>`;
                    html += `<td><strong>${exercise.exercise_name}</strong></td>`;
                    html += `<td>${exercise.sets}</td>`;
                    html += `<td>${exercise.reps}</td>`;
                    html += `<td>`;
                    
                    // Show logged weights if day is completed, otherwise show editable planned weights
                    if (day.is_completed && exercise.logged_weights) {
                        // Check if any sets were actually logged
                        const hasLoggedSets = exercise.logged_weights.some(w => w !== null);
                        
                        // Display both planned and actual logged weights for comparison
                        for (let i = 0; i < exercise.sets; i++) {
                            const loggedWeight = exercise.logged_weights[i];
                            const loggedReps = exercise.logged_reps[i];
                            const plannedWeight = exercise.weights[i] || '';
                            
                            html += `<div class="d-inline-block mb-1 me-2" style="min-width: 100px;">`;
                            
                            if (loggedWeight !== null) {
                                // Show planned weight in small text, actual in badge
                                html += `<small class="text-muted d-block">Plan: ${plannedWeight || '-'}</small>`;
                                html += `<span class="badge bg-success" title="Set ${i + 1} completed">${loggedWeight} × ${loggedReps}</span>`;
                            } else {
                                // Set wasn't logged
                                html += `<small class="text-muted d-block">Plan: ${plannedWeight || '-'}</small>`;
                                html += `<span class="badge bg-secondary" title="Set ${i + 1} not logged">Not logged</span>`;
                            }
                            
                            html += `</div>`;
                        }
                    } else {
                        // Editable weight inputs for planning
                        for (let i = 0; i < exercise.sets; i++) {
                            const weight = exercise.weights[i] || '';
                            html += `<input type="number" class="form-control form-control-sm d-inline-block mb-1" 
                                     style="width: 80px;" 
                                     placeholder="Set ${i + 1}"
                                     value="${weight}"
                                     data-exercise-id="${exercise.id}"
                                     data-set-number="${i}"
                                     onchange="markWeightChanged(${exercise.id})"> `;
                        }
                    }
                    
                    html += `</td>`;
                    html += `<td>`;
                    html += `<input type="text" class="form-control form-control-sm" 
                             placeholder="Notes" 
                             value="${exercise.notes || ''}"
                             data-exercise-id="${exercise.id}"
                             data-notes="true"
                             onchange="markNotesChanged(${exercise.id})">`;
                    html += `</td>`;
                    html += `<td>`;
                    
                    // Show edit button if exercise has logged data
                    if (day.is_completed && exercise.logged_weights && exercise.logged_weights.some(w => w !== null)) {
                        html += `<button class="btn btn-sm btn-outline-warning me-1" 
                                 onclick="openEditModal(${JSON.stringify(exercise).replace(/"/g, '&quot;')})"
                                 title="Edit logged sets">
                                 <i class="cil-pencil"></i>
                                 </button>`;
                    }
                    
                    html += `<button class="btn btn-sm btn-outline-primary" 
                             onclick="saveExercise(${exercise.id})"
                             id="save-btn-${exercise.id}" style="display: none;">
                             Save
                             </button>`;
                    html += `</td>`;
                    html += `</tr>`;
                });
                
                html += `</tbody></table>`;
                html += `</div>`;
            });
        });
        
        html += `</div></div>`;
    });
    
    container.innerHTML = html;
}

function markWeightChanged(exerciseId) {
    pendingChanges[exerciseId] = true;
    document.getElementById(`save-btn-${exerciseId}`).style.display = 'inline-block';
}

function markNotesChanged(exerciseId) {
    pendingChanges[exerciseId] = true;
    document.getElementById(`save-btn-${exerciseId}`).style.display = 'inline-block';
}

function saveExercise(exerciseId) {
    // Collect all weights for this exercise
    const weightInputs = document.querySelectorAll(`input[data-exercise-id="${exerciseId}"][data-set-number]`);
    const weights = [];
    weightInputs.forEach(input => {
        weights.push(parseFloat(input.value) || 0);
    });
    
    // Get notes
    const notesInput = document.querySelector(`input[data-exercise-id="${exerciseId}"][data-notes="true"]`);
    const notes = notesInput ? notesInput.value : '';
    
    fetch(`/calendar/instance/${instanceId}/update-weights`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            program_exercise_id: exerciseId,
            weights: weights,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            delete pendingChanges[exerciseId];
            document.getElementById(`save-btn-${exerciseId}`).style.display = 'none';
            
            // Show success feedback
            const btn = document.getElementById(`save-btn-${exerciseId}`);
            const originalText = btn.innerHTML;
            btn.innerHTML = '✓ Saved';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-primary');
            }, 2000);
        } else {
            alert('Error saving: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving changes');
    });
}

function saveAllChanges() {
    const exerciseIds = Object.keys(pendingChanges);
    
    if (exerciseIds.length === 0) {
        alert('No changes to save');
        return;
    }
    
    let saved = 0;
    let errors = 0;
    
    exerciseIds.forEach(exerciseId => {
        saveExercise(parseInt(exerciseId));
        saved++;
    });
    
    if (saved > 0) {
        setTimeout(() => {
            if (Object.keys(pendingChanges).length === 0) {
                alert(`Saved ${saved} exercise(s) successfully!`);
            }
        }, 1000);
    }
}

let currentEditingExercise = null;

function openEditModal(exercise) {
    currentEditingExercise = exercise;
    
    // Format the completion date
    let completedDate = 'Unknown';
    if (exercise.session_completed_at) {
        const date = new Date(exercise.session_completed_at);
        completedDate = date.toLocaleString();
    }
    
    let html = `
        <div class="mb-3">
            <h6><strong>Exercise:</strong> ${exercise.exercise_name}</h6>
            <p class="text-muted mb-2"><strong>Completed:</strong> ${completedDate}</p>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Set</th>
                        <th>Weight (lbs)</th>
                        <th>Reps</th>
                        <th>RPE</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    for (let i = 0; i < exercise.sets; i++) {
        const setId = exercise.logged_set_ids[i];
        const weight = exercise.logged_weights[i];
        const reps = exercise.logged_reps[i];
        const rpe = exercise.logged_rpes[i] || '';
        
        if (setId && weight !== null) {
            html += `
                <tr>
                    <td class="align-middle"><strong>Set ${i + 1}</strong></td>
                    <td>
                        <input type="number" class="form-control" 
                               id="edit-weight-${setId}" 
                               value="${weight}" 
                               step="0.5">
                    </td>
                    <td>
                        <input type="number" class="form-control" 
                               id="edit-reps-${setId}" 
                               value="${reps}">
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn ${rpe === '-' ? 'btn-danger' : 'btn-outline-danger'}" 
                                    onclick="setEditRpe(${setId}, '-')" 
                                    id="edit-rpe-${setId}--">-</button>
                            <button type="button" class="btn ${rpe === '=' ? 'btn-success' : 'btn-outline-success'}" 
                                    onclick="setEditRpe(${setId}, '=')" 
                                    id="edit-rpe-${setId}-=">=</button>
                            <button type="button" class="btn ${rpe === '+' ? 'btn-primary' : 'btn-outline-primary'}" 
                                    onclick="setEditRpe(${setId}, '+')" 
                                    id="edit-rpe-${setId}-+">+</button>
                        </div>
                        <input type="hidden" id="edit-rpe-${setId}" value="${rpe}">
                    </td>
                </tr>
            `;
        }
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('editSetsContent').innerHTML = html;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editSetsModal'));
    modal.show();
}

function setEditRpe(setId, rpe) {
    // Update hidden input
    document.getElementById(`edit-rpe-${setId}`).value = rpe;
    
    // Update button states
    ['-', '=', '+'].forEach(val => {
        const btn = document.getElementById(`edit-rpe-${setId}-${val}`);
        if (btn) {
            if (val === rpe) {
                btn.classList.remove('btn-outline-danger', 'btn-outline-success', 'btn-outline-primary');
                if (val === '-') btn.classList.add('btn-danger');
                else if (val === '=') btn.classList.add('btn-success');
                else btn.classList.add('btn-primary');
            } else {
                btn.classList.remove('btn-danger', 'btn-success', 'btn-primary');
                if (val === '-') btn.classList.add('btn-outline-danger');
                else if (val === '=') btn.classList.add('btn-outline-success');
                else btn.classList.add('btn-outline-primary');
            }
        }
    });
}

async function saveAllLoggedSets() {
    if (!currentEditingExercise) return;
    
    const updates = [];
    let hasErrors = false;
    
    // Collect all the updated values
    for (let i = 0; i < currentEditingExercise.sets; i++) {
        const setId = currentEditingExercise.logged_set_ids[i];
        if (!setId) continue;
        
        const weightInput = document.getElementById(`edit-weight-${setId}`);
        const repsInput = document.getElementById(`edit-reps-${setId}`);
        const rpeInput = document.getElementById(`edit-rpe-${setId}`);
        
        if (!weightInput || !repsInput) continue;
        
        const weight = parseFloat(weightInput.value);
        const reps = parseInt(repsInput.value);
        const rpe = rpeInput ? rpeInput.value : null;
        
        if (isNaN(weight) || isNaN(reps) || weight <= 0 || reps <= 0) {
            hasErrors = true;
            weightInput.classList.add('is-invalid');
            repsInput.classList.add('is-invalid');
            continue;
        }
        
        updates.push({
            setId: setId,
            weight: weight,
            reps: reps,
            rpe: rpe
        });
    }
    
    if (hasErrors) {
        alert('Please fix the invalid values (weight and reps must be positive)');
        return;
    }
    
    // Save all updates
    try {
        for (const update of updates) {
            const response = await fetch(`/calendar/workout-set/${update.setId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    weight: update.weight,
                    reps: update.reps,
                    rpe: update.rpe
                })
            });
            
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'Failed to update set');
            }
        }
        
        // Close modal and reload data
        bootstrap.Modal.getInstance(document.getElementById('editSetsModal')).hide();
        loadWorkoutPlan();
        
        // Show success message
        alert('Sets updated successfully!');
        
    } catch (error) {
        console.error('Error updating sets:', error);
        alert('Error updating sets: ' + error.message);
    }
}
</script>
{% endblock %}
